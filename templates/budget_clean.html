<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento - Sistema de Orçamentação</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='modern-clean.css') }}" rel="stylesheet">
    
    <style>
        /* Estilos para os modais de edição */
        .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .edit-modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .questionnaire-modal {
            max-width: 700px !important;
        }

        .edit-modal-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .edit-modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .edit-modal-footer {
            padding: 15px 20px;
            background: #f9fafb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Botões de editar nas seções */
        .edit-section-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: none;
            border-radius: 20px;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            z-index: 10;
            font-size: 14px;
        }

        .edit-section-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: rgba(59, 130, 246, 1);
        }

        /* Posicionamento relativo para seções editáveis */
        .client-info, .pool-summary-card, .ai-assistant-section {
            position: relative;
        }

        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* CSS específico para modal grande de configuração */
        .edit-modal.large {
            max-width: 800px;
            width: 95%;
        }

        .edit-modal-body.large-body {
            padding: 30px;
        }

        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #f1f5f9;
            border-radius: 10px;
            background: #f8fafc;
        }

        .config-section h4 {
            margin: 0 0 20px 0;
            color: #1e293b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* CSS Premium para Modal de Configuração */
        .edit-modal.premium {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid #e2e8f0;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .premium-header {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 25px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .header-text h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }

        .header-text p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            color: #cbd5e1;
            opacity: 0.8;
        }

        .premium-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .premium-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg) scale(1.1);
        }

        .premium-body {
            padding: 35px;
            background: linear-gradient(145deg, #f8fafc, #ffffff);
        }

        .premium-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .premium-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .section-title h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .premium-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .premium-field {
            margin-bottom: 20px;
        }

        .premium-field:last-child {
            margin-bottom: 0;
        }

        .premium-field label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 50px 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .input-unit {
            position: absolute;
            right: 16px;
            color: #6b7280;
            font-weight: 500;
            pointer-events: none;
        }

        .radio-group-premium {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .radio-option-premium {
            flex: 1;
            min-width: 120px;
            padding: 16px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
        }

        .radio-option-premium:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .radio-option-premium.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .radio-option-premium i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .radio-option-premium span {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .premium-footer {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            padding: 25px 35px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .premium-btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .premium-btn:hover {
            transform: translateY(-2px);
        }

        .premium-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .premium-btn.primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .premium-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsividade para o modal premium */
        @media (max-width: 768px) {
            .premium-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group-premium {
                grid-template-columns: 1fr 1fr;
            }
            
            .premium-body {
                padding: 20px;
            }
            
            .premium-section {
                padding: 20px;
            }
        }

        /* === MODAL MODERNO DE ADICIONAR PRODUTO === */
        .add-product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .add-product-modal.show {
            opacity: 1;
        }

        .add-product-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 720px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #e2e8f0;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .add-product-modal.show .add-product-modal-content {
            transform: scale(1) translateY(0);
        }

        .add-product-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
        }

        .add-product-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .add-product-modal-header i {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
        }

        .add-product-modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(85vh - 180px);
        }

        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .family-card-modal {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .family-card-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }

        .family-card-modal:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .family-card-modal:hover::before {
            transform: scaleX(1);
        }

        .family-card-modal .family-icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.75rem;
        }

        .family-card-modal .family-title {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .family-card-modal .family-count {
            font-size: 0.875rem;
            color: #64748b;
        }

        .product-list-modal {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .product-item-modal {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .product-item-modal:hover {
            background: white;
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .product-info-modal {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .product-details-modal {
            flex: 1;
        }

        .product-name-modal {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .product-description-modal {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .product-price-modal {
            color: #059669;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .product-actions-modal {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 120px;
        }

        .product-action-btn {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .product-action-btn.include {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .product-action-btn.include:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .product-action-btn.optional {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .product-action-btn.optional:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .product-action-btn.alternative {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            color: white;
        }

        .product-action-btn.alternative:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }

        .add-product-modal-footer {
            background: #f8fafc;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-back-btn, .modal-close-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-back-btn {
            background: #6b7280;
            color: white;
        }

        .modal-back-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .modal-close-btn {
            background: #dc2626;
            color: white;
        }

        .modal-close-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .add-product-modal-content {
                width: 95%;
                margin: 1rem;
            }

            .family-grid {
                grid-template-columns: 1fr;
            }

            .product-info-modal {
                flex-direction: column;
                gap: 1rem;
            }

            .product-actions-modal {
                flex-direction: row;
                min-width: auto;
            }

            .add-product-modal-footer {
                flex-direction: column-reverse;
                gap: 1rem;
            }

            .modal-back-btn, .modal-close-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* CSS para modal de seleção de produtos alternativos */
        .alternative-modal {
            max-width: 600px;
        }

        .modal-description {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .products-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }

        .product-option {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .product-option:last-child {
            border-bottom: none;
        }

        .product-option:hover {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            transform: translateX(5px);
            border-left: 4px solid #3b82f6;
        }

        .product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .product-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .product-family {
            font-size: 0.85rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            width: fit-content;
        }

        .product-price {
            font-weight: 600;
            color: #059669;
            font-size: 1rem;
            margin-right: 15px;
        }

        .product-option i.fa-chevron-right {
            color: #9ca3af;
            transition: all 0.3s ease;
        }

        .product-option:hover i.fa-chevron-right {
            color: #3b82f6;
            transform: translateX(3px);
        }

        /* Scrollbar customizada para lista de produtos */
        .products-list::-webkit-scrollbar {
            width: 6px;
        }

        .products-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .products-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .products-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-swimming-pool"></i>
                    </div>
                    <span>Sistema de Orçamentação</span>
                </a>
                
                <nav class="nav-steps">
                    <div class="step-indicator completed">
                        <div class="step-number">✓</div>
                        <span>Dados do Cliente</span>
                    </div>
                    <div class="step-indicator completed">
                        <div class="step-number">✓</div>
                        <span>Questionário</span>
                    </div>
                    <div class="step-indicator active">
                        <div class="step-number">3</div>
                        <span>Orçamento</span>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Cabeçalho do Orçamento -->
            <div class="card fade-in">
                <div class="budget-summary">
                    <div class="client-info">
                        <button class="edit-section-btn" onclick="editClientInfo()" title="Editar dados do cliente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <h1 class="client-name">
                            <i class="fas fa-user"></i>
                            {{ budget.get('client_data', {}).get('clientName', 'Cliente') }}
                        </h1>
                        <div class="proposal-details">
                            <span class="proposal-number">
                                <i class="fas fa-hashtag"></i>
                                {{ budget.get('client_data', {}).get('proposalNumber', 'Proposta') }}
                            </span>
                            <span class="date">
                                <i class="fas fa-calendar"></i>
                                {{ budget.get('client_data', {}).get('date', '') }}
                            </span>
                            {% if budget.get('client_data', {}).get('commercialName') %}
                            <span class="commercial-name">
                                <i class="fas fa-user-tie"></i>
                                {{ budget.get('client_data', {}).get('commercialName') }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="total-display">
                        <div class="total-label">Total do Orçamento</div>
                        <div class="total-amount">€{{ "%.2f"|format(budget.get('total_price', 0)) }}</div>
                    </div>
                </div>
            </div>

            <!-- Separador para Especificações -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-swimming-pool"></i>
                        <span>Especificações da Piscina</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- Especificações da Piscina -->
            <div class="card slide-up">
                <div class="grid grid-4">
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-ruler-combined"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Dimensões</div>
                            <div class="spec-value">
                                {{ budget.pool_info.get('dimensions', {}).get('comprimento', budget.pool_info.get('comprimento', '0')) }}m × 
                                {{ budget.pool_info.get('dimensions', {}).get('largura', budget.pool_info.get('largura', '0')) }}m
                            </div>
                        </div>
                    </div>
                    
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-arrows-alt-v"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Profundidade</div>
                            <div class="spec-value">
                                {{ budget.pool_info.get('dimensions', {}).get('prof_min', budget.pool_info.get('prof_min', '0')) }}m - 
                                {{ budget.pool_info.get('dimensions', {}).get('prof_max', budget.pool_info.get('prof_max', '0')) }}m
                            </div>
                        </div>
                    </div>
                    
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-tint"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Volume</div>
                            <div class="spec-value">{{ budget.pool_info.get('metrics', {}).get('volume', budget.pool_info.get('volume', '0')) }} m³</div>
                        </div>
                    </div>
                    
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-filter"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Filtração</div>
                            <div class="spec-value">{{ budget.pool_info.get('metrics', {}).get('m3_h', budget.pool_info.get('m3_h', '0')) }} m³/h</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Separador para Dashboard Técnico -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard Técnico</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- DASHBOARD PREMIUM - MÉTRICAS E RESUMO EXECUTIVO -->
            <div class="card slide-up ai-assistant-section" style="animation-delay: 0.2s;">
                <button class="edit-section-btn" onclick="editProjectConfiguration()" title="Editar configuração do projeto">
                    <i class="fas fa-cogs"></i>
                </button>
                <!-- Header Corporativo -->
                <div class="metrics-header-premium">
                    <div class="header-title">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Dashboard
                            <span class="subtitle-modern">Análise Técnica</span>
                            <div class="ai-badge">
                                <i class="fas fa-microchip"></i>
                                <span>Smart</span>
                            </div>
                        </h3>
                    </div>
                    <div class="key-metrics-bar">
                        <div class="key-metric">
                            <i class="fas fa-cube"></i>
                            <span class="value">{{ budget.pool_info.get('metrics', {}).get('volume', budget.pool_info.get('volume', '0')) }}m³</span>
                            <span class="label">Volume</span>
                        </div>
                        <div class="key-metric">
                            <i class="fas fa-water"></i>
                            <span class="value">{{ budget.pool_info.get('metrics', {}).get('m3_h', budget.pool_info.get('m3_h', '0')) }}m³/h</span>
                            <span class="label">Filtração</span>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Corporativo - Layout Lado a Lado -->
                <div class="dashboard-compact-ai">
                    <div class="ai-grid-compact">
                        <!-- Seção 1: Especificações Técnicas -->
                        <div class="ai-section">
                            <div class="section-header-ai">
                                <div class="ai-badge-wrapper">
                                    <i class="fas fa-brain ai-brain-icon"></i>
                                    <span class="ai-badge">Smart</span>
                                </div>
                                <span>Especificações Técnicas</span>
                            </div>
                                <div class="ai-items">
                                    <div class="ai-item">
                                        <span class="label">Dimensões</span>
                                        <span class="value value-dimensions">{{ budget.pool_info.get('dimensions', {}).get('comprimento', budget.pool_info.get('comprimento', '0')) }}×{{ budget.pool_info.get('dimensions', {}).get('largura', budget.pool_info.get('largura', '0')) }}m</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Profundidade</span>
                                        <span class="value value-depth">{{ budget.pool_info.get('dimensions', {}).get('prof_min', budget.pool_info.get('prof_min', '0')) }}-{{ budget.pool_info.get('dimensions', {}).get('prof_max', budget.pool_info.get('prof_max', '0')) }}m</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Volume Total</span>
                                        <span class="value value-volume">{{ budget.pool_info.get('metrics', {}).get('volume', budget.pool_info.get('volume', '0')) }}m³</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Taxa de Filtração</span>
                                        <span class="value value-flow">{{ budget.pool_info.get('metrics', {}).get('m3_h', budget.pool_info.get('m3_h', '0')) }}m³/h</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">m³ Massa</span>
                                        <span class="value value-concrete">{{ budget.pool_info.get('metrics', {}).get('m3_massa', budget.pool_info.get('m3_massa', 'N/A')) | default('N/A') }}m³</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">m² Fundo</span>
                                        <span class="value value-area">{{ budget.pool_info.get('metrics', {}).get('m2_fundo', budget.pool_info.get('m2_fundo', 'N/A')) | default('N/A') }}m²</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">m² Paredes</span>
                                        <span class="value value-area">{{ budget.pool_info.get('metrics', {}).get('m2_paredes', budget.pool_info.get('m2_paredes', 'N/A')) | default('N/A') }}m²</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Rolos Tela</span>
                                        <span class="value value-count">{{ budget.pool_info.get('metrics', {}).get('rolos_tl', budget.pool_info.get('rolos_tl', '0')) }} <span class="unit">un</span></span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Rolos 3D</span>
                                        <span class="value value-count">{{ budget.pool_info.get('metrics', {}).get('rolos_3d', budget.pool_info.get('rolos_3d', '0')) }} <span class="unit">un</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Seção 2: Configuração do Projeto -->
                            <div class="ai-section">
                                <div class="section-header-ai">
                                    <i class="fas fa-cog"></i>
                                    <span>Configuração do Projeto</span>
                                </div>
                                <div class="ai-items">
                                    <div class="ai-item">
                                        <span class="label">Tipo de Piscina</span>
                                        <span class="value smart-badge value-pool-type">
                                            {% if budget.pool_info.get('answers', {}).get('tipo_piscina', budget.pool_info.get('tipo_piscina', '')) == 'skimmer' %}Skimmer
                                            {% elif budget.pool_info.get('answers', {}).get('tipo_piscina', budget.pool_info.get('tipo_piscina', '')) == 'espelho_dagua' %}Espelho d'Água
                                            {% elif budget.pool_info.get('answers', {}).get('tipo_piscina', budget.pool_info.get('tipo_piscina', '')) == 'transbordo' %}Transbordo
                                            {% else %}Standard{% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Forma</span>
                                        <span class="value value-shape">{{ budget.pool_info.get('answers', {}).get('forma', budget.pool_info.get('forma', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Revestimento</span>
                                        <span class="value value-coating">{{ budget.pool_info.get('answers', {}).get('revestimento', budget.pool_info.get('revestimento', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Acesso ao Local</span>
                                        <span class="value value-access">{{ budget.pool_info.get('answers', {}).get('acesso', budget.pool_info.get('acesso', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Escavação</span>
                                        <span class="value value-excavation {{ 'ai-active' if budget.pool_info.get('answers', {}).get('escavacao', budget.pool_info.get('escavacao', 'false')) == 'true' else 'ai-inactive' }}">
                                            {{ 'Incluída' if budget.pool_info.get('answers', {}).get('escavacao', budget.pool_info.get('escavacao', 'false')) == 'true' else 'Não' }}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Localização</span>
                                        <span class="value value-location">{{ budget.pool_info.get('answers', {}).get('localizacao', budget.pool_info.get('localizacao', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Sistema Domótico</span>
                                        <span class="value value-domotics {{ 'ai-active' if budget.pool_info.get('answers', {}).get('domotica', budget.pool_info.get('domotica', 'false')) == 'true' else 'ai-inactive' }}">
                                            {{ 'Sim' if budget.pool_info.get('answers', {}).get('domotica', budget.pool_info.get('domotica', 'false')) == 'true' else 'Não' }}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Alimentação Elétrica</span>
                                        <span class="value value-power power-type">
                                            {% if budget.pool_info.get('answers', {}).get('luz', budget.pool_info.get('luz', 'monofasica')) == 'trifasica' %}Trifásica{% else %}Monofásica{% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Tratamento da Água</span>
                                        <span class="value value-treatment">
                                            {% set tratamento = budget.pool_info.get('answers', {}).get('tratamento_agua', budget.pool_info.get('tratamento_agua', 'cloro_manual')) %}
                                            {% if tratamento == 'cloro_manual' %}Cloro Manual
                                            {% elif tratamento == 'cloro_automatico' %}Cloro Automático
                                            {% elif tratamento == 'clorador_salino' %}Clorador Salino
                                            {% elif tratamento == 'clorador_salino_ph' %}Clorador Salino + pH
                                            {% elif tratamento == 'clorador_salino_ph_uv' %}Clorador Salino + pH + UV
                                            {% elif tratamento == 'nao' %}Não Incluído
                                            {% else %}Cloro Manual{% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Tipo de Construção</span>
                                        <span class="value value-construction">
                                            {% set tipo_construcao = budget.pool_info.get('answers', {}).get('tipo_construcao', budget.pool_info.get('tipo_construcao', 'nova')) %}
                                            {{ 'Nova' if tipo_construcao == 'nova' else 'Remodelação' }}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Cobertura</span>
                                        <span class="value value-coverage">
                                            {% set cobertura = budget.pool_info.get('answers', {}).get('cobertura', budget.pool_info.get('cobertura', 'nao')) %}
                                            {% if cobertura == 'laminas' %}Cobertura de Lâminas
                                            {% elif cobertura == 'bolhas' %}Cobertura de Bolhas
                                            {% elif cobertura == 'barras' %}Cobertura de Barras
                                            {% elif cobertura == 'lona' %}Cobertura de Lona
                                            {% elif cobertura == 'nao' %}Sem Cobertura
                                            {% else %}Sem Cobertura{% endif %}
                                            {% if cobertura == 'laminas' %}
                                                {% set tipo_laminas = budget.pool_info.get('answers', {}).get('tipo_cobertura_laminas', '') %}
                                                {% if tipo_laminas == 'submersa_praia' %} (Submersa na Praia)
                                                {% elif tipo_laminas == 'fora_praia' %} (Fora da Praia)
                                                {% elif tipo_laminas == 'elevada' %} (Elevada)
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Corporativo -->
                        <div class="ai-footer">
                            <div class="ai-signature">
                                <i class="fas fa-certificate"></i>
                                <span>• Cálculos certificados •</span>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Separador para Análise de Complexidade -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-analytics"></i>
                        <span>Análise de Complexidade</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- Análise de Complexidade - DESIGN PREMIUM MODERNO -->
            <div class="complexity-card-premium slide-up" style="animation-delay: 0.3s;">
                <!-- Dashboard Principal -->
                <div class="complexity-dashboard">
                    <!-- Indicador Principal -->
                    <div class="complexity-main-indicator">
                        <div class="multiplier-gauge">
                            <div class="gauge-background">
                                <div class="gauge-fill" style="width: {{ ((budget.pool_info.get('multiplier', 1) - 1) * 100) if budget.pool_info.get('multiplier', 1) > 1 else 0 }}%"></div>
                            </div>
                            <div class="multiplier-info">
                                <span class="multiplier-number">{{ "%.3f"|format(budget.pool_info.get('multiplier', 1)) }}×</span>
                                <span class="multiplier-text">Multiplicador Final</span>
                            </div>
                        </div>
                        
                        <div class="complexity-status">
                            {% if budget.pool_info.get('multiplier', 1) <= 1.15 %}
                                <div class="status-indicator status-low">
                                    <i class="fas fa-check-circle"></i>
                                    <span class="status-title">Complexidade Reduzida</span>
                                </div>
                                <p class="status-description">Projecto com condições ideais de execução. Terreno acessível e instalações convencionais.</p>
                            {% elif budget.pool_info.get('multiplier', 1) <= 1.35 %}
                                <div class="status-indicator status-medium">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span class="status-title">Complexidade Intermédia</span>
                                </div>
                                <p class="status-description">Projecto que requer análise técnica específica devido a factores particulares.</p>
                            {% else %}
                                <div class="status-indicator status-high">
                                    <i class="fas fa-cog"></i>
                                    <span class="status-title">Complexidade Elevada</span>
                                </div>
                                <p class="status-description">Projecto de alta complexidade técnica que requer engenharia especializada.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Fatores de Complexidade -->
                    <div class="factors-analysis-modern">
                        <h3 class="factors-title">
                            <i class="fas fa-chart-pie"></i>
                            Breakdown dos Fatores
                        </h3>
                        <div class="factors-grid-modern">
                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper geometric">
                                    <i class="fas fa-shapes"></i>
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Geométrico</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('geometrico', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill geometric" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('geometrico', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('geometrico', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Forma e dimensões da piscina</span>
                                </div>
                            </div>

                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper access">
                                    <i class="fas fa-truck-loading"></i>
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Acesso</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('acesso', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill access" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('acesso', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('acesso', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Acessibilidade do local</span>
                                </div>
                            </div>

                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper tech">
                                    <i class="fas fa-microchip"></i>
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Tecnológico</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('tecnologico', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill tech" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('tecnologico', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('tecnologico', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Automação e acabamentos</span>
                                </div>
                            </div>

                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper market">
                                    📈
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Mercado 2025</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('mercado', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill market" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('mercado', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('mercado', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Condições do mercado</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Separador Elegante para Início do Orçamento -->
            <div class="budget-divider">
                <div class="budget-divider-content">
                    <div class="budget-divider-line"></div>
                    <div class="budget-divider-text">
                        <i class="fas fa-list-alt"></i>
                        <span>Detalhamento do Orçamento</span>
                    </div>
                    <div class="budget-divider-line"></div>
                </div>
                <div class="budget-divider-subtitle">
                    Produtos e serviços incluídos na sua proposta
                </div>
            </div>

            <!-- Produtos por Família - DESIGN COMPACTO -->
            {% for family_name, family_products in budget.get('families', {}).items() %}
            {# Check if this family has any displayable products #}
            {% set displayable_products = [] %}
            {% for product_id, product in family_products.items() %}
                {% if product.quantity > 0 or product.item_type == 'alternativo' or product.item_type == 'opcional' %}
                    {% set _ = displayable_products.append(product) %}
                {% endif %}
            {% endfor %}
            
            {% if displayable_products|length > 0 %}
            <div class="family-card-compact slide-up" style="animation-delay: 0.{{ loop.index + 2 }}s;">
                <!-- Cabeçalho Compacto -->
                <div class="family-header-compact" onclick="toggleFamily('{{ family_name }}')">
                    <div class="family-title-compact">
                        <i class="fas 
                            {% if family_name == 'piscinas' %}fa-swimming-pool
                            {% elif family_name == 'filtracao' %}fa-filter
                            {% elif family_name == 'aquecimento' %}fa-thermometer-half
                            {% elif family_name == 'dosagem' %}fa-flask
                            {% elif family_name == 'iluminacao' %}fa-lightbulb
                            {% elif family_name == 'automacao' %}fa-robot
                            {% elif family_name == 'acessorios' %}fa-wrench
                            {% elif family_name == 'recirculacao_iluminacao' %}fa-water
                            {% else %}fa-cog{% endif %}"></i>
                        {{ family_name|family_display_name }}
                    </div>
                    <div class="family-summary-compact">
                        <span class="item-count-compact">{{ family_products|length }}</span>
                        <span class="total-compact">{{ "%.2f"|format(budget.family_totals_base.get(family_name, 0)) }}€</span>
                        <i class="fas fa-chevron-down chevron-compact" id="chevron-{{ family_name }}"></i>
                    </div>
                </div>
                
                <!-- Lista Compacta de Produtos -->
                <div class="products-list-compact" id="products-{{ family_name }}">
                    {% set included_products = [] %}
                    {% set alternative_products = [] %}
                    {% set optional_products = [] %}
                    {% for product_id, product in family_products.items() %}
                        {% if product.quantity > 0 or product.item_type == 'alternativo' or product.item_type == 'opcional' %}
                            {% if product.item_type == 'incluido' %}
                                {% set _ = included_products.append((product_id, product)) %}
                            {% elif product.item_type == 'alternativo' %}
                                {% set _ = alternative_products.append((product_id, product)) %}
                            {% else %}
                                {% set _ = optional_products.append((product_id, product)) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    {# Criar lista organizada com alternativos agrupados após seus principais #}
                    {% set organized_products = [] %}
                    
                    {# Primeiro, adicionar produtos incluídos com seus alternativos #}
                    {% for product_id, product in included_products %}
                        {% set _ = organized_products.append((product_id, product)) %}
                        {# Adicionar alternativos deste produto logo em seguida #}
                        {% for alt_id, alt_product in alternative_products %}
                            {% if alt_product.get('alternative_to') == product_id %}
                                {% set _ = organized_products.append((alt_id, alt_product)) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    
                    {# Adicionar alternativos órfãos (sem produto principal definido) #}
                    {% for alt_id, alt_product in alternative_products %}
                        {% if not alt_product.get('alternative_to') or alt_product.get('alternative_to') not in family_products %}
                            {% set _ = organized_products.append((alt_id, alt_product)) %}
                        {% endif %}
                    {% endfor %}
                    
                    {# Finalmente, adicionar produtos opcionais #}
                    {% for product_id, product in optional_products %}
                        {% set _ = organized_products.append((product_id, product)) %}
                    {% endfor %}
                    
                    {% for product_id, product in organized_products %}
                    <div class="product-row-compact-detailed {{ 'alternative-product alternative-indented' if product.item_type == 'alternativo' else 'optional-product' if product.item_type == 'opcional' else '' }} {{ 'pack-item' if product.get('is_pack_item', False) else '' }}">
                        <div class="product-info-left">
                            <span class="status-dot-compact {{ 'required' if product.item_type == 'incluido' else 'alternative' if product.item_type == 'alternativo' else 'optional' }}"></span>
                            <div class="product-name-section">
                                <div class="product-name-with-actions">
                                    <span class="product-name-compact">
                                        {% if product.item_type == 'alternativo' %}
                                        ↳ {{ product.name.replace('Alternativa: ', '').replace(' (ALTERNATIVO)', '') }}
                                        {% else %}
                                        {{ product.name }}
                                        {% endif %}
                                        <!-- Botão para alternativas inline com o texto -->
                                        {% if product.get('can_change_type', False) and product.item_type != 'alternativo' %}
                                        <button class="btn-alternative-inline" onclick="showAlternatives('{{ family_name }}', '{{ product_id }}')" 
                                                title="Ver alternativas disponíveis">🔄</button>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="product-specs">
                                    <span class="spec-price">{{ "%.2f"|format(product.price) }}€/{{ product.get('unit', 'un') }}</span>
                                    <span class="spec-qty">Qtd: {{ product.quantity }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="product-controls-right">
                            {% if product.item_type == 'incluido' %}
                                <span class="price-total-compact">{{ "%.2f"|format(product.price * product.quantity) }}€</span>
                                <div class="qty-controls-compact">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', -1)">−</button>
                                    <input type="number" class="qty-input-compact" 
                                           id="qty_{{ product_id }}" 
                                           value="{{ product.quantity }}" 
                                           onchange="updateProductQuantity('{{ product_id }}', this.value)" min="1">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% elif product.item_type == 'alternativo' %}
                                <div style="text-align: right;">
                                    <span class="price-total-inactive">{{ "%.2f"|format(product.price * product.quantity if product.quantity > 0 else product.price) }}€</span>
                                    <div class="alternative-label">alternativa</div>
                                </div>
                                
                                <!-- Controles sempre visíveis para produtos alternativos -->
                                <div class="qty-controls-small">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', -1)">−</button>
                                    <input type="number" class="qty-input-small" 
                                           id="qty_{{ product_id }}" 
                                           value="{{ product.quantity }}" 
                                           onchange="updateProductQuantity('{{ product_id }}', this.value)" min="0">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                
                                <button class="btn-replace-alternative" 
                                        id="toggle_{{ product_id }}" 
                                        onclick="replaceProduct('{{ family_name }}', '{{ product_id }}')">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% elif product.item_type == 'opcional' %}
                                <div style="text-align: right;">
                                    <span class="price-total-inactive">{{ "%.2f"|format(product.price * product.quantity if product.quantity > 0 else product.price) }}€</span>
                                    <div class="optional-label">não incluso</div>
                                </div>
                                
                                <!-- Controles sempre visíveis para produtos opcionais -->
                                <div class="qty-controls-small">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', -1)">−</button>
                                    <input type="number" class="qty-input-small" 
                                           id="qty_{{ product_id }}" 
                                           value="{{ product.quantity }}" 
                                           onchange="updateProductQuantity('{{ product_id }}', this.value)" min="0">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                
                                <button class="btn-toggle-optional" 
                                        id="toggle_{{ product_id }}" 
                                        onclick="includeOptionalProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% elif product.get('was_optional') %}
                                <span class="price-total-compact">{{ "%.2f"|format(product.price * product.quantity) }}€</span>
                                <div class="qty-controls-compact">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', -1)">-</button>
                                    <input type="number" class="qty-input-compact" 
                                           id="qty_{{ product_id }}" 
                                           value="{{ product.quantity }}" 
                                           onchange="updateProductQuantity('{{ product_id }}', this.value)" min="1">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                <button class="btn-toggle-optional active" 
                                        id="toggle_{{ product_id }}" 
                                        onclick="toggleOptional('{{ product_id }}')">
                                    Remover
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}

            <!-- Resumo Financeiro - Design Compacto -->
            <div class="card slide-up financial-summary-compact">
                <div class="financial-header-compact">
                    <i class="fas fa-calculator financial-icon-compact"></i>
                    <h3 class="financial-title-compact">Resumo Financeiro</h3>
                </div>
                
                <div class="financial-content-compact">
                    <div class="financial-row">
                        <span class="financial-label">
                            <i class="fas fa-boxes"></i>
                            Equipamentos
                        </span>
                        <span class="financial-value">{{ "%.2f"|format(budget.subtotal_base|default(0)) }}€</span>
                    </div>
                    
                    <div class="financial-row multiplier-row">
                        <span class="financial-label">
                            <i class="fas fa-percentage"></i>
                            Margem <span class="multiplier-tag">{{ "%.1f"|format(budget.pool_info.multiplier|default(1.0)) }}x</span>
                        </span>
                        <span class="financial-value multiplier-amount">
                            +{{ "%.2f"|format((budget.total_price|default(0)) - (budget.subtotal_base|default(0))) }}€
                        </span>
                    </div>
                    
                    <div class="financial-separator"></div>
                    
                    <div class="financial-row total-row">
                        <span class="financial-label-total">
                            <i class="fas fa-euro-sign"></i>
                            Total do Orçamento
                        </span>
                        <span class="financial-value-total">{{ "%.2f"|format(budget.total_price|default(0)) }}€</span>
                    </div>
                </div>
            </div>

            <!-- Separador para Adicionar Produtos -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-plus-circle"></i>
                        <span>Personalizar Orçamento</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- Ações Rápidas - Posição Estratégica -->
            <div class="quick-actions-container slide-up">
                <div class="quick-action-card">
                    <div class="quick-action-content">
                        <div class="quick-action-info">
                            <i class="fas fa-plus-circle quick-action-icon"></i>
                            <div class="quick-action-text">
                                <h4 class="quick-action-title">Personalizar Orçamento</h4>
                                <p class="quick-action-subtitle">Adicione produtos adicionais das nossas famílias</p>
                            </div>
                        </div>
                        <button onclick="showAddProductModal()" class="quick-action-button">
                            <i class="fas fa-plus"></i>
                            Adicionar Produtos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Observações -->
            {% if budget.client_data and budget.client_data.observations %}
            <div class="card slide-up">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-sticky-note"></i>
                        Observações
                    </h3>
                </div>
                <div class="observations-content">
                    {{ budget.client_data.observations }}
                </div>
            </div>
            {% endif %}

            <!-- Ações -->
            <div class="card slide-up">
                <div class="actions-grid">
                    <button onclick="exportBudgetToPDF()" class="btn btn-primary btn-lg hover-lift">
                        <i class="fas fa-file-pdf"></i>
                        Exportar PDF
                    </button>
                    
                    <a href="/client_data" class="btn btn-primary btn-lg hover-lift">
                        <i class="fas fa-plus"></i>
                        Novo Orçamento
                    </a>
                </div>
            </div>

        </main>
    </div>

    <!-- CSS Específico para Orçamento -->
    <style>
        /* === CAIXAS PRINCIPAIS (SEPARADAS) === */
        .ai-metrics-card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(52, 152, 219, 0.08);
            margin-bottom: 24px;
            border: 1px solid rgba(52, 152, 219, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ai-metrics-card:hover {
            box-shadow: 0 12px 40px rgba(52, 152, 219, 0.12);
            transform: translateY(-2px);
        }

        .ai-metrics-panel {
            padding: 0;
        }

        /* Budget Header */
        .budget-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .client-name {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .proposal-details {
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
        }
        
        .total-display {
            text-align: right;
        }
        
        .total-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .total-amount {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        
        /* Pool Specifications */
        .spec-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--surface-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
        }
        
        .spec-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .spec-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--text-white);
        }
        
        .spec-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .spec-value {
            font-family: var(--font-mono);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Family Sections */
        .family-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .family-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0;
        }
        
        .family-total {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Products List */
        .products-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            background: var(--surface-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
        }
        
        .product-item.included {
            border-left: 4px solid var(--success);
        }
        
        .product-item.optional {
            border-left: 4px solid var(--warning);
        }
        
        .product-item.offer {
            border-left: 4px solid var(--accent);
        }
        
        .product-item.pack-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(99, 102, 241, 0.05));
            border-left: 4px solid #3B82F6;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            margin-left: 32px;
            margin-top: 4px;
            margin-bottom: 4px;
            position: relative;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
            transition: all 0.2s ease;
        }
        
        .product-item.pack-item::before {
            content: '▶';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: #3B82F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .product-item.pack-item::after {
            content: '';
            position: absolute;
            left: -15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, transparent, #3B82F6, transparent);
        }
        
        .product-item.pack-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.08));
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .product-item.pack-item .product-name {
            font-size: 0.9em;
            color: #1E40AF;
            font-style: italic;
        }
        
        .product-item.pack-item .product-specs {
            opacity: 0.85;
        }
        
        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .product-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .product-details {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .product-reasoning {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .product-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .product-total {
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Observations */
        .observations-content {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        /* Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .budget-summary {
                flex-direction: column;
                text-align: center;
            }
            
            .total-display {
                text-align: center;
            }
            
            .product-item {
                flex-direction: column;
                gap: 1rem;
            }
            
            .product-right {
                text-align: left;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Print Styles */
        @media print {
            .header,
            .actions-grid {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card {
                background: white !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }
        }
        
        /* DESIGN COMPACTO PARA FAMÍLIAS DE PRODUTOS */
        .family-card-compact {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .family-header-compact {
            padding: 16px 20px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 4px 12px rgba(14, 165, 233, 0.15);
        }
        
        .family-header-compact:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #1e40af 100%);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.25),
                0 6px 20px rgba(14, 165, 233, 0.25);
            transform: translateY(-1px);
        }
        
        .family-title-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .family-title-compact i {
            font-size: 14px;
        }
        
        .family-summary-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }
        
        .item-count-compact {
            background: rgba(255, 255, 255, 0.25);
            color: #ffffff;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .total-compact {
            font-weight: 700;
            color: #ffffff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .chevron-compact {
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        
        .chevron-compact.rotated {
            transform: rotate(180deg);
        }
        
        .products-list-compact {
            background: #fafafa;
            border-top: 1px solid var(--border-color);
        }
        /* === LAYOUT COMPACTO E DETALHADO DOS PRODUTOS === */
        .product-row-compact-detailed {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 13px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 3px solid transparent;
            margin-bottom: 4px;
            border-radius: 8px;
            min-height: 50px;
            flex-wrap: nowrap;
        }
        
        .product-row-compact-detailed:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-left-color: var(--primary-color);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .product-info-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0;
            max-width: calc(100% - 300px);
        }
        
        .product-name-section {
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0;
            max-width: 100%;
            overflow: visible;
        }
        
        .product-name-with-actions {
            display: block;
            margin-bottom: 4px;
            width: 100%;
            max-width: 100%;
            overflow: visible;
        }
        
        .product-name-compact {
            font-weight: 600;
            color: var(--text-primary);
            display: inline-block;
            font-size: 14px;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .btn-alternative-inline {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin-left: 6px;
        }
        
        .btn-alternative-inline:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4);
        }
        
        .btn-alternative-inline:active {
            transform: translateY(0);
        }
        
        /* Indentação para itens alternativos */
        .alternative-indented {
            margin-left: 24px;
            border-left: 3px solid #8b5cf6 !important;
            position: relative;
        }
        
        .alternative-indented::before {
            content: "└";
            position: absolute;
            left: -15px;
            top: 12px;
            color: #8b5cf6;
            font-size: 14px;
            font-weight: bold;
        }
        
        .product-specs {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .spec-price {
            color: #3b82f6;
            font-size: 11px;
            font-weight: 500;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .spec-qty {
            color: #059669;
            font-size: 11px;
            font-weight: 500;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .product-controls-right {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex-shrink: 0;
            min-width: 280px;
            margin-left: 20px;
            padding-top: 2px;
        }
        
        .price-total-compact {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: #16a34a;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #bbf7d0;
            text-align: center;
            min-width: 80px;
            opacity: 0.85;
        }
        
        .price-total-inactive {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 13px;
            color: #6b7280;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
            min-width: 80px;
            opacity: 0.7;
            font-style: italic;
        }
        
        /* Estilo especial para produtos alternativos - versão compacta e discreta */
        .product-row-compact-detailed.alternative-product {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 50%, #fafafa 100%); /* Cores bem mais sutis */
            border-left: 2px solid #a855f7; /* Borda mais fina e cor mais suave */
            box-shadow: 0 1px 4px rgba(168, 85, 247, 0.05); /* Sombra muito sutil */
            font-size: 13px; /* Tamanho menor */
            min-height: 45px; /* Altura menor */
            padding: 8px 12px; /* Padding menor */
        }
        
        .product-row-compact-detailed.alternative-product.alternative-indented {
            margin-left: 28px; /* Margem menor */
            border-left: 2px solid #a855f7; /* Borda mais fina */
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .product-row-compact-detailed.alternative-product.alternative-indented::before {
            content: "┗━";
            position: absolute;
            left: -16px; /* Posição ajustada */
            top: 50%;
            transform: translateY(-50%);
            color: #a855f7; /* Cor mais suave */
            font-size: 12px; /* Tamanho menor */
            font-weight: normal; /* Menos bold */
            opacity: 0.7; /* Mais transparente */
        }
        
        .product-row-compact-detailed.alternative-product:hover {
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 50%, #f0f0f0 100%); /* Hover mais sutil */
            box-shadow: 0 2px 6px rgba(168, 85, 247, 0.08); /* Sombra muito suave */
        }
        
        .product-row-compact-detailed.alternative-product .product-name-compact {
            color: #9333ea; /* Roxo mais suave */
            font-size: 12px; /* Texto menor */
            font-weight: 500; /* Menos bold */
        }
        
        .product-row-compact-detailed.alternative-product .spec-price {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            border: 1px solid rgba(168, 85, 247, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        .product-row-compact-detailed.alternative-product .spec-qty {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            border: 1px solid rgba(168, 85, 247, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        /* Responsividade para layout compacto */
        @media (max-width: 768px) {
            .product-row-compact-detailed {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                padding: 16px;
            }
            
            .product-info-left {
                margin-bottom: 8px;
                max-width: 100%;
                width: 100%;
            }
            
            .product-controls-right {
                justify-content: space-between;
                margin-left: 0;
                min-width: auto;
                align-items: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .product-specs {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Reduzir indentação em mobile */
            .alternative-indented {
                margin-left: 16px;
            }
            
            .product-row-compact-detailed.alternative-product.alternative-indented {
                margin-left: 20px;
            }
            
            .product-row-compact-detailed.alternative-product.alternative-indented::before {
                left: -16px;
                font-size: 14px;
            }
            
            /* Ajustes para produtos opcionais em mobile */
            .product-row-compact-detailed.optional-product::before {
                left: -10px;
                font-size: 10px;
            }
            
            .btn-toggle-optional {
                min-width: 70px;
                padding: 8px 14px;
                font-size: 10px;
            }
        }
        
        
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 13px;
            transition: all 0.3s ease;
            min-height: 65px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 3px solid transparent;
        }
        
        .product-row-compact:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-left-color: var(--primary-color);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .product-row-compact:last-child {
            border-bottom: none;
        }
        
        /* Estilo especial para produtos opcionais - visual de subtítulo */
        .product-row-compact.optional-product {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 50%, #fefce8 100%);
            margin-left: 16px;
            border-left: 4px solid #f59e0b;
            border-radius: 0 12px 12px 0;
            position: relative;
            box-shadow: 
                0 3px 12px rgba(245, 158, 11, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            min-height: 70px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            border-top: 1px solid rgba(245, 158, 11, 0.1);
        }
        
        .product-row-compact.optional-product::before {
            content: "▶";
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #d97706;
            font-weight: bold;
            font-size: 12px;
            background: linear-gradient(135deg, #ffffff, #fef3c7);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #f59e0b;
            box-shadow: 
                0 3px 8px rgba(245, 158, 11, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.optional-product:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            transform: translateX(4px);
            box-shadow: 
                0 5px 20px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.optional-product .product-name-compact {
            color: #92400e;
            font-weight: 600;
        }
        
        .product-row-compact.optional-product .status-dot-compact {
            border: 2px solid #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }

        /* Estilo especial para produtos alternativos - roxo/violeta */
        .product-row-compact.alternative-product {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #f3e8ff 100%);
            margin-left: 16px;
            border-left: 4px solid #8b5cf6;
            border-radius: 0 12px 12px 0;
            position: relative;
            box-shadow: 
                0 3px 12px rgba(139, 92, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            min-height: 70px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .product-row-compact.alternative-product::before {
            content: "⟷";
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7c3aed;
            font-weight: bold;
            font-size: 12px;
            background: linear-gradient(135deg, #ffffff, #c4b5fd);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #8b5cf6;
            box-shadow: 
                0 3px 8px rgba(139, 92, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.alternative-product:hover {
            background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 50%, #c4b5fd 100%);
            transform: translateX(4px);
            box-shadow: 
                0 5px 20px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.alternative-product .product-name-compact {
            color: #7c3aed;
            font-weight: 600;
        }
        
        .product-row-compact.alternative-product .status-dot-compact {
            border: 2px solid #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }
        
        .product-info-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 0;
        }
        
        .status-dot-compact {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .status-dot-compact.required {
            background: #28a745;
        }
        
        .status-dot-compact.optional {
            background: #ffc107;
        }

        .status-dot-compact.alternative {
            background: #14b8a6;
        }
        
        .product-name-compact {
            font-weight: 500;
            color: var(--text-primary);
            overflow: visible;
            text-overflow: clip;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .product-controls-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .price-compact {
            position: relative;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #f0fdf4 100%);
            color: #166534;
            font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            font-weight: 700;
            font-size: 14px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid #22c55e;
            box-shadow: 
                0 4px 12px rgba(34, 197, 94, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-align: center;
            min-width: 90px;
            letter-spacing: 0.3px;
            animation: priceShine 3s ease-in-out infinite alternate;
        }
        
        .price-compact::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(34, 197, 94, 0.1) 50%, rgba(34, 197, 94, 0.05) 100%);
            border-radius: 8px;
            pointer-events: none;
        }
        
        @keyframes priceShine {
            from { 
                box-shadow: 
                    0 4px 12px rgba(34, 197, 94, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
            }
            to { 
                box-shadow: 
                    0 6px 20px rgba(34, 197, 94, 0.25),
                    0 0 30px rgba(34, 197, 94, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
            }
        }
        
        .price-optional {
            position: relative;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fffbeb 100%);
            color: #d97706;
            font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            font-weight: 600;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #f59e0b;
            box-shadow: 
                0 3px 8px rgba(245, 158, 11, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            text-align: center;
            min-width: 80px;
            letter-spacing: 0.2px;
            opacity: 0.9;
        }
        
        .price-optional::before {
            content: 'OPCIONAL';
            position: absolute;
            top: -10px;
            right: -5px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .price-alternative {
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
            color: #6c757d;
            font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            font-weight: 500;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            box-shadow: 
                0 2px 4px rgba(108, 117, 125, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            text-align: center;
            min-width: 80px;
            letter-spacing: 0.2px;
            opacity: 0.7;
        }
        
        .price-alternative::before {
            content: 'ALTERNATIVO';
            position: absolute;
            top: -10px;
            right: -5px;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            font-size: 8px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .qty-controls-compact {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 8px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 6px 8px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 
                inset 0 1px 2px rgba(0, 0, 0, 0.05),
                0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .qty-btn-compact {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 4px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            flex-shrink: 0 !important;
        }

        .qty-btn-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .qty-btn-compact:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .qty-btn-compact:hover::before {
            left: 100%;
        }

        .qty-btn-compact:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 
                0 1px 3px rgba(59, 130, 246, 0.3),
                inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .qty-input-compact {
            width: 40px !important;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px 4px;
            font-size: 14px;
            font-weight: 600;
            height: 28px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            display: inline-block !important;
            flex-shrink: 0 !important;
            vertical-align: middle !important;
        }
        
        .qty-input-compact:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.1),
                inset 0 1px 2px rgba(0, 0, 0, 0.05);
            background: #ffffff;
            transform: scale(1.05);
        }
        
        /* === CONTROLES PEQUENOS PARA OPCIONAIS E ALTERNATIVOS === */
        .qty-controls-small {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 4px;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            padding: 3px 6px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.04);
            transform: scale(0.85);
        }
        
        .qty-btn-small {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(107, 114, 128, 0.2);
        }
        
        .qty-btn-small:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-1px) scale(1.1);
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.3);
        }

        .qty-btn-small:active {
            transform: translateY(0) scale(0.95);
        }
        
        .qty-input-small {
            width: 28px !important;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px;
            font-size: 11px;
            font-weight: 600;
            height: 20px;
            background: #ffffff;
            color: #374151;
            transition: all 0.2s ease;
            display: inline-block !important;
            flex-shrink: 0 !important;
        }
        
        .qty-input-small:focus {
            outline: none;
            border-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.1);
            transform: scale(1.05);
        }
        
        /* === BOTÕES PARA OPCIONAIS E ALTERNATIVOS === */
        .btn-toggle-optional {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-toggle-optional.active {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .btn-toggle-optional:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-toggle-optional.active:hover {
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .btn-replace-alternative {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-replace-alternative:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        /* === REMOVIDO: Estilos antigos de botões de alternativas === */
        
        .toggle-btn-compact {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
            color: #7c3aed;
            border: 2px solid #8b5cf6;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
            box-shadow: 
                0 4px 15px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        
        .toggle-btn-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .toggle-btn-compact:hover::before {
            left: 100%;
        }
        
        .toggle-btn-compact.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #ecfdf5 100%);
            color: #166534;
            border-color: #22c55e;
            box-shadow: 
                0 6px 20px rgba(34, 197, 94, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .toggle-btn-compact:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #f3e8ff 100%);
        }
        
        .toggle-btn-compact.active:hover {
            box-shadow: 
                0 8px 25px rgba(34, 197, 94, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 50%, #dcfce7 100%);
        }
        
        /* Estilo específico para botões de troca de alternativos */
        .btn-replace-alternative {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
            color: #059669;
            border: 2px solid #10b981;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
            box-shadow: 
                0 4px 15px rgba(16, 185, 129, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        
        .btn-replace-alternative::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .btn-replace-alternative:hover::before {
            left: 100%;
        }
        
        .btn-replace-alternative:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #ecfdf5 100%);
        }
        
        /* Label discreta para produtos alternativos */
        .alternative-label {
            font-size: 9px;
            color: #6b7280;
            text-transform: lowercase;
            font-style: italic;
            opacity: 0.7;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* Label discreta para produtos opcionais */
        .optional-label {
            font-size: 9px;
            color: #d97706;
            text-transform: lowercase;
            font-style: italic;
            opacity: 0.8;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(217, 119, 6, 0.2);
        }
        
        /* Estilo premium para botões de produtos opcionais */
        .btn-toggle-optional {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 50%, #ffffff 100%);
            color: #d97706;
            border: 2px solid #f59e0b;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
            box-shadow: 
                0 4px 15px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        
        .btn-toggle-optional::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(217, 119, 6, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .btn-toggle-optional:hover::before {
            left: 100%;
        }
        
        .btn-toggle-optional:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(245, 158, 11, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
        }
        
        .btn-toggle-optional.active {
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #fef3c7 100%);
            color: #92400e;
            border-color: #d97706;
            box-shadow: 
                0 6px 20px rgba(217, 119, 6, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .btn-toggle-optional.active:hover {
            box-shadow: 
                0 8px 25px rgba(217, 119, 6, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fed7aa 100%);
        }
        
        /* Estilização premium para produtos opcionais */
        .product-row-compact-detailed.optional-product {
            border-left: 2px solid #f59e0b; /* Borda mais fina */
            background: linear-gradient(135deg, #fefefe 0%, #fafafa 2%, #ffffff 100%); /* Cores muito mais sutis */
            position: relative;
            transition: all 0.3s ease;
            font-size: 13px; /* Tamanho menor */
            min-height: 45px; /* Altura menor */
            padding: 8px 12px; /* Padding menor */
        }
        
        .product-row-compact-detailed.optional-product::before {
            content: "✨";
            position: absolute;
            left: -10px; /* Posição ajustada */
            top: 10px; /* Posição ajustada */
            color: #f59e0b;
            font-size: 10px; /* Tamanho menor */
            opacity: 0.5; /* Mais transparente */
        }
        
        .product-row-compact-detailed.optional-product:hover {
            border-left-color: #d97706;
            background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 5%, #ffffff 100%); /* Hover muito sutil */
            transform: translateX(1px); /* Movimento menor */
            box-shadow: 
                0 2px 8px rgba(245, 158, 11, 0.08), /* Sombra muito suave */
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .product-row-compact-detailed.optional-product .product-name-compact {
            color: #b45309; /* Cor mais suave */
            font-weight: 500; /* Menos bold */
            font-size: 12px; /* Texto menor */
        }
        
        .product-row-compact-detailed.optional-product .spec-price {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            color: #d97706; /* Cor um pouco mais suave */
            border: 1px solid rgba(245, 158, 11, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        .product-row-compact-detailed.optional-product .spec-qty {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            color: #ea580c; /* Mantém a cor mas mais suave */
            border: 1px solid rgba(251, 146, 60, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        .item-badge.optional {
            background-color: var(--warning-color);
            color: white;
        }
        
        .item-badge.offer {
            background-color: var(--info-color);
            color: white;
        }
        
        .product-reasoning {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        
        .product-unit-price {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .product-controls-section {
            display: flex;
            align-items: center;
            min-width: 200px;
        }
        
        .quantity-control-improved {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .qty-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .qty-btn:hover {
            background: var(--primary-color-dark);
            transform: scale(1.05);
        }
        
        .qty-input {
            width: 60px;
            height: 36px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .qty-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .unit-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .quantity-display {
            background: var(--background-secondary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }
        
        .quantity-text {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .product-actions-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .btn-switch-product {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-switch-product:hover {
            background: var(--warning-color-dark);
            transform: translateY(-1px);
        }

        .btn-remove-product {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 0.5rem;
        }
        
        .btn-remove-product:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .add-product-section {
            text-align: center;
            padding: 2rem;
        }
        
        .add-product-section p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .product-total-amount {
            text-align: right;
        }
        
        .total-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .total-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success-color);
        }
        
        .type-indicator {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: capitalize;
        }
        
        /* Responsivo */
        
        /* DASHBOARD PREMIUM - MÉTRICAS E RESUMO EXECUTIVO */
        .metrics-header-premium {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            border-radius: 12px 12px 0 0;
            padding: 24px 32px;
            color: white;
            margin-bottom: 0;
        }
        
        .header-title h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subtitle-modern {
            font-size: 0.85rem;
            font-weight: 400;
            opacity: 0.9;
            display: block;
            margin-top: 4px;
        }
        
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 12px;
            font-weight: 600;
        }
        
        .ai-badge i {
            font-size: 0.8rem;
        }
        
        .key-metrics-bar {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .key-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 80px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .key-metric i {
            font-size: 1.2rem;
            margin-bottom: 6px;
            opacity: 0.9;
        }
        
        .key-metric .value {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .key-metric .label {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .dashboard-compact-ai {
            padding: 24px;
        }
        
        .unified-panel {
            background: #fafbfc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .ai-assistant-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            border-radius: 8px;
            color: white;
            margin-bottom: 20px;
        }
        
        .assistant-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .assistant-info h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .assistant-info p {
            margin: 2px 0 0 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .ai-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .ai-grid-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .ai-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .section-header-ai {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            padding-bottom: 8px;
            border-bottom: 2px solid #0ea5e9;
        }
        
        .section-header-ai i {
            color: #0ea5e9;
        }
        
        .ai-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ai-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .ai-item:last-child {
            border-bottom: none;
        }
        
        .ai-item .label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .ai-item .value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .smart-badge {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .ai-active {
            color: #10b981;
            font-weight: 700;
        }
        
        .ai-inactive {
            color: #ef4444;
            font-weight: 700;
        }
        
        .power-type {
            color: #8b5cf6;
            font-weight: 700;
        }
        
        .ai-footer {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            text-align: center;
        }
        
        .ai-signature {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .ai-signature i {
            color: #10b981;
        }
        
        /* VALORES ESTILIZADOS MODERNOS */
        /* Especificações Técnicas - Cores por categoria */
        .value-dimensions {
            color: #0ea5e9;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(6, 182, 212, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #0ea5e9;
        }
        
        .value-depth {
            color: #0284c7;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(2, 132, 199, 0.1), rgba(3, 105, 161, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #0284c7;
        }
        
        .value-volume {
            color: #06b6d4;
            font-weight: 800;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(14, 165, 233, 0.15));
            padding: 4px 10px;
            border-radius: 6px;
            border: 2px solid rgba(6, 182, 212, 0.3);
            text-shadow: 0 1px 2px rgba(6, 182, 212, 0.3);
        }
        
        .value-flow {
            color: #0891b2;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.1), rgba(14, 116, 144, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #0891b2;
        }
        
        .value-concrete {
            color: #64748b;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.1), rgba(71, 85, 105, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #64748b;
        }
        
        .value-area {
            color: #22c55e;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(21, 128, 61, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #22c55e;
        }
        
        .value-count {
            color: #f59e0b;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #f59e0b;
        }
        
        .unit {
            font-size: 0.75em;
            opacity: 0.8;
            margin-left: 2px;
        }
        
        /* Configuração do Projeto - Cores por tipo */
        .value-pool-type {
            /* Já tem smart-badge styling */
        }
        
        .value-shape {
            color: #8b5cf6;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #8b5cf6;
        }
        
        .value-coating {
            color: #ec4899;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(219, 39, 119, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #ec4899;
        }
        
        .value-access {
            color: #f97316;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(234, 88, 12, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #f97316;
        }
        
        .value-excavation {
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .value-location {
            color: #84cc16;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(132, 204, 22, 0.1), rgba(101, 163, 13, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #84cc16;
        }
        
        .value-domotics {
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .value-power {
            font-weight: 700;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #8b5cf6;
        }
        
        /* Estados Ativos/Inativos Melhorados */
        .ai-active {
            color: #059669;
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.15), rgba(6, 120, 85, 0.15));
            border-left: 3px solid #059669;
        }
        
        .ai-inactive {
            color: #dc2626;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(185, 28, 28, 0.1));
            border-left: 3px solid #dc2626;
        }
        
        /* Animações sutis nos valores */
        .ai-item .value {
            transition: all 0.2s ease;
        }
        
        .ai-item:hover .value {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .ai-grid-compact {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .ai-assistant-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .ai-status {
                margin-left: 0;
            }
        }
        
        .tech-specs-panel, .project-config-panel {
            background: #fafbfc;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #0ea5e9;
        }
        
        .panel-header i {
            font-size: 1.2rem;
            color: #0ea5e9;
        }
        
        .panel-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .spec-group {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }
        
        .group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
        }
        
        .group-header i {
            color: #22c55e;
            font-size: 1rem;
        }
        
        .spec-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }
        
        .spec-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .spec-value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .spec-value.highlight {
            color: #0ea5e9;
            font-weight: 700;
        }
        
        .config-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .config-section {
            background: white;
            border-radius: 8px;
            padding: 18px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .section-title i {
            color: #f59e0b;
            font-size: 1rem;
        }
        
        .config-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .config-key {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .config-value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-yes {
            color: #22c55e;
            font-weight: 700;
        }
        
        .status-no {
            color: #ef4444;
            font-weight: 700;
        }
        
        .electrical-type {
            color: #8b5cf6;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            .dashboard-dual-panel {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .key-metrics-bar {
                justify-content: center;
            }
            
            .key-metric {
                min-width: 70px;
                padding: 10px 12px;
            }
        }
        
        /* ANÁLISE DE COMPLEXIDADE - DESIGN PREMIUM MODERNO */
        .complexity-card-premium {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            box-shadow: 
                0 6px 25px rgba(14, 165, 233, 0.08),
                0 2px 12px rgba(0, 0, 0, 0.04);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid rgba(14, 165, 233, 0.1);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* === ESTILOS COMPACTOS PARA ANÁLISE DE COMPLEXIDADE === */
        .complexity-header-compact {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .complexity-title-compact {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .complexity-icon-mini {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .complexity-main-title-compact {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .complexity-subtitle-compact {
            font-size: 0.75rem;
            opacity: 0.8;
            margin: 2px 0 0 0;
        }

        .complexity-score-compact {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-circle-mini {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .score-value-mini {
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
        }

        .multiplier-mini {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fef3c7;
        }

        .complexity-factors-compact {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
            background: white;
        }

        .factor-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid;
        }

        .factor-mini.geometric { border-left-color: #10b981; }
        .factor-mini.access { border-left-color: #f59e0b; }
        .factor-mini.tech { border-left-color: #8b5cf6; }
        .factor-mini.market { border-left-color: #ef4444; }

        .factor-icon-mini {
            font-size: 0.9rem;
            width: 16px;
            display: flex;
            justify-content: center;
        }

        .factor-info-mini {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .factor-label {
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 500;
        }

        .factor-value {
            font-size: 0.85rem;
            color: #1e293b;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .complexity-factors-compact {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 12px;
            }
        }
        
        .complexity-header-premium {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            padding: 18px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .complexity-title-section {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .complexity-icon-wrapper {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .complexity-title-content h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .complexity-subtitle {
            margin: 2px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .complexity-score-display {
            text-align: center;
        }
        
        .score-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .score-value {
            font-size: 16px;
            font-weight: 800;
            line-height: 1;
        }
        
        .score-label {
            font-size: 9px;
            font-weight: 500;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        .complexity-dashboard {
            padding: 24px;
        }
        
        .complexity-main-indicator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 28px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 10px;
            border: 1px solid rgba(14, 165, 233, 0.1);
        }
        
        .multiplier-gauge {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .gauge-background {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
            border-radius: 6px;
            transition: width 2s ease-out;
            animation: gaugeGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes gaugeGlow {
            from { box-shadow: 0 0 5px rgba(34, 197, 94, 0.3); }
            to { box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
        }
        
        .multiplier-info {
            text-align: center;
        }
        
        .multiplier-number {
            display: block;
            font-size: 32px;
            font-weight: 800;
            color: #0369a1;
            line-height: 1;
        }
        
        .multiplier-text {
            display: block;
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .complexity-status {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .status-indicator i {
            font-size: 20px;
        }
        
        .status-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .status-low {
            color: #16a34a;
        }
        
        .status-medium {
            color: #ea580c;
        }
        
        .status-high {
            color: #dc2626;
        }
        
        .status-description {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
            margin: 0;
        }
        
        .factors-analysis-modern {
            margin-top: 20px;
        }
        
        .factors-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 18px;
        }
        
        .factors-title i {
            color: #0ea5e9;
        }
        
        .factors-grid-modern {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .factor-card-modern {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .factor-card-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        
        .factor-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }
        
        .factor-icon-wrapper.geometric {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .factor-icon-wrapper.access {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .factor-icon-wrapper.tech {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }
        
        .factor-icon-wrapper.market {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .factor-content {
            flex-grow: 1;
        }
        
        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .factor-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 13px;
        }
        
        .factor-multiplier {
            font-weight: 700;
            color: #0369a1;
            font-size: 12px;
            background: #f0f9ff;
            padding: 1px 6px;
            border-radius: 4px;
        }
        
        .factor-bar {
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        .factor-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1.5s ease-out;
        }
        
        .factor-bar-fill.geometric {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }
        
        .factor-bar-fill.access {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .factor-bar-fill.tech {
            background: linear-gradient(90deg, #06b6d4, #0891b2);
        }
        
        .factor-bar-fill.market {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .factor-impact {
            font-size: 11px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Responsividade da Análise de Complexidade */
        @media (max-width: 768px) {
            .complexity-main-indicator {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .factors-grid-modern {
                grid-template-columns: 1fr;
            }
            
            .complexity-header-premium {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .complexity-dashboard {
                padding: 20px;
            }
        }
        @media (max-width: 768px) {
            .family-header-improved {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .product-main-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .product-controls-section {
                min-width: auto;
                justify-content: center;
            }
            
            .product-actions-total {
                flex-direction: column;
                gap: 0.75rem;
            }
        }

        /* === SEPARADOR ELEGANTE PARA INÍCIO DO ORÇAMENTO === */
        .budget-divider {
            margin: 40px 0 30px 0;
            padding: 0 10px;
        }
        
        .budget-divider-content {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .budget-divider-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #3b82f6 20%, #1d4ed8 50%, #3b82f6 80%, transparent 100%);
            border-radius: 2px;
        }
        
        .budget-divider-text {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 30px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e40af;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: 0.5px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
            border: 2px solid #e0f2fe;
        }
        
        .budget-divider-text i {
            color: #3b82f6;
            font-size: 20px;
        }
        
        .budget-divider-subtitle {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            font-style: italic;
            margin-top: 8px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* === SEPARADORES DE SEÇÃO ELEGANTES COM CORES === */
        .section-divider {
            margin: 35px 0 25px 0;
            padding: 0 10px;
        }
        
        .section-divider-content {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .section-divider-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #10b981 20%, #059669 50%, #10b981 80%, transparent 100%);
            border-radius: 2px;
        }
        
        .section-divider-text {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            color: #065f46;
            font-weight: 600;
            font-size: 16px;
            letter-spacing: 0.3px;
            border-radius: 20px;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.15);
            border: 2px solid #d1fae5;
        }
        
        .section-divider-text i {
            color: #10b981;
            font-size: 18px;
        }

        /* Variações de cores para diferentes seções */
        .section-divider:nth-of-type(1) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #f59e0b 20%, #d97706 50%, #f59e0b 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(1) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
            color: #92400e;
            border-color: #fed7aa;
            box-shadow: 0 3px 12px rgba(245, 158, 11, 0.15);
        }
        
        .section-divider:nth-of-type(1) .section-divider-text i {
            color: #f59e0b;
        }

        .section-divider:nth-of-type(2) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #8b5cf6 20%, #7c3aed 50%, #8b5cf6 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(2) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%);
            color: #6b21a8;
            border-color: #e9d5ff;
            box-shadow: 0 3px 12px rgba(139, 92, 246, 0.15);
        }
        
        .section-divider:nth-of-type(2) .section-divider-text i {
            color: #8b5cf6;
        }

        .section-divider:nth-of-type(3) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #ef4444 20%, #dc2626 50%, #ef4444 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(3) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
            color: #991b1b;
            border-color: #fecaca;
            box-shadow: 0 3px 12px rgba(239, 68, 68, 0.15);
        }
        
        .section-divider:nth-of-type(3) .section-divider-text i {
            color: #ef4444;
        }

        .section-divider:nth-of-type(4) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #06b6d4 20%, #0891b2 50%, #06b6d4 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(4) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            color: #0c4a6e;
            border-color: #bae6fd;
            box-shadow: 0 3px 12px rgba(6, 182, 212, 0.15);
        }
        
        .section-divider:nth-of-type(4) .section-divider-text i {
            color: #06b6d4;
        }
        
        @media (max-width: 768px) {
            .budget-divider-text {
                font-size: 16px;
                padding: 6px 20px;
                gap: 10px;
            }
            
            .budget-divider-text i {
                font-size: 18px;
            }
            
            .budget-divider-subtitle {
                font-size: 13px;
            }
            
            .section-divider-text {
                font-size: 14px;
                padding: 5px 20px;
                gap: 10px;
            }
            
            .section-divider-text i {
                font-size: 16px;
            }
        }

        /* === SEÇÃO DE TOTAIS === */
        .totals-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            margin-bottom: 2rem;
        }

        .totals-summary {
            padding: 1.5rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .total-row:last-child {
            border-bottom: none;
        }

        .subtotal-row .total-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .subtotal-row .total-value {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .multiplier-row {
            border-bottom: none;
            padding-bottom: 0.5rem;
        }

        .multiplier-row .total-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .total-multiplier {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .total-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            margin: 1rem 0;
        }

        .final-row {
            padding: 1rem 0 0.5rem 0;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .total-label-final {
            color: white;
            font-size: 1.2rem;
        }

        .total-value-final {
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .total-label i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        /* Responsivo para totais */
        @media (max-width: 768px) {
            .totals-summary {
                padding: 1rem;
            }
            
            .total-value-final {
                font-size: 1.3rem;
            }
            
            .total-label-final {
                font-size: 1.1rem;
            }
        }

        /* === RESUMO FINANCEIRO MODERNO === */
        /* === RESUMO FINANCEIRO COMPACTO === */
        .financial-summary-compact {
            background: white;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .financial-header-compact {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem 0.75rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .financial-icon-compact {
            color: #667eea;
            font-size: 1.1rem;
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .financial-title-compact {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .financial-content-compact {
            padding: 1rem 1.25rem 1.25rem 1.25rem;
        }

        .financial-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.95rem;
        }

        .financial-label {
            display: flex;
            align-items: center;
            color: #64748b;
            font-weight: 500;
        }

        .financial-label i {
            color: #94a3b8;
            font-size: 0.85rem;
            width: 16px;
            margin-right: 0.5rem;
        }

        .financial-value {
            font-weight: 600;
            color: #1a202c;
        }

        .multiplier-row {
            color: #059669;
        }

        .multiplier-row .financial-label {
            color: #059669;
        }

        .multiplier-row .financial-label i {
            color: #059669;
        }

        .multiplier-tag {
            background: #ecfdf5;
            color: #059669;
            padding: 0.125rem 0.375rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.375rem;
        }

        .multiplier-amount {
            color: #059669;
            font-weight: 600;
        }

        .financial-separator {
            height: 1px;
            background: linear-gradient(to right, transparent, #e2e8f0, transparent);
            margin: 0.75rem 0;
        }

        .total-row {
            background: #f8fafc;
            margin: 0 -1.25rem -1.25rem -1.25rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid #e2e8f0;
        }

        .financial-label-total {
            display: flex;
            align-items: center;
            color: #1a202c;
            font-weight: 700;
            font-size: 1rem;
        }

        .financial-label-total i {
            color: #667eea;
            font-size: 0.9rem;
            width: 16px;
            margin-right: 0.5rem;
        }

        .financial-value-total {
            font-weight: 700;
            font-size: 1.2rem;
            color: #667eea;
        }

        /* === AÇÕES RÁPIDAS MODERNAS === */
        .quick-actions-container {
            margin: 2rem 0;
        }

        .quick-action-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .quick-action-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
        }

        .quick-action-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .quick-action-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .quick-action-text h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .quick-action-text p {
            margin: 0;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .quick-action-button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .quick-action-button i {
            font-size: 1rem;
        }

        /* Responsivo para novos elementos */
        @media (max-width: 768px) {
            .quick-action-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .quick-action-info {
                justify-content: center;
            }

            .financial-header {
                padding: 1rem;
            }

            .financial-breakdown {
                padding: 1rem;
            }

            .breakdown-value-final {
                font-size: 1.2rem;
            }
        }

    </style>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="{{ url_for('static', filename='pdf_exporter_teste2_exact.js') }}"></script>

    <script>
        // Função para expandir/colapsar famílias de produtos
        function toggleFamily(familyName) {
            const productsDiv = document.getElementById('products-' + familyName);
            const chevron = document.getElementById('chevron-' + familyName);
            
            if (productsDiv.style.display === 'none') {
                productsDiv.style.display = 'block';
                chevron.classList.add('rotated');
            } else {
                productsDiv.style.display = 'none';
                chevron.classList.remove('rotated');
            }
        }

        // Funções para controle de quantidade
        function changeQuantity(productId, change) {
            const qtyInput = document.getElementById('qty_' + productId);
            let newQty = parseInt(qtyInput.value) + change;
            if (newQty < 0) newQty = 0;  // Permitir quantidade 0 para produtos opcionais/alternativos
            qtyInput.value = newQty;
            updateProductQuantity(productId, newQty);
        }

        function updateProductQuantity(productId, quantity) {
            // Validar quantidade antes de enviar
            if (quantity === null || quantity === undefined || quantity === '') {
                quantity = 0;
            }
            
            const validQuantity = Math.max(0, parseInt(quantity) || 0);  // Permitir quantidade 0
            
            // Enviar atualização para o servidor
            fetch('/update_quantity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: validQuantity
                })
            }).then(() => {
                location.reload(); // Recarregar para atualizar preços
            });
        }

        // Função para alternar produtos opcionais (incluir/excluir)
        // Função para incluir produto opcional no orçamento
        function includeOptionalProduct(productId, familyName) {
            const quantityInput = document.getElementById('qty_' + productId);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Se quantidade for 0, definir como 1 ao incluir
            const finalQuantity = quantity === 0 ? 1 : quantity;
            
            fetch('/include_optional_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    family: familyName,
                    quantity: finalQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> Produto incluído no orçamento`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Erro ao incluir produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function toggleOptional(productId) {
            const button = document.getElementById('toggle_' + productId);
            const isActive = button.classList.contains('active');
            
            fetch('/toggle_optional', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    include: !isActive
                })
            }).then(() => {
                location.reload(); // Recarregar para atualizar preços
            });
        }

        // Função para trocar produto opcional por incluído
        function replaceProduct(familyName, productId) {
            console.log('DEBUG: familyName recebido:', familyName);
            console.log('DEBUG: productId recebido:', productId);
            
            fetch('/switch_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: familyName,
                    item_id: productId
                })
            }).then(response => response.json())
            .then(data => {
                console.log('DEBUG: Resposta do servidor:', data);
                if (data.success) {
                    location.reload(); // Recarregar para atualizar a interface
                } else {
                    alert('Erro ao trocar produto: ' + data.error);
                }
            }).catch(error => {
                console.error('Erro:', error);
                alert('Erro ao trocar produto');
            });
        }

        // Função para exportar PDF
        function updateQuantity(family, productId, newQuantity) {
            newQuantity = Math.max(0, parseInt(newQuantity));
            
            fetch('/update_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: family,
                    item_id: productId,
                    quantity: newQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar a interface
                    location.reload();
                } else {
                    alert('Erro ao atualizar quantidade: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar quantidade');
            });
        }
        
        function switchProduct(family, productId) {
            fetch('/switch_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: family,
                    item_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar a interface
                    location.reload();
                } else {
                    alert('Erro ao trocar produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao trocar produto');
            });
        }
        
        // Função para mostrar alternativas disponíveis da base de dados
        let selectedAlternative = null;
        let currentSelection = null;

        function showAlternatives(family, currentProductId) {
            // Buscar alternativas da base de dados
            fetch(`/get_alternatives/${family}/${currentProductId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Erro ao buscar alternativas: ' + data.error);
                        return;
                    }
                    
                    if (data.alternatives.length === 0) {
                        alert('Não existem alternativas disponíveis para este produto.');
                        return;
                    }

                    selectedAlternative = null;
                    currentSelection = {family, currentProductId, data};

                    let optionsHTML = `
                        <div style="max-width: 650px; width: 90vw;">
                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 16px 16px 0 0; padding: 24px; border-bottom: 3px solid #3b82f6;">
                                <h3 style="color: #1e293b; margin: 0 0 8px 0; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-exchange-alt" style="color: #3b82f6; background: white; padding: 8px; border-radius: 50%; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);"></i>
                                    Selecionar Alternativa
                                </h3>
                                <p style="color: #64748b; margin: 0; font-size: 14px;">Escolha a melhor opção para o seu projeto</p>
                            </div>
                            
                            <div style="padding: 24px; background: white;">
                                <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; border: 2px solid #3b82f6; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 0; right: 0; background: #3b82f6; color: white; padding: 4px 12px; border-radius: 0 10px 0 8px; font-size: 12px; font-weight: 600;">ATUAL</div>
                                    <div style="font-weight: 700; color: #1e293b; margin-bottom: 6px; font-size: 16px;">${data.current_product.name}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6b7280; font-size: 14px;">Produto atual selecionado</span>
                                        <span style="color: #3b82f6; font-weight: 800; font-size: 18px;">${data.current_product.price.toFixed(2)}€</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #374151; margin-bottom: 16px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-list-alt" style="color: #6b7280;"></i>
                                        Alternativas Disponíveis
                                    </h4>
                                    <div style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto; padding-right: 8px;">
                    `;

                    data.alternatives.forEach((alt, index) => {
                        const priceDiff = alt.price - data.current_product.price;
                        const diffText = priceDiff > 0 ? `+${priceDiff.toFixed(2)}€` : `${priceDiff.toFixed(2)}€`;
                        const diffColor = priceDiff > 0 ? '#ef4444' : '#10b981';
                        
                        optionsHTML += `
                            <div class="alternative-option" data-id="${alt.id}" onclick="selectAlternativeOption('${alt.id}')" 
                                 style="
                                     padding: 16px 20px; 
                                     border: 2px solid #e2e8f0;
                                     border-radius: 12px; 
                                     cursor: pointer; 
                                     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                     background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                                     position: relative;
                                     overflow: hidden;
                                 ">
                                <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #e2e8f0; transition: all 0.3s ease;"></div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 16px;">${alt.name}</div>
                                        ${alt.description ? `<div style="color: #6b7280; font-size: 13px; line-height: 1.4;">${alt.description}</div>` : ''}
                                    </div>
                                    <div style="text-align: right; margin-left: 16px;">
                                        <div style="color: #0ea5e9; font-weight: 700; font-size: 18px;">${alt.price.toFixed(2)}€</div>
                                        <div style="color: ${diffColor}; font-size: 12px; font-weight: 600; margin-top: 2px;">${diffText}</div>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                    <div style="display: flex; gap: 8px;">
                                        ${Object.keys(alt.attributes || {})
                                            .filter(key => !['Capacidade', 'capacidade', 'Diametro', 'diametro', 'Diâmetro'].includes(key))
                                            .slice(0, 2)
                                            .map(key => 
                                                `<span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${key}: ${alt.attributes[key]}</span>`
                                            ).join('')}
                                    </div>
                                    <div class="selection-indicator" style="opacity: 0; color: #10b981; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; transition: opacity 0.3s ease;">
                                        <i class="fas fa-check-circle"></i> Selecionado
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    optionsHTML += `
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                    <button onclick="closeAlternativesModal()" 
                                            style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#4b5563'"
                                            onmouseout="this.style.background='#6b7280'">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button id="confirmButton" onclick="confirmSelection()" 
                                            style="background: #d1d5db; color: #9ca3af; border: none; padding: 12px 24px; border-radius: 8px; cursor: not-allowed; font-weight: 600; font-size: 14px; transition: all 0.3s ease;"
                                            disabled>
                                        <i class="fas fa-check"></i> Confirmar Seleção
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // Criar modal
                    const modal = document.createElement('div');
                    modal.id = 'alternativesModal';
                    modal.style.cssText = `
                        position: fixed; 
                        top: 0; left: 0; 
                        width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.7); 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        z-index: 1000;
                        backdrop-filter: blur(6px);
                        animation: fadeIn 0.3s ease;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 95vw; max-height: 95vh; overflow: hidden; animation: slideUp 0.3s ease;">
                            ${optionsHTML}
                        </div>
                    `;

                    document.body.appendChild(modal);

                    // Adicionar estilos de animação
                    if (!document.getElementById('modalAnimations')) {
                        const style = document.createElement('style');
                        style.id = 'modalAnimations';
                        style.textContent = `
                            @keyframes fadeIn {
                                from { opacity: 0; }
                                to { opacity: 1; }
                            }
                            @keyframes slideUp {
                                from { opacity: 0; transform: translateY(50px) scale(0.95); }
                                to { opacity: 1; transform: translateY(0) scale(1); }
                            }
                            @keyframes slideInRight {
                                from { opacity: 0; transform: translateX(100px); }
                                to { opacity: 1; transform: translateX(0); }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar alternativas:', error);
                    alert('Erro ao buscar alternativas. Tente novamente.');
                });
        }

        function selectAlternativeOption(altId) {
            // Remover seleção anterior
            document.querySelectorAll('.alternative-option').forEach(option => {
                option.style.borderColor = '#e2e8f0';
                option.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)';
                option.style.transform = 'none';
                option.querySelector('.selection-indicator').style.opacity = '0';
                option.querySelector('div[style*="position: absolute"]').style.background = '#e2e8f0';
            });

            // Aplicar seleção atual
            const selectedOption = document.querySelector(`[data-id="${altId}"]`);
            selectedOption.style.borderColor = '#10b981';
            selectedOption.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
            selectedOption.style.transform = 'translateY(-2px)';
            selectedOption.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.15)';
            selectedOption.querySelector('.selection-indicator').style.opacity = '1';
            selectedOption.querySelector('div[style*="position: absolute"]').style.background = '#10b981';

            // Ativar botão de confirmação
            const confirmBtn = document.getElementById('confirmButton');
            confirmBtn.disabled = false;
            confirmBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            confirmBtn.style.color = 'white';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';

            // Armazenar seleção
            selectedAlternative = altId;
        }

        function confirmSelection() {
            if (!selectedAlternative || !currentSelection) {
                return;
            }

            const { family, currentProductId } = currentSelection;

            // Fazer a chamada para o backend
            fetch('/replace_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: family,
                    current_product_id: currentProductId,
                    new_product_id: selectedAlternative
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        animation: slideInRight 0.3s ease;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    closeAlternativesModal();
                    setTimeout(() => location.reload(), 1000); // Recarregar após mostrar o feedback
                } else {
                    alert('Erro ao trocar produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function selectAlternative(family, currentProductId, newProductId) {
            // Esta função é mantida para compatibilidade, mas não é mais usada
            // A nova lógica usa selectAlternativeOption e confirmSelection
        }

        function closeAlternativesModal() {
            const modal = document.getElementById('alternativesModal');
            if (modal) {
                modal.remove();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Animações de entrada sequencial
            const cards = document.querySelectorAll('.slide-up');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.8s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 200);
            });
        });

        // ==========================================
        // FUNÇÕES PARA REMOVER PRODUTOS
        // ==========================================
        
        function removeProduct(productId, familyName) {
            if (!confirm('Tem certeza que deseja remover este produto do orçamento?')) {
                return;
            }
            
            fetch('/remove_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    family: familyName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        animation: slideInRight 0.3s ease;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-trash-alt"></i> ${data.message}`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Erro ao remover produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        // ==========================================
        // FUNÇÕES PARA ADICIONAR NOVOS PRODUTOS
        // ==========================================

        function showAddProductModal() {
            // Buscar famílias disponíveis
            fetch('/get_product_families')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createAddProductModal(data.families);
                } else {
                    alert('Erro ao buscar famílias: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function createAddProductModal(families) {
            // Remover modal existente se houver
            const existingModal = document.getElementById('addProductModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Ícones para famílias
            const familyIcons = {
                'Filtração': 'fa-filter',
                'Recirculação e Iluminação': 'fa-water',
                'Aquecimento': 'fa-thermometer-half',
                'Iluminação': 'fa-lightbulb',
                'Automação': 'fa-robot',
                'Limpeza': 'fa-broom',
                'Acessórios': 'fa-wrench'
            };

            // Normalizar e remover famílias duplicadas (mesmo nome, diferenças de caixa/espacos)
            const seenFamilies = new Set();
            const uniqueFamilies = [];
            families.forEach(f => {
                const key = (f.name || '').toString().trim().toLowerCase();
                if (!seenFamilies.has(key)) {
                    seenFamilies.add(key);
                    uniqueFamilies.push(f);
                }
            });

            const modal = document.createElement('div');
            modal.id = 'addProductModal';
            modal.className = 'add-product-modal';

            modal.innerHTML = `
                <div class="add-product-modal-content">
                    <div class="add-product-modal-header">
                        <h3>
                            <i class="fas fa-plus-circle"></i>
                            Adicionar Novo Produto
                        </h3>
                    </div>
                    <div class="add-product-modal-body">
                        <div id="familySelection">
                            <p style="color: #64748b; margin-bottom: 0.5rem;">Selecione a família do produto:</p>
                                <div class="family-grid">
                                ${uniqueFamilies.map(family => `
                                    <div class="family-card-modal" onclick="showFamilyProducts('${family.name}')">
                                        <div class="family-icon">
                                            <i class="fas ${familyIcons[family.name] || 'fa-box'}"></i>
                                        </div>
                                        <div class="family-title">${family.name}</div>
                                        <div class="family-count">${family.product_count} produtos</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div id="productSelection" style="display: none;">
                            <!-- Produtos serão carregados aqui -->
                        </div>
                    </div>
                    <div class="add-product-modal-footer">
                        <div id="modalBackButton" style="display: none;">
                            <button class="modal-back-btn" onclick="backToFamilies()">
                                <i class="fas fa-arrow-left"></i>
                                Voltar às Famílias
                            </button>
                        </div>
                        <div>
                            <button class="modal-close-btn" onclick="closeAddProductModal()">
                                <i class="fas fa-times"></i>
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Animação de entrada
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);

            // Fechar ao clicar fora do modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAddProductModal();
                }
            });
        }

        function showFamilyProducts(familyName) {
            fetch(`/get_family_products/${encodeURIComponent(familyName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFamilyProducts(familyName, data.products);
                } else {
                    alert('Erro ao buscar produtos: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function displayFamilyProducts(familyName, products) {
            const familyDiv = document.getElementById('familySelection');
            const productDiv = document.getElementById('productSelection');
            const backButton = document.getElementById('modalBackButton');
            
            familyDiv.style.display = 'none';
            productDiv.style.display = 'block';
            backButton.style.display = 'block';
            
            productDiv.innerHTML = `
                <h4 style="margin: 0 0 1rem 0; color: #1a202c; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-box"></i>
                    Produtos - ${familyName}
                </h4>
                <div class="product-list-modal">
                    ${products.map(product => `
                        <div class="product-item-modal">
                            <div class="product-info-modal">
                                <div class="product-details-modal">
                                    <div class="product-name-modal">${product.name}</div>
                                    <div class="product-description-modal">
                                        ${product.description || 'Sem descrição disponível'}
                                    </div>
                                    <div class="product-price-modal">
                                        ${product.base_price.toFixed(2)}€
                                    </div>
                                </div>
                                <div class="product-actions-modal">
                                    <button class="product-action-btn include" onclick="addProductToQuote(${product.id}, 'incluido')">
                                        Incluir
                                    </button>
                                    <button class="product-action-btn optional" onclick="addProductToQuote(${product.id}, 'opcional')">
                                        Opcional
                                    </button>
                                    <button class="product-action-btn alternative" onclick="showAlternativeSelection(${product.id})">
                                        Alternativo
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function backToFamilies() {
            const familyDiv = document.getElementById('familySelection');
            const productDiv = document.getElementById('productSelection');
            const backButton = document.getElementById('modalBackButton');
            
            familyDiv.style.display = 'block';
            productDiv.style.display = 'none';
            backButton.style.display = 'none';
        }

        function closeAddProductModal() {
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function showAlternativeSelection(productId) {
            // Buscar produtos já incluídos no orçamento
            const includedProducts = collectIncludedProducts();
            
            if (includedProducts.length === 0) {
                alert('❌ Não há produtos incluídos no orçamento para associar como alternativo. Adicione primeiro alguns produtos como incluídos.');
                return;
            }
            
            // Criar modal de seleção
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal alternative-modal">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-exchange-alt"></i> Selecionar Produto Principal</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <p class="modal-description">
                            <i class="fas fa-info-circle"></i>
                            Selecione a qual produto incluído este produto será uma alternativa:
                        </p>
                        <div class="products-list">
                            ${includedProducts.map(product => `
                                <div class="product-option" onclick="selectMainProduct('${productId}', '${product.id}')">
                                    <div class="product-info">
                                        <div class="product-name">${product.name}</div>
                                        <div class="product-family">${product.family}</div>
                                    </div>
                                    <div class="product-price">${product.price}</div>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="edit-modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Função para coletar produtos já incluídos no orçamento
        function collectIncludedProducts() {
            const products = [];
            
            // Percorrer todas as famílias e coletar produtos incluídos
            document.querySelectorAll('.family-card-compact').forEach(familyCard => {
                const familyName = familyCard.querySelector('.family-title-compact')?.textContent.trim() || 'Família';
                
                familyCard.querySelectorAll('.product-row-compact-detailed').forEach(productRow => {
                    // Verificar se é produto incluído (não alternativo)
                    if (!productRow.classList.contains('alternative-product')) {
                        const nameElement = productRow.querySelector('.product-name-detail, .product-name-compact');
                        const priceElement = productRow.querySelector('.product-price, .spec-price');
                        const quantityInput = productRow.querySelector('input[type="number"]');
                        
                        if (nameElement && priceElement && quantityInput) {
                            // Obter ID do produto a partir do input de quantidade
                            let productId = null;
                            if (quantityInput.id) {
                                productId = quantityInput.id.replace('qty_', '');
                            } else if (quantityInput.name) {
                                productId = quantityInput.name.replace('qty_', '');
                            }
                            
                            // Tentar outras formas de obter o ID se não encontrou
                            if (!productId) {
                                const parentRow = quantityInput.closest('.product-row-compact-detailed');
                                if (parentRow && parentRow.dataset.productId) {
                                    productId = parentRow.dataset.productId;
                                }
                            }
                            
                            if (productId && parseInt(quantityInput.value) > 0) {
                                products.push({
                                    id: productId,
                                    name: nameElement.textContent.trim(),
                                    family: familyName,
                                    price: priceElement.textContent.trim(),
                                    quantity: quantityInput.value
                                });
                            }
                        }
                    }
                });
            });
            
            // Debug: mostrar produtos encontrados
            console.log('Produtos incluídos encontrados:', products);
            
            return products;
        }
        
        // Função para selecionar produto principal e adicionar alternativo
        function selectMainProduct(alternativeProductId, mainProductId) {
            closeModal();
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
                z-index: 1001;
                font-weight: 600;
            `;
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando produto alternativo...';
            document.body.appendChild(loadingDiv);
            
            // Adicionar produto como alternativo
            addProductToQuote(alternativeProductId, 'alternativo', mainProductId);
            
            // Remover loading após um tempo
            setTimeout(() => {
                if (document.body.contains(loadingDiv)) {
                    loadingDiv.remove();
                }
            }, 3000);
        }

        function addProductToQuote(productId, itemType, alternativeTo = null) {
            fetch('/add_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    item_type: itemType,
                    alternative_to: alternativeTo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        animation: slideInRight 0.3s ease;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-plus-circle"></i> ${data.message}`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    closeAddProductModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Erro ao adicionar produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        // Sistema de edição inline - Popups para editar dados
        
        // Função principal para editar configuração completa do projeto (medidas + questionário)
        function editProjectConfiguration() {
            // Obter dados atuais das medidas
            const dimensionsText = document.querySelector('.value-dimensions')?.textContent || '0×0m';
            const depthText = document.querySelector('.value-depth')?.textContent || '0-0m';
            
            const comprimento = dimensionsText.split('×')[0]?.replace('m', '').trim() || '0';
            const largura = dimensionsText.split('×')[1]?.replace('m', '').trim() || '0';
            const profMin = depthText.split('-')[0]?.replace('m', '').trim() || '0';
            const profMax = depthText.split('-')[1]?.replace('m', '').trim() || '0';
            
            // Buscar respostas atuais do servidor
            fetch('/get_current_answers')
            .then(response => response.json())
            .then(data => {
                const currentAnswers = data.answers || {};
                showConfigurationModal(comprimento, largura, profMin, profMax, currentAnswers);
            })
            .catch(error => {
                console.error('Erro ao buscar respostas:', error);
                // Usar valores padrão em caso de erro
                const currentAnswers = {
                    acesso: 'facil',
                    escavacao: 'mecanica',
                    forma: 'retangular',
                    tipo_piscina: 'skimmer',
                    revestimento: 'vinil',
                    domotica: 'nao',
                    localizacao: 'exterior',
                    luz: 'led'
                };
                showConfigurationModal(comprimento, largura, profMin, profMax, currentAnswers);
            });
        }
        
        // Função para mostrar o modal com os dados
        function showConfigurationModal(comprimento, largura, profMin, profMax, currentAnswers) {
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay large-modal';
            modal.innerHTML = `
                <div class="edit-modal large premium">
                    <div class="edit-modal-header premium-header">
                        <div class="header-left">
                            <div class="header-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="header-text">
                                <h3>Configuração Completa do Projeto</h3>
                                <p>Edite as medidas da piscina e configurações técnicas</p>
                            </div>
                        </div>
                        <button onclick="closeModal()" class="close-btn premium-close">&times;</button>
                    </div>
                    <div class="edit-modal-body large-body premium-body">
                        <!-- Seção 1: Dimensões da Piscina -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-ruler-combined section-icon"></i>
                                <h4>Dimensões da Piscina</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Comprimento</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-comprimento" value="${comprimento}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                                <div class="form-group premium-field">
                                    <label>Largura</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-largura" value="${largura}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                                <div class="form-group premium-field">
                                    <label>Profundidade Mínima</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-prof-min" value="${profMin}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                                <div class="form-group premium-field">
                                    <label>Profundidade Máxima</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-prof-max" value="${profMax}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seção 2: Condições do Local -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-map-marker-alt section-icon"></i>
                                <h4>Condições do Local</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Como é o acesso ao local?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.acesso === 'facil' ? 'selected' : ''}" data-value="facil">
                                        <i class="fas fa-truck" style="color: var(--success);"></i>
                                        <span>Fácil</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.acesso === 'medio' ? 'selected' : ''}" data-value="medio">
                                        <i class="fas fa-tools" style="color: var(--warning);"></i>
                                        <span>Médio</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.acesso === 'dificil' ? 'selected' : ''}" data-value="dificil">
                                        <i class="fas fa-mountain" style="color: var(--error);"></i>
                                        <span>Difícil</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-acesso" value="${currentAnswers.acesso || 'facil'}" />
                            </div>
                            <div class="form-group premium-field">
                                <label>É necessário escavação?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.escavacao === 'true' ? 'selected' : ''}" data-value="true">
                                        <i class="fas fa-shovel" style="color: var(--warning);"></i>
                                        <span>Sim</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.escavacao === 'false' ? 'selected' : ''}" data-value="false">
                                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                        <span>Não</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-escavacao" value="${currentAnswers.escavacao || 'false'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 3: Características da Piscina -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-swimming-pool section-icon"></i>
                                <h4>Características da Piscina</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Forma da piscina:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.forma === 'standard' ? 'selected' : ''}" data-value="standard">
                                        <i class="fas fa-square" style="color: var(--success);"></i>
                                        <span>Standard</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.forma === 'especial' ? 'selected' : ''}" data-value="especial">
                                        <i class="fas fa-star" style="color: var(--warning);"></i>
                                        <span>Especial</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-forma" value="${currentAnswers.forma || 'standard'}" />
                            </div>
                            <div class="form-group premium-field">
                                <label>Tipo de piscina:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.tipo_piscina === 'skimmer' ? 'selected' : ''}" data-value="skimmer">
                                        <i class="fas fa-water" style="color: var(--primary);"></i>
                                        <span>Skimmer</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tipo_piscina === 'espelho_dagua' ? 'selected' : ''}" data-value="espelho_dagua">
                                        <i class="fas fa-water" style="color: var(--secondary);"></i>
                                        <span>Espelho d'Água</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tipo_piscina === 'transbordo' ? 'selected' : ''}" data-value="transbordo">
                                        <i class="fas fa-wave-square" style="color: var(--accent);"></i>
                                        <span>Transbordo</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-tipo-piscina" value="${currentAnswers.tipo_piscina || 'skimmer'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 4: Acabamentos -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-palette section-icon"></i>
                                <h4>Acabamentos</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Tipo de revestimento:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.revestimento === 'tela' ? 'selected' : ''}" data-value="tela">
                                        <i class="fas fa-paint-roller" style="color: var(--success);"></i>
                                        <span>Tela</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.revestimento === 'ceramica' ? 'selected' : ''}" data-value="ceramica">
                                        <i class="fas fa-th-large" style="color: var(--secondary);"></i>
                                        <span>Cerâmica</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-revestimento" value="${currentAnswers.revestimento || 'tela'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 5: Tecnologia -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-microchip section-icon"></i>
                                <h4>Tecnologia</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Deseja sistema domótico?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.domotica === 'true' ? 'selected' : ''}" data-value="true">
                                        <i class="fas fa-mobile-alt" style="color: var(--accent);"></i>
                                        <span>Sim</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.domotica === 'false' ? 'selected' : ''}" data-value="false">
                                        <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                        <span>Não</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-domotica" value="${currentAnswers.domotica || 'false'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 6: Instalações -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-home section-icon"></i>
                                <h4>Instalações</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Localização:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.localizacao === 'interior' ? 'selected' : ''}" data-value="interior">
                                        <i class="fas fa-home" style="color: var(--secondary);"></i>
                                        <span>Interior</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.localizacao === 'exterior' ? 'selected' : ''}" data-value="exterior">
                                        <i class="fas fa-sun" style="color: var(--warning);"></i>
                                        <span>Exterior</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-localizacao" value="${currentAnswers.localizacao || 'exterior'}" />
                            </div>
                            <div class="form-group premium-field">
                                <label>Tipo de corrente elétrica:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.luz === 'monofasica' ? 'selected' : ''}" data-value="monofasica">
                                        <i class="fas fa-bolt" style="color: var(--success);"></i>
                                        <span>Monofásica</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.luz === 'trifasica' ? 'selected' : ''}" data-value="trifasica">
                                        <i class="fas fa-charging-station" style="color: var(--warning);"></i>
                                        <span>Trifásica</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-luz" value="${currentAnswers.luz || 'monofasica'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 7: Tratamento da Água -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-tint section-icon"></i>
                                <h4>Tratamento da Água</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Que tipo de tratamento da água pretende?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'cloro_manual' ? 'selected' : ''}" data-value="cloro_manual">
                                        <i class="fas fa-hand-paper" style="color: var(--success);"></i>
                                        <span>Cloro Manual</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'cloro_automatico' ? 'selected' : ''}" data-value="cloro_automatico">
                                        <i class="fas fa-robot" style="color: var(--primary);"></i>
                                        <span>Cloro Automático</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'clorador_salino' ? 'selected' : ''}" data-value="clorador_salino">
                                        <i class="fas fa-water" style="color: var(--secondary);"></i>
                                        <span>Clorador Salino</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'clorador_salino_ph' ? 'selected' : ''}" data-value="clorador_salino_ph">
                                        <i class="fas fa-balance-scale" style="color: var(--accent);"></i>
                                        <span>Clorador Salino + pH</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'clorador_salino_ph_uv' ? 'selected' : ''}" data-value="clorador_salino_ph_uv">
                                        <i class="fas fa-sun" style="color: var(--warning);"></i>
                                        <span>Clorador Salino + pH + UV</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'nao' ? 'selected' : ''}" data-value="nao">
                                        <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                        <span>Não Incluído</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-tratamento-agua" value="${currentAnswers.tratamento_agua || 'cloro_manual'}" />
                            </div>
                        </div>

                        <!-- Seção 6: Configurações de Construção -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-hard-hat section-icon"></i>
                                <h4>Configurações de Construção</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Tipo de Construção</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.tipo_construcao === 'nova' ? 'selected' : ''}" data-value="nova">
                                            <i class="fas fa-plus-circle"></i>
                                            <span>Construção Nova</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.tipo_construcao === 'remodelacao' ? 'selected' : ''}" data-value="remodelacao">
                                            <i class="fas fa-tools"></i>
                                            <span>Remodelação</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-tipo-construcao" value="${currentAnswers.tipo_construcao || 'nova'}" />
                                </div>
                            </div>
                        </div>

                        <!-- Seção 7: Cobertura -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-umbrella section-icon"></i>
                                <h4>Sistema de Cobertura</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Tipo de Cobertura</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'laminas' ? 'selected' : ''}" data-value="laminas">
                                            <i class="fas fa-window-minimize"></i>
                                            <span>Cobertura de Lâminas</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'bolhas' ? 'selected' : ''}" data-value="bolhas">
                                            <i class="fas fa-circle"></i>
                                            <span>Cobertura de Bolhas</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'barras' ? 'selected' : ''}" data-value="barras">
                                            <i class="fas fa-bars"></i>
                                            <span>Cobertura de Barras</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'lona' ? 'selected' : ''}" data-value="lona">
                                            <i class="fas fa-tarp"></i>
                                            <span>Cobertura de Lona</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'nao' ? 'selected' : ''}" data-value="nao">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Sem Cobertura</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-cobertura" value="${currentAnswers.cobertura || 'nao'}" />
                                </div>

                                <!-- Sub-opções para cobertura de lâminas -->
                                <div class="form-group premium-field" id="edit-cobertura-laminas-options" style="display: ${currentAnswers.cobertura === 'laminas' ? 'block' : 'none'};">
                                    <label>Tipo de Cobertura de Lâminas</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.tipo_cobertura_laminas === 'submersa_praia' ? 'selected' : ''}" data-value="submersa_praia">
                                            <i class="fas fa-water"></i>
                                            <span>Submersa na Praia</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.tipo_cobertura_laminas === 'fora_praia' ? 'selected' : ''}" data-value="fora_praia">
                                            <i class="fas fa-step-backward"></i>
                                            <span>Fora da Praia</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.tipo_cobertura_laminas === 'elevada' ? 'selected' : ''}" data-value="elevada">
                                            <i class="fas fa-arrow-up"></i>
                                            <span>Cobertura Elevada</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-tipo-cobertura-laminas" value="${currentAnswers.tipo_cobertura_laminas || ''}" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="edit-modal-footer premium-footer">
                        <button onclick="closeModal()" class="btn btn-secondary premium-btn">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button onclick="saveCompleteConfiguration()" class="btn btn-primary premium-btn primary">
                            <i class="fas fa-sync-alt"></i>
                            Salvar e Recalcular
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Adicionar event listeners para os radio buttons customizados
            setupPremiumRadioButtons();
        }
        
        // Função para configurar radio buttons premium
        function setupPremiumRadioButtons() {
            document.querySelectorAll('.radio-option-premium').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from siblings
                    const siblings = this.parentNode.querySelectorAll('.radio-option-premium');
                    siblings.forEach(sibling => sibling.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden input
                    const hiddenInput = this.parentNode.nextElementSibling;
                    if (hiddenInput && hiddenInput.tagName === 'INPUT') {
                        hiddenInput.value = this.dataset.value;
                        
                        // Handle cobertura sub-options visibility
                        if (hiddenInput.id === 'edit-cobertura') {
                            const laminasOptions = document.getElementById('edit-cobertura-laminas-options');
                            if (laminasOptions) {
                                if (this.dataset.value === 'laminas') {
                                    laminasOptions.style.display = 'block';
                                } else {
                                    laminasOptions.style.display = 'none';
                                    // Clear laminas type selection
                                    const laminasInput = document.getElementById('edit-tipo-cobertura-laminas');
                                    if (laminasInput) {
                                        laminasInput.value = '';
                                        // Remove selected class from laminas options
                                        const laminasRadios = laminasOptions.querySelectorAll('.radio-option-premium');
                                        laminasRadios.forEach(radio => radio.classList.remove('selected'));
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }
        
        // Função para salvar configuração completa e recalcular
        function saveCompleteConfiguration() {
            const newDimensions = {
                comprimento: parseFloat(document.getElementById('edit-comprimento').value),
                largura: parseFloat(document.getElementById('edit-largura').value),
                prof_min: parseFloat(document.getElementById('edit-prof-min').value),
                prof_max: parseFloat(document.getElementById('edit-prof-max').value)
            };
            
            const newAnswers = {
                acesso: document.getElementById('edit-acesso').value,
                escavacao: document.getElementById('edit-escavacao').value,
                forma: document.getElementById('edit-forma').value,
                tipo_piscina: document.getElementById('edit-tipo-piscina').value,
                revestimento: document.getElementById('edit-revestimento').value,
                domotica: document.getElementById('edit-domotica').value,
                localizacao: document.getElementById('edit-localizacao').value,
                luz: document.getElementById('edit-luz').value,
                tratamento_agua: document.getElementById('edit-tratamento-agua').value,
                tipo_construcao: document.getElementById('edit-tipo-construcao').value,
                cobertura: document.getElementById('edit-cobertura').value,
                tipo_cobertura_laminas: document.getElementById('edit-tipo-cobertura-laminas').value
            };
            
            // Mostrar loading
            const saveBtn = document.querySelector('.btn.btn-primary.premium-btn.primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recalculando...';
            saveBtn.disabled = true;
            
            // Enviar para o servidor para recalcular completamente
            fetch('/recalculate_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comprimento: newDimensions.comprimento,
                    largura: newDimensions.largura,
                    prof_min: newDimensions.prof_min,
                    prof_max: newDimensions.prof_max,
                    answers: newAnswers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    showSuccessMessage('✨ Configuração atualizada! Recarregando orçamento completo...');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    alert('❌ Erro ao recalcular: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                alert('❌ Erro ao comunicar com o servidor');
            });
        }
        
        // Função para editar informações do cliente
        function editClientInfo() {
            const clientName = document.querySelector('.client-name')?.textContent.replace(/[📞👤]/g, '').trim() || '';
            const proposalNumber = document.querySelector('.proposal-number')?.textContent.replace('#', '').trim() || '';
            const clientDate = document.querySelector('.date')?.textContent.replace(/[📅]/g, '').trim() || '';
            const commercialName = document.querySelector('.commercial-name')?.textContent.replace(/[👔]/g, '').trim() || '';
            
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-user-edit"></i> Editar Dados do Cliente</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <div class="form-group">
                            <label>Nome do Cliente</label>
                            <input type="text" id="edit-client-name" value="${clientName}" />
                        </div>
                        <div class="form-group">
                            <label>Número da Proposta</label>
                            <input type="text" id="edit-proposal-number" value="${proposalNumber}" />
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="edit-client-date" value="${clientDate}" />
                        </div>
                        <div class="form-group">
                            <label>Nome do Comercial</label>
                            <input type="text" id="edit-commercial-name" value="${commercialName}" />
                        </div>
                    </div>
                    <div class="edit-modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="saveClientInfo()" class="btn btn-primary">Salvar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Função para editar informações da piscina
        function editPoolInfo() {
            const dimensionsText = document.querySelector('.pool-dimensions, .value-dimensions')?.textContent || '0×0m';
            const depthText = document.querySelector('.pool-depth, .value-depth')?.textContent || '0-0m';
            
            const comprimento = dimensionsText.split('×')[0]?.replace('m', '').trim() || '0';
            const largura = dimensionsText.split('×')[1]?.replace('m', '').trim() || '0';
            const profMin = depthText.split('-')[0]?.replace('m', '').trim() || '0';
            const profMax = depthText.split('-')[1]?.replace('m', '').trim() || '0';
            
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-swimming-pool"></i> Editar Dados da Piscina</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <div class="form-group">
                            <label>Comprimento (m)</label>
                            <input type="number" id="edit-comprimento" value="${comprimento}" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>Largura (m)</label>
                            <input type="number" id="edit-largura" value="${largura}" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>Profundidade Mínima (m)</label>
                            <input type="number" id="edit-prof-min" value="${profMin}" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>Profundidade Máxima (m)</label>
                            <input type="number" id="edit-prof-max" value="${profMax}" step="0.1" />
                        </div>
                    </div>
                    <div class="edit-modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="savePoolInfo()" class="btn btn-primary">Salvar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Função para salvar dados do cliente
        function saveClientInfo() {
            const clientName = document.getElementById('edit-client-name').value;
            const proposalNumber = document.getElementById('edit-proposal-number').value;
            const clientDate = document.getElementById('edit-client-date').value;
            const commercialName = document.getElementById('edit-commercial-name').value;
            
            // Atualizar na interface
            const clientNameEl = document.querySelector('.client-name');
            if (clientNameEl) clientNameEl.innerHTML = `<i class="fas fa-user"></i> ${clientName}`;
            
            const proposalEl = document.querySelector('.proposal-number');
            if (proposalEl) proposalEl.innerHTML = `<i class="fas fa-hashtag"></i> ${proposalNumber}`;
            
            const dateEl = document.querySelector('.date');
            if (dateEl) dateEl.innerHTML = `<i class="fas fa-calendar"></i> ${clientDate}`;
            
            const commercialEl = document.querySelector('.commercial-name');
            if (commercialEl && commercialName) commercialEl.innerHTML = `<i class="fas fa-user-tie"></i> ${commercialName}`;
            
            closeModal();
            showSuccessMessage('Dados do cliente atualizados!');
        }

        // Função para salvar dados da piscina  
        function savePoolInfo() {
            const comprimento = document.getElementById('edit-comprimento').value;
            const largura = document.getElementById('edit-largura').value;
            const profMin = document.getElementById('edit-prof-min').value;
            const profMax = document.getElementById('edit-prof-max').value;
            
            // Obter respostas atuais do questionário para manter
            const poolTypeEl = document.querySelector('.value-pool-type');
            const shapeEl = document.querySelector('.value-shape');
            const coatingEl = document.querySelector('.value-coating');
            const accessEl = document.querySelector('.value-access');
            const excavationEl = document.querySelector('.value-excavation');
            const locationEl = document.querySelector('.value-location');
            const domoticsEl = document.querySelector('.value-domotics');
            const powerEl = document.querySelector('.value-power');
            
            const currentPoolType = poolTypeEl ? poolTypeEl.textContent.trim().toLowerCase() : '';
            const currentShape = shapeEl ? shapeEl.textContent.trim().toLowerCase() : '';
            const currentCoating = coatingEl ? coatingEl.textContent.trim().toLowerCase() : '';
            const currentAccess = accessEl ? accessEl.textContent.trim().toLowerCase() : '';
            const currentExcavation = excavationEl ? (excavationEl.textContent.includes('Incluída') ? 'true' : 'false') : 'false';
            const currentLocation = locationEl ? locationEl.textContent.trim().toLowerCase() : '';
            const currentDomotics = domoticsEl ? (domoticsEl.textContent.includes('Sim') ? 'true' : 'false') : 'false';
            const currentPower = powerEl ? (powerEl.textContent.includes('Trifásica') ? 'trifasica' : 'monofasica') : 'monofasica';
            
            // Mapear valores de volta para os códigos corretos
            let poolTypeCode = 'skimmer';
            if (currentPoolType.includes('espelho')) poolTypeCode = 'espelho_dagua';
            else if (currentPoolType.includes('transbordo')) poolTypeCode = 'transbordo';
            
            let shapeCode = 'retangular';
            if (currentShape.includes('quadrada')) shapeCode = 'quadrada';
            else if (currentShape.includes('oval')) shapeCode = 'oval';
            else if (currentShape.includes('redonda')) shapeCode = 'redonda';
            else if (currentShape.includes('l')) shapeCode = 'em_l';
            else if (currentShape.includes('irregular')) shapeCode = 'irregular';
            
            let coatingCode = 'vinil';
            if (currentCoating.includes('fibra')) coatingCode = 'fibra';
            else if (currentCoating.includes('azulejo')) coatingCode = 'azulejo';
            else if (currentCoating.includes('pastilha')) coatingCode = 'pastilha';
            else if (currentCoating.includes('pedra')) coatingCode = 'pedra';
            
            let accessCode = 'facil';
            if (currentAccess.includes('medio')) accessCode = 'medio';
            else if (currentAccess.includes('dificil')) accessCode = 'dificil';
            
            let locationCode = 'urbana';
            if (currentLocation.includes('rural')) locationCode = 'rural';
            else if (currentLocation.includes('costeira')) locationCode = 'costeira';
            
            // Preparar dados para recalcular
            const updateData = {
                comprimento: parseFloat(comprimento),
                largura: parseFloat(largura),
                prof_min: parseFloat(profMin),
                prof_max: parseFloat(profMax),
                answers: {
                    tipo_piscina: poolTypeCode,
                    forma: shapeCode,
                    revestimento: coatingCode,
                    acesso: accessCode,
                    escavacao: currentExcavation,
                    localizacao: locationCode,
                    domotica: currentDomotics,
                    luz: currentPower
                }
            };
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Recalculando com novas medidas...`;
            document.body.appendChild(loadingDiv);
            
            // Enviar para o backend para recalcular
            fetch('/recalculate_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.remove();
                if (data.success) {
                    closeModal();
                    showSuccessMessage('Medidas atualizadas e orçamento recalculado!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showErrorMessage('Erro ao recalcular: ' + data.error);
                }
            })
            .catch(error => {
                loadingDiv.remove();
                console.error('Erro ao recalcular:', error);
                showErrorMessage('Erro de comunicação com o servidor');
            });
        }

        // Função para editar respostas do questionário
        function editQuestionnaireAnswers() {
            // Capturar valores atuais das respostas
            const poolTypeEl = document.querySelector('.value-pool-type');
            const shapeEl = document.querySelector('.value-shape');
            const coatingEl = document.querySelector('.value-coating');
            const accessEl = document.querySelector('.value-access');
            const excavationEl = document.querySelector('.value-excavation');
            const locationEl = document.querySelector('.value-location');
            const domoticsEl = document.querySelector('.value-domotics');
            const powerEl = document.querySelector('.value-power');
            
            const currentPoolType = poolTypeEl ? poolTypeEl.textContent.trim().toLowerCase() : '';
            const currentShape = shapeEl ? shapeEl.textContent.trim().toLowerCase() : '';
            const currentCoating = coatingEl ? coatingEl.textContent.trim().toLowerCase() : '';
            const currentAccess = accessEl ? accessEl.textContent.trim().toLowerCase() : '';
            const currentExcavation = excavationEl ? (excavationEl.textContent.includes('Incluída') ? 'true' : 'false') : 'false';
            const currentLocation = locationEl ? locationEl.textContent.trim().toLowerCase() : '';
            const currentDomotics = domoticsEl ? (domoticsEl.textContent.includes('Sim') ? 'true' : 'false') : 'false';
            const currentPower = powerEl ? (powerEl.textContent.includes('Trifásica') ? 'trifasica' : 'monofasica') : 'monofasica';
            
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal questionnaire-modal">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-cog"></i> Editar Configuração do Projeto</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <div class="form-group">
                            <label>Tipo de Piscina</label>
                            <select id="edit-pool-type">
                                <option value="skimmer" ${currentPoolType.includes('skimmer') ? 'selected' : ''}>Skimmer</option>
                                <option value="espelho_dagua" ${currentPoolType.includes('espelho') ? 'selected' : ''}>Espelho d'Água</option>
                                <option value="transbordo" ${currentPoolType.includes('transbordo') ? 'selected' : ''}>Transbordo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Forma</label>
                            <select id="edit-shape">
                                <option value="retangular" ${currentShape.includes('retangular') ? 'selected' : ''}>Retangular</option>
                                <option value="quadrada" ${currentShape.includes('quadrada') ? 'selected' : ''}>Quadrada</option>
                                <option value="oval" ${currentShape.includes('oval') ? 'selected' : ''}>Oval</option>
                                <option value="redonda" ${currentShape.includes('redonda') ? 'selected' : ''}>Redonda</option>
                                <option value="em_l" ${currentShape.includes('l') ? 'selected' : ''}>Em L</option>
                                <option value="irregular" ${currentShape.includes('irregular') ? 'selected' : ''}>Irregular</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Revestimento</label>
                            <select id="edit-coating">
                                <option value="vinil" ${currentCoating.includes('vinil') ? 'selected' : ''}>Vinil</option>
                                <option value="fibra" ${currentCoating.includes('fibra') ? 'selected' : ''}>Fibra de Vidro</option>
                                <option value="azulejo" ${currentCoating.includes('azulejo') ? 'selected' : ''}>Azulejo</option>
                                <option value="pastilha" ${currentCoating.includes('pastilha') ? 'selected' : ''}>Pastilha</option>
                                <option value="pedra" ${currentCoating.includes('pedra') ? 'selected' : ''}>Pedra Natural</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Acesso ao Local</label>
                            <select id="edit-access">
                                <option value="facil" ${currentAccess.includes('facil') ? 'selected' : ''}>Fácil</option>
                                <option value="medio" ${currentAccess.includes('medio') ? 'selected' : ''}>Médio</option>
                                <option value="dificil" ${currentAccess.includes('dificil') ? 'selected' : ''}>Difícil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Escavação</label>
                            <select id="edit-excavation">
                                <option value="true" ${currentExcavation === 'true' ? 'selected' : ''}>Incluída</option>
                                <option value="false" ${currentExcavation === 'false' ? 'selected' : ''}>Não Incluída</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Localização</label>
                            <select id="edit-location">
                                <option value="urbana" ${currentLocation.includes('urbana') ? 'selected' : ''}>Urbana</option>
                                <option value="rural" ${currentLocation.includes('rural') ? 'selected' : ''}>Rural</option>
                                <option value="costeira" ${currentLocation.includes('costeira') ? 'selected' : ''}>Costeira</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sistema Domótico</label>
                            <select id="edit-domotics">
                                <option value="true" ${currentDomotics === 'true' ? 'selected' : ''}>Sim</option>
                                <option value="false" ${currentDomotics === 'false' ? 'selected' : ''}>Não</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Alimentação Elétrica</label>
                            <select id="edit-power">
                                <option value="monofasica" ${currentPower === 'monofasica' ? 'selected' : ''}>Monofásica</option>
                                <option value="trifasica" ${currentPower === 'trifasica' ? 'selected' : ''}>Trifásica</option>
                            </select>
                        </div>
                    </div>
                    <div class="edit-modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="saveQuestionnaireAnswers()" class="btn btn-primary">Salvar e Recalcular</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Função para salvar respostas do questionário e recalcular
        function saveQuestionnaireAnswers() {
            const poolType = document.getElementById('edit-pool-type').value;
            const shape = document.getElementById('edit-shape').value;
            const coating = document.getElementById('edit-coating').value;
            const access = document.getElementById('edit-access').value;
            const excavation = document.getElementById('edit-excavation').value;
            const location = document.getElementById('edit-location').value;
            const domotics = document.getElementById('edit-domotics').value;
            const power = document.getElementById('edit-power').value;
            
            // Coletar também as medidas atuais da piscina
            const dimensionsEl = document.querySelector('.pool-dimensions, .value-dimensions');
            const depthEl = document.querySelector('.pool-depth, .value-depth');
            
            const dimensionsText = dimensionsEl ? dimensionsEl.textContent : '0×0m';
            const depthText = depthEl ? depthEl.textContent : '0-0m';
            
            const comprimento = dimensionsText.split('×')[0]?.replace('m', '').trim() || '0';
            const largura = dimensionsText.split('×')[1]?.replace('m', '').trim() || '0';
            const profMin = depthText.split('-')[0]?.replace('m', '').trim() || '0';
            const profMax = depthText.split('-')[1]?.replace('m', '').trim() || '0';
            
            // Preparar dados para enviar ao backend
            const updateData = {
                // Medidas da piscina
                comprimento: parseFloat(comprimento),
                largura: parseFloat(largura),
                prof_min: parseFloat(profMin),
                prof_max: parseFloat(profMax),
                // Respostas do questionário
                answers: {
                    tipo_piscina: poolType,
                    forma: shape,
                    revestimento: coating,
                    acesso: access,
                    escavacao: excavation,
                    localizacao: location,
                    domotica: domotics,
                    luz: power
                }
            };
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Recalculando orçamento...`;
            document.body.appendChild(loadingDiv);
            
            // Enviar para o backend para recalcular
            fetch('/recalculate_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.remove();
                if (data.success) {
                    // Recarregar a página para mostrar os novos cálculos
                    closeModal();
                    showSuccessMessage('Orçamento recalculado com sucesso!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showErrorMessage('Erro ao recalcular: ' + data.error);
                }
            })
            .catch(error => {
                loadingDiv.remove();
                console.error('Erro ao recalcular:', error);
                showErrorMessage('Erro de comunicação com o servidor');
            });
        }

        // Função para mostrar mensagem de erro
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Função para fechar modal
        function closeModal() {
            const modal = document.querySelector('.edit-modal-overlay');
            if (modal) modal.remove();
        }

        // Função para mostrar mensagem de sucesso
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            successDiv.innerHTML = `<i class="fas fa-check"></i> ${message}`;
            document.body.appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }
    </script>
</body>
</html>
