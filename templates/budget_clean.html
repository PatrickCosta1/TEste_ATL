<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento - Sistema de Orçamentação</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='modern-clean.css') }}" rel="stylesheet">
    
    <style>
        /* Estilos para os modais de edição */
        .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .edit-modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .questionnaire-modal {
            max-width: 700px !important;
        }

        .edit-modal-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .edit-modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .edit-modal-footer {
            padding: 15px 20px;
            background: #f9fafb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Botões de editar nas seções */
        .edit-section-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: none;
            border-radius: 20px;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            z-index: 10;
            font-size: 14px;
        }

        .edit-section-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: rgba(59, 130, 246, 1);
        }

        /* Posicionamento relativo para seções editáveis */
        .client-info, .pool-summary-card, .ai-assistant-section {
            position: relative;
        }

        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* CSS específico para modal grande de configuração */
        .edit-modal.large {
            max-width: 800px;
            width: 95%;
        }

        .edit-modal-body.large-body {
            padding: 30px;
        }

        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #f1f5f9;
            border-radius: 10px;
            background: #f8fafc;
        }

        .config-section h4 {
            margin: 0 0 20px 0;
            color: #1e293b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Estilo melhorado para o botão 'Oferta' */
        .btn-offer {
            background: linear-gradient(135deg, #f97316, #f59e0b);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
            box-shadow: 0 6px 18px rgba(245, 158, 11, 0.18);
            font-size: 14px;
        }
        .btn-offer:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(245, 158, 11, 0.24);
        }
        .btn-offer[disabled] {
            opacity: 0.5;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        /* CSS Premium para Modal de Configuração */
        .edit-modal.premium {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid #e2e8f0;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .premium-header {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 25px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .header-text h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }

        .header-text p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            color: #cbd5e1;
            opacity: 0.8;
        }

        .premium-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .premium-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg) scale(1.1);
        }

        .premium-body {
            padding: 35px;
            background: linear-gradient(145deg, #f8fafc, #ffffff);
        }

        .premium-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .premium-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .section-title h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .premium-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .premium-field {
            margin-bottom: 20px;
        }

        .premium-field:last-child {
            margin-bottom: 0;
        }

        .premium-field label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 50px 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .input-unit {
            position: absolute;
            right: 16px;
            color: #6b7280;
            font-weight: 500;
            pointer-events: none;
        }

        .radio-group-premium {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .radio-option-premium {
            flex: 1;
            min-width: 120px;
            padding: 16px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
        }

        .radio-option-premium:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .radio-option-premium.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .radio-option-premium i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .radio-option-premium span {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .premium-footer {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            padding: 25px 35px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .premium-btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .premium-btn:hover {
            transform: translateY(-2px);
        }

        .premium-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .premium-btn.primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .premium-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsividade para o modal premium */
        @media (max-width: 768px) {
            .premium-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group-premium {
                grid-template-columns: 1fr 1fr;
            }
            
            .premium-body {
                padding: 20px;
            }
            
            .premium-section {
                padding: 20px;
            }
        }

        /* === MODAL MODERNO DE ADICIONAR PRODUTO === */
        .add-product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .add-product-modal.show {
            opacity: 1;
        }

        .add-product-modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 720px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #e2e8f0;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .add-product-modal.show .add-product-modal-content {
            transform: scale(1) translateY(0);
        }

        .add-product-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
        }

        .add-product-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .add-product-modal-header i {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
        }

        .add-product-modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(85vh - 180px);
        }

        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .family-card-modal {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .family-card-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }

        .family-card-modal:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .family-card-modal:hover::before {
            transform: scaleX(1);
        }

        .family-card-modal .family-icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.75rem;
        }

        .family-card-modal .family-title {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .family-card-modal .family-count {
            font-size: 0.875rem;
            color: #64748b;
        }

        .product-list-modal {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .product-item-modal {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1.25rem;
            /* Wrapper that contains an index (left) and the category columns (right) */
            .product-modal-wrapper {
                display: grid;
                grid-template-columns: 220px 1fr; /* sidebar + content */
                gap: 1rem;
                align-items: start;
                margin-top: 1rem;
            }

            /* Index / sidebar */
            .product-index {
                position: sticky;
                top: 80px;
                align-self: start;
                background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,250,0.85));
                border: 1px solid rgba(226,232,240,0.9);
                border-radius: 10px;
                padding: 12px;
                box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
                max-height: calc(85vh - 120px);
                overflow-y: auto;
            }

            .product-index h5 {
                margin: 0 0 8px 0;
                font-size: 0.95rem;
                color: #374151;
                font-weight: 700;
            }

            .product-index-list { display: flex; flex-direction: column; gap: 6px; }

            .product-index a {
                display: block;
                padding: 6px 8px;
                border-radius: 6px;
                color: #4b5563;
                text-decoration: none;
                font-size: 0.9rem;
                transition: background 0.12s ease, color 0.12s ease, transform 0.12s ease;
            }

            .product-index a:hover { background: #f8fafc; color: #111827; transform: translateX(4px); }
            .product-index a.active { background: linear-gradient(90deg,#7c3aed22,#a78bfa22); color: #5b21b6; font-weight:700; }

            /* Category columns area (right side) */
            .product-list-modal {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 1rem;
                max-height: calc(85vh - 220px);
                overflow-y: auto;
                padding: 0.5rem;
            }

        .product-info-modal {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .product-details-modal {
            flex: 1;
        }

        .product-name-modal {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .product-description-modal {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .product-price-modal {
            color: #059669;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .product-actions-modal {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 120px;
        }

        .product-action-btn {
            padding: 0.6rem 0.95rem;
            border: none;
            border-radius: 10px;
            font-size: 0.88rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.14s ease, box-shadow 0.14s ease, background 0.12s ease;
            will-change: transform, box-shadow;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Primary action (Incluir) */
        .product-action-btn.include {
            background: linear-gradient(90deg,#06b58a,#05906b);
            color: white;
        }

        .product-action-btn.include:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(16,185,129,0.12);
        }

        /* Optional */
        .product-action-btn.optional {
            background: linear-gradient(90deg,#f59e0b,#d97706);
            color: white;
        }

        .product-action-btn.optional:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(245,158,11,0.12);
        }

        /* Alternative */
        .product-action-btn.alternative {
            background: linear-gradient(90deg,#2563eb,#1e40af);
            color: white;
        }

        .product-action-btn.alternative:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(37,99,235,0.12);
        }

        .add-product-modal-footer {
            background: #f8fafc;
            padding: 1rem 1.5rem; /* slightly inward */
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .modal-back-btn, .modal-close-btn {
            padding: 0.65rem 1.05rem;
            border: 1px solid rgba(15,23,42,0.06);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s ease, background .12s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(6px);
        }

        .modal-back-btn {
            background: linear-gradient(90deg,#6b7280,#4b5563);
            color: #fff;
            box-shadow: 0 8px 20px rgba(75,85,99,0.06);
        }

        .modal-back-btn:hover {
            transform: translateY(-2px) scale(1.005);
            box-shadow: 0 6px 16px rgba(75,85,99,0.08);
            background: linear-gradient(90deg,#6f747a,#4b5563);
        }

        .modal-close-btn {
            background: linear-gradient(90deg,#ef4444,#dc2626);
            color: #fff;
            box-shadow: 0 6px 14px rgba(220,38,38,0.06);
        }

        .modal-close-btn:hover {
            transform: translateY(-2px) scale(1.005);
            /* remove very dark shadow to keep it light and soft */
            box-shadow: 0 6px 14px rgba(220,38,38,0.08);
            background: linear-gradient(90deg,#f16b6b,#ef6262);
        }

        .modal-back-btn:focus, .modal-close-btn:focus {
            outline: none;
            box-shadow: 0 0 0 6px rgba(11,102,204,0.08);
            transform: translateY(-2px);
        }

        /* More specific rule to ensure footer modal buttons keep their intended style
           even if other, less specific styles are present on the page. */
        .add-product-modal .add-product-modal-footer .modal-back-btn,
        .add-product-modal .add-product-modal-footer .modal-close-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.65rem 1.1rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 22px rgba(15,23,42,0.06);
            border: 1px solid rgba(0,0,0,0.03);
            transition: transform .16s cubic-bezier(.2,.9,.3,1), box-shadow .16s ease, background .12s ease;
        }

        /* Position adjustments: back button left, close button right, both a bit higher */
        /* Flex layout: back button left, close button right; stable when back button hidden */
        .add-product-modal .add-product-modal-footer > #modalBackButton {
            margin: 0;
            display: flex;
            align-items: center;
        }

        .add-product-modal .add-product-modal-footer > div:last-child {
            margin-left: auto; /* pushes close button to the right */
            display: flex;
            align-items: center;
        }

        /* Safety overrides: force close button to the right and ensure hover styles are applied */
        .add-product-modal .add-product-modal-footer .modal-close-btn {
            margin-left: auto !important;
            cursor: pointer !important;
            z-index: 40 !important;
        }

        .add-product-modal .add-product-modal-footer .modal-back-btn {
            margin-right: 12px !important;
        }

        .add-product-modal .add-product-modal-footer .modal-close-btn:hover {
            transform: translateY(-8px) scale(1.03) !important;
            box-shadow: 0 18px 44px rgba(220,38,38,0.22) !important;
            background: linear-gradient(90deg,#ff6b6b,#ef4444) !important;
        }

        .add-product-modal .add-product-modal-footer .modal-back-btn { background: linear-gradient(90deg,#6b7280,#4b5563); color: #fff; }
        .add-product-modal .add-product-modal-footer .modal-back-btn:hover { transform: translateY(-8px); box-shadow: 0 12px 28px rgba(75,85,99,0.14); }

        .add-product-modal .add-product-modal-footer .modal-close-btn { background: linear-gradient(90deg,#ef4444,#dc2626); color: #fff; }
        .add-product-modal .add-product-modal-footer .modal-close-btn:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 14px 36px rgba(220,38,38,0.18);
            background: linear-gradient(90deg,#ff6b6b,#ef4444);
        }

        @media (max-width: 768px) {
            .add-product-modal-content {
                width: 95%;
                margin: 1rem;
            }

            .family-grid {
                grid-template-columns: 1fr;
            }

            .product-info-modal {
                flex-direction: column;
                gap: 1rem;
            }

            .product-actions-modal {
                flex-direction: row;
                min-width: auto;
            }

            .add-product-modal-footer {
                flex-direction: column-reverse;
                gap: 1rem;
            }

            .modal-back-btn, .modal-close-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* CSS para modal de seleção de produtos alternativos */
        .alternative-modal {
            max-width: 600px;
        }

        .modal-description {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .products-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }

        .product-option {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .product-option:last-child {
            border-bottom: none;
        }

        .product-option:hover {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            transform: translateX(5px);
            border-left: 4px solid #3b82f6;
        }

        .product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .product-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .product-family {
            font-size: 0.85rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            width: fit-content;
        }

        .product-price {
            font-weight: 600;
            color: #059669;
            font-size: 1rem;
            margin-right: 15px;
        }

        .product-option i.fa-chevron-right {
            color: #9ca3af;
            transition: all 0.3s ease;
        }

        .product-option:hover i.fa-chevron-right {
            color: #3b82f6;
            transform: translateX(3px);
        }

        /* Scrollbar customizada para lista de produtos */
        .products-list::-webkit-scrollbar {
            width: 6px;
        }

        .products-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .products-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .products-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-swimming-pool"></i>
                    </div>
                    <span>Sistema de Orçamentação</span>
                </a>
                
                <nav class="nav-steps">
                    <div class="step-indicator completed">
                        <div class="step-number">✓</div>
                        <span>Dados do Cliente</span>
                    </div>
                    <div class="step-indicator completed">
                        <div class="step-number">✓</div>
                        <span>Questionário</span>
                    </div>
                    <div class="step-indicator active">
                        <div class="step-number">3</div>
                        <span>Orçamento</span>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Cabeçalho do Orçamento -->
            <div class="card fade-in">
                <div class="budget-summary">
                    <div class="client-info">
                        <button class="edit-section-btn" onclick="editClientInfo()" title="Editar dados do cliente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <h1 class="client-name">
                            <i class="fas fa-user"></i>
                            {{ budget.get('client_data', {}).get('clientName', 'Cliente') }}
                        </h1>
                        <div class="proposal-details">
                            <span class="proposal-number">
                                <i class="fas fa-hashtag"></i>
                                {{ budget.get('client_data', {}).get('proposalNumber', 'Proposta') }}
                            </span>
                            <span class="date">
                                <i class="fas fa-calendar"></i>
                                {{ budget.get('client_data', {}).get('date', '') }}
                            </span>
                            {% if budget.get('client_data', {}).get('localidade') %}
                            <span class="localidade">
                                <i class="fas fa-map-marker-alt"></i>
                                {% if budget.get('client_data', {}).get('localidade') == 'Outro' %}
                                    {{ budget.get('client_data', {}).get('localidade_outro', 'Localidade não especificada') }}
                                {% else %}
                                    {{ budget.get('client_data', {}).get('localidade') }}
                                {% endif %}
                            </span>
                            {% endif %}
                            {% if budget.get('client_data', {}).get('commercialName') %}
                            <span class="commercial-name">
                                <i class="fas fa-user-tie"></i>
                                {{ budget.get('client_data', {}).get('commercialName') }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="total-display">
                        <div class="total-label">Total do Orçamento (c/ IVA)</div>
                        <div class="total-amount">€{{ "%.2f"|format(budget.get('total_with_iva', budget.get('total_price', 0))) }}</div>
                        <div class="total-breakdown">
                            <span class="total-before-iva">S/ IVA: €{{ "%.2f"|format(budget.get('subtotal_with_margin', budget.get('total_price', 0))) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Separador para Especificações -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-swimming-pool"></i>
                        <span>Especificações da Piscina</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- Especificações da Piscina -->
            <div class="card slide-up">
                <div class="grid grid-4">
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-ruler-combined"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Dimensões</div>
                            <div class="spec-value">
                                {{ budget.pool_info.get('dimensions', {}).get('comprimento', budget.pool_info.get('comprimento', '0')) }}m × 
                                {{ budget.pool_info.get('dimensions', {}).get('largura', budget.pool_info.get('largura', '0')) }}m
                            </div>
                        </div>
                    </div>
                    
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-arrows-alt-v"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Profundidade</div>
                            <div class="spec-value">
                                {{ budget.pool_info.get('dimensions', {}).get('prof_min', budget.pool_info.get('prof_min', '0')) }}m - 
                                {{ budget.pool_info.get('dimensions', {}).get('prof_max', budget.pool_info.get('prof_max', '0')) }}m
                            </div>
                        </div>
                    </div>
                    
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-tint"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Volume</div>
                            <div class="spec-value">{{ budget.pool_info.get('metrics', {}).get('volume', budget.pool_info.get('volume', '0')) }} m³</div>
                        </div>
                    </div>
                    
                    <div class="spec-card">
                        <div class="spec-icon"><i class="fas fa-filter"></i></div>
                        <div class="spec-content">
                            <div class="spec-label">Filtração</div>
                            <div class="spec-value">{{ budget.pool_info.get('metrics', {}).get('m3_h', budget.pool_info.get('m3_h', '0')) }} m³/h</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Separador para Dashboard Técnico -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard Técnico</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- DASHBOARD PREMIUM - MÉTRICAS E RESUMO EXECUTIVO -->
            <div class="card slide-up ai-assistant-section" style="animation-delay: 0.2s;">
                <button class="edit-section-btn" onclick="editProjectConfiguration()" title="Editar configuração do projeto">
                    <i class="fas fa-cogs"></i>
                </button>
                <!-- Header Corporativo -->
                <div class="metrics-header-premium">
                    <div class="header-title">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Dashboard
                            <span class="subtitle-modern">Análise Técnica</span>
                            <div class="ai-badge">
                                <i class="fas fa-microchip"></i>
                                <span>Smart</span>
                            </div>
                        </h3>
                    </div>
                    <div class="key-metrics-bar">
                        <div class="key-metric">
                            <i class="fas fa-cube"></i>
                            <span class="value">{{ budget.pool_info.get('metrics', {}).get('volume', budget.pool_info.get('volume', '0')) }}m³</span>
                            <span class="label">Volume</span>
                        </div>
                        <div class="key-metric">
                            <i class="fas fa-water"></i>
                            <span class="value">{{ budget.pool_info.get('metrics', {}).get('m3_h', budget.pool_info.get('m3_h', '0')) }}m³/h</span>
                            <span class="label">Filtração</span>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Corporativo - Layout Lado a Lado -->
                <div class="dashboard-compact-ai">
                    <div class="ai-grid-compact">
                        <!-- Seção 1: Especificações Técnicas -->
                        <div class="ai-section">
                            <div class="section-header-ai">
                                <div class="ai-badge-wrapper">
                                    <i class="fas fa-brain ai-brain-icon"></i>
                                    <span class="ai-badge">Smart</span>
                                </div>
                                <span>Especificações Técnicas</span>
                            </div>
                                <div class="ai-items">
                                    <div class="ai-item">
                                        <span class="label">Dimensões</span>
                                        <span class="value value-dimensions">{{ budget.pool_info.get('dimensions', {}).get('comprimento', budget.pool_info.get('comprimento', '0')) }}×{{ budget.pool_info.get('dimensions', {}).get('largura', budget.pool_info.get('largura', '0')) }}m</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Profundidade</span>
                                        <span class="value value-depth">{{ budget.pool_info.get('dimensions', {}).get('prof_min', budget.pool_info.get('prof_min', '0')) }}-{{ budget.pool_info.get('dimensions', {}).get('prof_max', budget.pool_info.get('prof_max', '0')) }}m</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Volume Total</span>
                                        <span class="value value-volume">{{ budget.pool_info.get('metrics', {}).get('volume', budget.pool_info.get('volume', '0')) }}m³</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Taxa de Filtração</span>
                                        <span class="value value-flow">{{ budget.pool_info.get('metrics', {}).get('m3_h', budget.pool_info.get('m3_h', '0')) }}m³/h</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">m³ Massa</span>
                                        <span class="value value-concrete">{{ budget.pool_info.get('metrics', {}).get('m3_massa', budget.pool_info.get('m3_massa', 'N/A')) | default('N/A') }}m³</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">m² Fundo</span>
                                        <span class="value value-area">{{ budget.pool_info.get('metrics', {}).get('m2_fundo', budget.pool_info.get('m2_fundo', 'N/A')) | default('N/A') }}m²</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">m² Paredes</span>
                                        <span class="value value-area">{{ budget.pool_info.get('metrics', {}).get('m2_paredes', budget.pool_info.get('m2_paredes', 'N/A')) | default('N/A') }}m²</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Rolos Tela</span>
                                        <span class="value value-count">{{ budget.pool_info.get('metrics', {}).get('rolos_tl', budget.pool_info.get('rolos_tl', '0')) }} <span class="unit">un</span></span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Rolos 3D</span>
                                        <span class="value value-count">{{ budget.pool_info.get('metrics', {}).get('rolos_3d', budget.pool_info.get('rolos_3d', '0')) }} <span class="unit">un</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Seção 2: Configuração do Projeto -->
                            <div class="ai-section">
                                <div class="section-header-ai">
                                    <i class="fas fa-cog"></i>
                                    <span>Configuração do Projeto</span>
                                </div>
                                <div class="ai-items">
                                    <div class="ai-item">
                                        <span class="label">Tipo de Piscina</span>
                                        <span class="value smart-badge value-pool-type">
                                            {% if budget.pool_info.get('answers', {}).get('tipo_piscina', budget.pool_info.get('tipo_piscina', '')) == 'skimmer' %}Skimmer
                                            {% elif budget.pool_info.get('answers', {}).get('tipo_piscina', budget.pool_info.get('tipo_piscina', '')) == 'espelho_dagua' %}Espelho d'Água
                                            {% elif budget.pool_info.get('answers', {}).get('tipo_piscina', budget.pool_info.get('tipo_piscina', '')) == 'transbordo' %}Transbordo
                                            {% else %}Standard{% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Forma</span>
                                        <span class="value value-shape">{{ budget.pool_info.get('answers', {}).get('forma', budget.pool_info.get('forma', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Revestimento</span>
                                        <span class="value value-coating">{{ budget.pool_info.get('answers', {}).get('revestimento', budget.pool_info.get('revestimento', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Acesso ao Local</span>
                                        <span class="value value-access">{{ budget.pool_info.get('answers', {}).get('acesso', budget.pool_info.get('acesso', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Escavação</span>
                                        <span class="value value-excavation {{ 'ai-active' if budget.pool_info.get('answers', {}).get('escavacao', budget.pool_info.get('escavacao', 'false')) == 'true' else 'ai-inactive' }}">
                                            {{ 'Incluída' if budget.pool_info.get('answers', {}).get('escavacao', budget.pool_info.get('escavacao', 'false')) == 'true' else 'Não' }}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Localização</span>
                                        <span class="value value-location">{{ budget.pool_info.get('answers', {}).get('localizacao', budget.pool_info.get('localizacao', 'Standard')) | default('Standard') | title }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Sistema Domótico</span>
                                        <span class="value value-domotics {{ 'ai-active' if budget.pool_info.get('answers', {}).get('domotica', budget.pool_info.get('domotica', 'false')) == 'true' else 'ai-inactive' }}">
                                            {{ 'Sim' if budget.pool_info.get('answers', {}).get('domotica', budget.pool_info.get('domotica', 'false')) == 'true' else 'Não' }}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Alimentação Elétrica</span>
                                        <span class="value value-power power-type">
                                            {% if budget.pool_info.get('answers', {}).get('luz', budget.pool_info.get('luz', 'monofasica')) == 'trifasica' %}Trifásica{% else %}Monofásica{% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Tratamento de Água</span>
                                        <span class="value value-treatment ai-item" style="padding: 3px 8px; border-radius:4px;border-left:3px solid blue;background:rgba(0, 123, 255, 0.1);">
                                            {% set tratamento = budget.pool_info.get('answers', {}).get('tratamento_agua', budget.pool_info.get('tratamento_agua', 'cloro_manual')) %}
                                            {% if tratamento == 'cloro_manual' %}Cloro Manual
                                            {% elif tratamento == 'cloro_automatico' %}Cloro Automático
                                            {% elif tratamento == 'clorador_salino' %}Clorador Salino
                                            {% elif tratamento == 'clorador_salino_ph' %}Clorador Salino + pH
                                            {% elif tratamento == 'clorador_salino_ph_uv' %}Clorador Salino + pH + UV
                                            {% elif tratamento == 'nao' %}Não Incluído
                                            {% else %}Cloro Manual{% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Tipo de Construção</span>
                                        <span class="value value-construction" style="padding: 3px 8px; border-radius:4px;border-left:3px solid orange;background:rgba(216, 95, 15, 0.1);">
                                            {% set tipo_construcao = budget.pool_info.get('answers', {}).get('tipo_construcao', budget.pool_info.get('tipo_construcao', 'nova')) %}
                                            {{ 'Nova' if tipo_construcao == 'nova' else 'Remodelação' }}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label" >Cobertura</span>
                                        <span class="value value-coverage" style="padding: 3px 8px; border-radius:4px;border-left:3px solid rgba(12, 181, 223, 1);background:rgba(12, 181, 223, 0.25);">
                                            {% set cobertura = budget.pool_info.get('answers', {}).get('cobertura', budget.pool_info.get('cobertura', 'nao')) %}
                                            {% if cobertura == 'laminas' %}Cobertura de Lâminas
                                            {% elif cobertura == 'bolhas' %}Cobertura de Bolhas
                                            {% elif cobertura == 'barras' %}Cobertura de Barras
                                            {% elif cobertura == 'lona' %}Cobertura de Lona
                                            {% elif cobertura == 'nao' %}Sem Cobertura
                                            {% else %}Sem Cobertura{% endif %}
                                            {% if cobertura == 'laminas' %}
                                                {% set tipo_laminas = budget.pool_info.get('answers', {}).get('tipo_cobertura_laminas', '') %}
                                                {% if tipo_laminas == 'submersa_praia' %} (Submersa na Praia)
                                                {% elif tipo_laminas == 'fora_praia' %} (Fora da Praia)
                                                {% elif tipo_laminas == 'elevada' %} (Elevada)
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Casa das Máquinas</span>
                                        <span class="value value-machine-room {{ 'ai-active' if budget.pool_info.get('answers', {}).get('casa_maquinas_abaixo', budget.pool_info.get('casa_maquinas_abaixo', 'nao')) == 'sim' else 'ai-inactive' }}" style="padding: 3px 8px; border-radius:4px;border-left:3px solid rgba(191, 223, 12, 1);background:rgba(183, 207, 46, 0.25);">
                                            {% if budget.pool_info.get('answers', {}).get('casa_maquinas_abaixo', budget.pool_info.get('casa_maquinas_abaixo', 'nao')) == 'sim' %}
                                                Abaixo do nível da água
                                            {% else %}
                                                Acima do nível da água
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Observações Casa das Máquinas</span>
                                        <span class="value value-machine-desc" style="margin-left:5px; padding: 3px 8px; border-radius:4px;border-left:3px solid rgba(214, 27, 205, 1);background:rgba(214, 27, 205, 0.1);">{{ budget.pool_info.get('answers', {}).get('casa_maquinas_desc', budget.pool_info.get('casa_maquinas_desc', '')) }}</span>
                                    </div>
                                    <div class="ai-item">
                                        <span class="label">Tipo de Luzes</span>
                                        <span class="value value-light-type" style="padding: 3px 8px; border-radius:4px;border-left:3px solid rgba(149, 40, 238, 1);background:rgba(149, 40, 238, 0.1);">
                                            {% set tipo_luzes = budget.pool_info.get('answers', {}).get('tipo_luzes', budget.pool_info.get('tipo_luzes', 'branco_frio')) %}
                                            {% if tipo_luzes == 'branco_frio' %}Branco Frio
                                            {% elif tipo_luzes == 'branco_adaptavel' %}Branco Adaptável
                                            {% elif tipo_luzes == 'rgb' %}RGB
                                            {% else %}{{ tipo_luzes }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Corporativo -->
                        <div class="ai-footer">
                            <div class="ai-signature">
                                <i class="fas fa-certificate"></i>
                                <span>• Cálculos certificados •</span>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Separador para Análise de Complexidade -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-analytics"></i>
                        <span>Análise de Complexidade</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- Análise de Complexidade - DESIGN PREMIUM MODERNO -->
            <div class="complexity-card-premium slide-up" style="animation-delay: 0.3s;">
                <!-- Dashboard Principal -->
                <div class="complexity-dashboard">
                    <!-- Indicador Principal -->
                    <div class="complexity-main-indicator">
                        <div class="multiplier-gauge">
                            <div class="gauge-background">
                                <div class="gauge-fill" style="width: {{ ((budget.pool_info.get('multiplier', 1) - 1) * 100) if budget.pool_info.get('multiplier', 1) > 1 else 0 }}%"></div>
                            </div>
                            <div class="multiplier-info">
                                <span class="multiplier-number">{{ "%.3f"|format(budget.pool_info.get('multiplier', 1)) }}×</span>
                                <span class="multiplier-text">Multiplicador Final</span>
                            </div>
                        </div>
                        
                        <div class="complexity-status">
                            {% if budget.pool_info.get('multiplier', 1) <= 1.15 %}
                                <div class="status-indicator status-low">
                                    <i class="fas fa-check-circle"></i>
                                    <span class="status-title">Complexidade Reduzida</span>
                                </div>
                                <p class="status-description">Projecto com condições ideais de execução. Terreno acessível e instalações convencionais.</p>
                            {% elif budget.pool_info.get('multiplier', 1) <= 1.35 %}
                                <div class="status-indicator status-medium">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span class="status-title">Complexidade Intermédia</span>
                                </div>
                                <p class="status-description">Projecto que requer análise técnica específica devido a factores particulares.</p>
                            {% else %}
                                <div class="status-indicator status-high">
                                    <i class="fas fa-cog"></i>
                                    <span class="status-title">Complexidade Elevada</span>
                                </div>
                                <p class="status-description">Projecto de alta complexidade técnica que requer engenharia especializada.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Fatores de Complexidade -->
                    <div class="factors-analysis-modern">
                        <h3 class="factors-title">
                            <i class="fas fa-chart-pie"></i>
                            Breakdown dos Fatores
                        </h3>
                        <div class="factors-grid-modern">
                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper geometric">
                                    <i class="fas fa-shapes"></i>
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Geométrico</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('geometrico', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill geometric" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('geometrico', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('geometrico', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Forma e dimensões da piscina</span>
                                </div>
                            </div>

                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper access">
                                    <i class="fas fa-truck-loading"></i>
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Acesso</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('acesso', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill access" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('acesso', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('acesso', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Acessibilidade do local</span>
                                </div>
                            </div>

                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper tech">
                                    <i class="fas fa-microchip"></i>
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Tecnológico</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('tecnologico', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill tech" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('tecnologico', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('tecnologico', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Automação e acabamentos</span>
                                </div>
                            </div>

                            <div class="factor-card-modern">
                                <div class="factor-icon-wrapper market">
                                    📈
                                </div>
                                <div class="factor-content">
                                    <div class="factor-header">
                                        <span class="factor-name">Mercado 2025</span>
                                        <span class="factor-multiplier">{{ "%.3f"|format(budget.pool_info.get('multiplier_breakdown', {}).get('mercado', 1)) }}×</span>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-bar-fill market" style="width: {{ ((budget.pool_info.get('multiplier_breakdown', {}).get('mercado', 1) - 1) * 100) if budget.pool_info.get('multiplier_breakdown', {}).get('mercado', 1) > 1 else 0 }}%"></div>
                                    </div>
                                    <span class="factor-impact">Condições do mercado</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Separador Elegante para Início do Orçamento -->
            <div class="budget-divider">
                <div class="budget-divider-content">
                    <div class="budget-divider-line"></div>
                    <div class="budget-divider-text">
                        <i class="fas fa-list-alt"></i>
                        <span>Detalhamento do Orçamento</span>
                    </div>
                    <div class="budget-divider-line"></div>
                </div>
                <div class="budget-divider-subtitle">
                    Produtos e serviços incluídos na sua proposta
                </div>
            </div>

            <!-- Produtos por Família - DESIGN COMPACTO -->
            {% set family_order = ['filtracao', 'recirculacao_iluminacao', 'tratamento_agua', 'revestimento', 'aquecimento', 'construcao', 'construcao_laje'] %}
            {% for family_name in family_order %}
            {% if family_name in budget.get('families', {}) %}
            {% set family_products = budget.get('families', {})[family_name] %}
            {# Check if this family has any displayable products #}
            {% set displayable_products = [] %}
            {% for product_id, product in family_products.items() %}
                {% if product.quantity > 0 or product.item_type == 'alternativo' or product.item_type == 'opcional' %}
                    {% set _ = displayable_products.append(product) %}
                {% endif %}
            {% endfor %}
            
            {% if displayable_products|length > 0 %}
            <div class="family-card-compact slide-up" style="animation-delay: 0.{{ loop.index + 2 }}s;">
                <!-- Cabeçalho Compacto -->
                <div class="family-header-compact" onclick="toggleFamily('{{ family_name }}')">
                    <div class="family-title-compact">
                        <i class="fas 
                            {% if family_name == 'piscinas' %}fa-swimming-pool
                            {% elif family_name == 'filtracao' %}fa-filter
                            {% elif family_name == 'aquecimento' %}fa-thermometer-half
                            {% elif family_name == 'dosagem' %}fa-flask
                            {% elif family_name == 'iluminacao' %}fa-lightbulb
                            {% elif family_name == 'automacao' %}fa-robot
                            {% elif family_name == 'acessorios' %}fa-wrench
                            {% elif family_name == 'recirculacao_iluminacao' %}fa-water
                            {% elif family_name == 'construcao' %}fa-hammer
                            {% elif family_name == 'construcao_laje' %}fa-layer-group
                            {% else %}fa-cog{% endif %}"></i>
                        {{ family_name|family_display_name }}
                    </div>
                    <div class="family-summary-compact">
                        <span class="item-count-compact">{{ family_products|length }}</span>
                        <span class="total-compact">{{ "%.2f"|format(budget.family_totals_base.get(family_name, 0)) }}€</span>
                        <i class="fas fa-chevron-down chevron-compact" id="chevron-{{ family_name }}"></i>
                    </div>
                </div>
                
                <!-- Lista Compacta de Produtos -->
                <div class="products-list-compact" id="products-{{ family_name }}">
                    {% set included_products = [] %}
                    {% set alternative_products = [] %}
                    {% set optional_products = [] %}
                    {% for product_id, product in family_products.items() %}
                        {% if product.quantity > 0 or product.item_type == 'alternativo' or product.item_type == 'opcional' %}
                            {% if product.item_type == 'incluido' %}
                                {% set _ = included_products.append((product_id, product)) %}
                            {% elif product.item_type == 'alternativo' %}
                                {% set _ = alternative_products.append((product_id, product)) %}
                            {% else %}
                                {% set _ = optional_products.append((product_id, product)) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    {# Criar lista organizada com alternativos agrupados após seus principais #}
                    {% set organized_products = [] %}
                    {% set appended_alts = [] %} {# track alternative ids already appended to avoid duplicates #}
                    
                    {# Primeiro, adicionar produtos incluídos com seus alternativos #}
                    {% for product_id, product in included_products %}
                        {% set _ = organized_products.append((product_id, product)) %}
                        {# Adicionar alternativos deste produto logo em seguida
                           Compatibilidade: 'alternative_to' pode ser a chave completa (ex: 'pump_01_13')
                           ou apenas o id numérico ('13'). Normalizar ambos os casos. #}
                        {% for alt_id, alt_product in alternative_products %}
                            {% set alt_target = alt_product.get('alternative_to') %}
                            {% set prod_real_id = product.get('id') %}
                            {% if alt_target == product_id or (alt_target is not none and (alt_target|string) == (prod_real_id|string)) %}
                                {% if alt_id not in appended_alts %}
                                    {% set _ = organized_products.append((alt_id, alt_product)) %}
                                    {% set _ = appended_alts.append(alt_id) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    
                    {# Adicionar alternativos órfãos (sem produto principal definido) - tratar tanto chaves completas quanto ids numéricos #}
                    {% for alt_id, alt_product in alternative_products %}
                        {% set alt_target = alt_product.get('alternative_to') %}
                        {% if alt_id not in appended_alts %}
                            {% if not alt_target %}
                                {% set _ = organized_products.append((alt_id, alt_product)) %}
                                {% set _ = appended_alts.append(alt_id) %}
                            {% else %}
                                {% set matched = false %}
                                {% for existing_id, existing_prod in family_products.items() %}
                                    {% if alt_target == existing_id or (existing_prod.get('id') is not none and (alt_target|string) == (existing_prod.get('id')|string)) %}
                                        {% set matched = true %}
                                    {% endif %}
                                {% endfor %}
                                {% if not matched %}
                                    {% set _ = organized_products.append((alt_id, alt_product)) %}
                                    {% set _ = appended_alts.append(alt_id) %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    {# Finalmente, adicionar produtos opcionais #}
                    {% for product_id, product in optional_products %}
                        {% set _ = organized_products.append((product_id, product)) %}
                    {% endfor %}
                    
                {% for product_id, product in organized_products %}
                <div class="product-row-compact-detailed {{ 'alternative-product alternative-indented' if product.item_type == 'alternativo' else 'optional-product' if product.item_type == 'opcional' else '' }} {{ 'pack-item' if product.get('is_pack_item', False) else '' }}" 
                    data-product-name="{{ product.name }}" 
                    data-alternative-to="{{ product.get('alternative_to', '') }}" 
                    data-product-id="{{ product_id }}">
                    {% set is_int_qty = (product.quantity == product.quantity|int) %}
                        <div class="product-info-left">
                            <span class="status-dot-compact {{ 'required' if product.item_type == 'incluido' else 'alternative' if product.item_type == 'alternativo' else 'optional' }}"></span>
                            <div class="product-name-section">
                                <div class="product-name-with-actions">
                                    <span class="product-name-compact">
                                        {% if product.get('editable_name', False) %}
                                        <span class="editable-name" contenteditable="true" 
                                              data-product-id="{{ product_id }}" 
                                              data-original-name="{{ product.name }}"
                                              onblur="updateProductName('{{ product_id }}', this.textContent)"
                                              title="Clique para editar o nome">{{ product.name }}</span>
                                        <i class="fas fa-edit edit-icon" title="Nome editável"></i>
                                        {% elif product.item_type == 'alternativo' %}
                                        ↳ {{ product.name.replace('Alternativa: ', '').replace(' (ALTERNATIVO)', '') }}
                                        {% else %}
                                        {{ product.name }}
                                        {% endif %}
                                        <!-- Botão para alternativas inline com o texto -->
                    {% if product.get('can_change_type', False) and product.item_type != 'alternativo' and family_name != 'construcao' %}
                    <button class="btn-alternative-inline" onclick="showAlternatives('{{ family_name }}', '{{ product_id }}')" 
                        title="Ver alternativas disponíveis">🔄</button>
                    {% endif %}
                                    </span>
                                </div>
                                <div class="product-specs">
                                    {% if product.get('editable_price', False) %}
                                    <span class="spec-price">
                                        <span class="editable-price" contenteditable="true" 
                                              data-product-id="{{ product_id }}"
                                              data-original-price="{{ product.price }}"
                                              onblur="updateProductPrice('{{ product_id }}', this.textContent)"
                                              title="Clique para editar o preço">{{ "%.2f"|format(product.price) }}</span>€/{{ product.get('unit', 'un') }}
                                        <i class="fas fa-edit edit-icon" title="Preço editável"></i>
                                    </span>
                                    {% else %}
                                    <span class="spec-price">{{ "%.2f"|format(product.price) }}€/{{ product.get('unit', 'un') }}</span>
                                    {% endif %}
                                    <span class="spec-qty">Qtd: {% if is_int_qty %}{{ product.quantity|int }}{% else %}{{ "%.2f"|format(product.quantity) }}{% endif %}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="product-controls-right">
                            {% if product.item_type == 'incluido' %}
                                <span class="price-total-compact">{{ "%.2f"|format(product.price * product.quantity) }}€</span>
                                <div class="qty-controls-compact">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', -1)">−</button>
                                    <input type="number" class="qty-input-compact" step="{% if is_int_qty %}1{% else %}0.01{% endif %}"
                                           id="qty_{{ product_id }}" 
                                           value="{% if is_int_qty %}{{ product.quantity|int }}{% else %}{{ "%.2f"|format(product.quantity) }}{% endif %}" 
                                           onchange="updateProductQuantity('{{ product_id }}', this.value)" min="0.01">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                <button class="btn-offer" title="Marcar como Oferta" onclick="setOffer('{{ family_name }}','{{ product_id }}')">
                                    <i class="fas fa-gift"></i>
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% elif product.item_type == 'alternativo' %}
                                <div style="text-align: right;">
                                    <span class="price-total-inactive">{{ "%.2f"|format(product.price * product.quantity if product.quantity > 0 else product.price) }}€</span>
                                    <div class="alternative-label">alternativa</div>
                                </div>
                                
                                <!-- Controles sempre visíveis para produtos alternativos -->
                                <div class="qty-controls-small">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', -1)">−</button>
                     <input type="number" class="qty-input-small" step="{% if is_int_qty %}1{% else %}0.01{% endif %}"
                         id="qty_{{ product_id }}" 
                         value="{% if is_int_qty %}{{ product.quantity|int }}{% else %}{{ "%.2f"|format(product.quantity) }}{% endif %}" 
                         onchange="updateProductQuantity('{{ product_id }}', this.value)" min="0">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                
                                <button class="btn-replace-alternative" 
                                        id="toggle_{{ product_id }}" 
                                        onclick="replaceProduct('{{ family_name }}', '{{ product_id }}')">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% elif product.item_type == 'opcional' %}
                                <div style="text-align: right;">
                                    <span class="price-total-inactive">{{ "%.2f"|format(product.price * product.quantity if product.quantity > 0 else product.price) }}€</span>
                                    <div class="optional-label">não incluso</div>
                                </div>
                                
                                <!-- Controles sempre visíveis para produtos opcionais -->
                                <div class="qty-controls-small">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', -1)">−</button>
                     <input type="number" class="qty-input-small" step="{% if is_int_qty %}1{% else %}0.01{% endif %}"
                         id="qty_{{ product_id }}" 
                         value="{% if is_int_qty %}{{ product.quantity|int }}{% else %}{{ "%.2f"|format(product.quantity) }}{% endif %}" 
                         onchange="updateProductQuantity('{{ product_id }}', this.value)" min="0">
                                    <button class="qty-btn-small" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                
                                <button class="btn-toggle-optional" 
                                        id="toggle_{{ product_id }}" 
                                        onclick="includeOptionalProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% elif product.get('was_optional') %}
                                <span class="price-total-compact">{{ "%.2f"|format(product.price * product.quantity) }}€</span>
                                <div class="qty-controls-compact">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', -1)">-</button>
                     <input type="number" class="qty-input-compact" step="{% if is_int_qty %}1{% else %}0.01{% endif %}"
                         id="qty_{{ product_id }}" 
                         value="{% if is_int_qty %}{{ product.quantity|int }}{% else %}{{ "%.2f"|format(product.quantity) }}{% endif %}" 
                         onchange="updateProductQuantity('{{ product_id }}', this.value)" min="0.01">
                                    <button class="qty-btn-compact" onclick="changeQuantity('{{ product_id }}', 1)">+</button>
                                </div>
                                <button class="btn-toggle-optional active" 
                                        id="toggle_{{ product_id }}" 
                                        onclick="toggleOptional('{{ product_id }}')">
                                    Remover
                                </button>
                                <button class="btn-remove-product" onclick="removeProduct('{{ product_id }}', '{{ family_name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endif %}
            {% endfor %}

            <!-- Resumo Financeiro - Design Compacto com IVA -->
            <div class="card slide-up financial-summary-compact">
                <div class="financial-header-compact">
                    <i class="fas fa-calculator financial-icon-compact"></i>
                    <h3 class="financial-title-compact">Resumo Financeiro</h3>
                </div>
                
                <div class="financial-content-compact">
                    <div class="financial-row">
                        <span class="financial-label">
                            <i class="fas fa-boxes"></i>
                            Equipamentos (Base)
                        </span>
                        <span class="financial-value">{{ "%.2f"|format(budget.subtotal_base|default(0)) }}€</span>
                    </div>
                    
                    <div class="financial-row multiplier-row">
                        <span class="financial-label">
                            <i class="fas fa-percentage"></i>
                            Margem <span class="multiplier-tag">{{ "%.1f"|format(budget.pool_info.multiplier|default(1.0)) }}x</span>
                        </span>
                        <span class="financial-value multiplier-amount">
                            +{{ "%.2f"|format((budget.subtotal_base|default(0)) * ((budget.pool_info.multiplier|default(1.0)) - 1.0)) }}€
                        </span>
                    </div>
                    
                    <div class="financial-row subtotal-row">
                        <span class="financial-label">
                            <i class="fas fa-equals"></i>
                            Subtotal (c/ Margem)
                        </span>
                        <span class="financial-value">{{ "%.2f"|format(budget.subtotal_with_margin_only|default(0)) }}€</span>
                    </div>
                    
                    {% if budget.pool_info.transport_costs and budget.pool_info.transport_costs.custo_total > 0 %}
                    <div class="financial-row transport-row">
                        <span class="financial-label">
                            <i class="fas fa-truck"></i>
                            Transporte de Areia
                            {% if budget.pool_info.transport_costs %}
                                <small class="transport-detail">({{ budget.pool_info.transport_costs.explicacao }})</small>
                            {% endif %}
                        </span>
                        <span class="financial-value transport-amount">
                            +{{ "%.2f"|format(budget.pool_info.transport_costs.custo_total) }}€
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="financial-row iva-row">
                        <span class="financial-label">
                            <i class="fas fa-receipt"></i>
                            IVA <span class="iva-tag">{{ "%.0f"|format((budget.iva_rate|default(0.23)) * 100) }}%</span>
                        </span>
                        <span class="financial-value iva-amount">
                            +{{ "%.2f"|format(budget.iva_amount|default(0)) }}€
                        </span>
                    </div>
                    
                    <div class="financial-separator"></div>
                    
                    <div class="financial-row total-row">
                        <span class="financial-label-total">
                            <i class="fas fa-euro-sign"></i>
                            Total do Orçamento (c/ IVA)
                        </span>
                        <span class="financial-value-total">{{ "%.2f"|format(budget.total_with_iva|default(0)) }}€</span>
                    </div>
                </div>
            </div>

            <!-- Explicação dos Custos de Transporte -->
            {% if budget.pool_info.transport_costs and budget.pool_info.transport_costs.custo_total > 0 %}
            <div class="transport-explanation-container slide-up">
                <div class="transport-explanation-card">
                    <div class="transport-explanation-header" onclick="toggleTransportDetails()">
                        <div class="transport-explanation-title">
                            <i class="fas fa-truck"></i>
                            <span>Detalhes dos Custos de Transporte</span>
                            <span class="transport-cost-total">+{{ "%.2f"|format(budget.pool_info.transport_costs.custo_total) }}€</span>
                        </div>
                        <i class="fas fa-chevron-down transport-toggle-icon" id="transport-toggle-icon"></i>
                    </div>
                    <div class="transport-explanation-content" id="transport-explanation-content" style="display: none;">
                        <div class="transport-explanation-body">
                            <div class="transport-explanation-info">
                                <h4>Custos de Transporte de Areia</h4>
                                <p class="transport-explanation-text">
                                    Devido às condições de acesso ao local da obra, foram aplicados custos específicos 
                                    para o transporte de materiais, especificamente para a areia necessária à construção.
                                </p>
                            </div>
                            
                            <div class="transport-breakdown">
                                <h5>Breakdown dos Custos:</h5>
                                {% for item in budget.pool_info.transport_costs.breakdown %}
                                <div class="transport-breakdown-item">
                                    <span class="transport-breakdown-desc">{{ item.descricao }}</span>
                                    <span class="transport-breakdown-calc">{{ item.calculo }}</span>
                                    <span class="transport-breakdown-value">{{ "%.2f"|format(item.valor) }}€</span>
                                </div>
                                {% endfor %}
                                <div class="transport-breakdown-total">
                                    <span class="transport-breakdown-desc"><strong>Total dos Custos de Transporte</strong></span>
                                    <span class="transport-breakdown-value"><strong>{{ "%.2f"|format(budget.pool_info.transport_costs.custo_total) }}€</strong></span>
                                </div>
                            </div>
                            
                            <div class="transport-levels-info">
                                <h5>Níveis de Acesso:</h5>
                                <div class="transport-level">
                                    <span class="transport-level-name">Acesso Fácil:</span>
                                    <span class="transport-level-desc">Sem custos adicionais</span>
                                </div>
                                <div class="transport-level">
                                    <span class="transport-level-name">Acesso Médio:</span>
                                    <span class="transport-level-desc">2.50€ por m³ + 125€ fixo</span>
                                </div>
                                <div class="transport-level">
                                    <span class="transport-level-name">Acesso Difícil:</span>
                                    <span class="transport-level-desc">10€ por m³ + 500€ fixo</span>
                                </div>
                            </div>
                            
                            <div class="transport-explanation-note">
                                <p><strong>Nível aplicado:</strong> {{ budget.pool_info.transport_costs.explicacao }}</p>
                                <p><strong>Volume de massa usado:</strong> {{ "%.2f"|format(budget.pool_info.transport_costs.m3_massa_usado) }} m³</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Separador para Adicionar Produtos -->
            <div class="section-divider">
                <div class="section-divider-content">
                    <div class="section-divider-line"></div>
                    <div class="section-divider-text">
                        <i class="fas fa-plus-circle"></i>
                        <span>Personalizar Orçamento</span>
                    </div>
                    <div class="section-divider-line"></div>
                </div>
            </div>

            <!-- Ações Rápidas - Posição Estratégica -->
            <div class="quick-actions-container slide-up">
                <div class="quick-action-card">
                    <div class="quick-action-content">
                        <div class="quick-action-info">
                            <i class="fas fa-plus-circle quick-action-icon"></i>
                            <div class="quick-action-text">
                                <h4 class="quick-action-title">Personalizar Orçamento</h4>
                                <p class="quick-action-subtitle">Adicione produtos adicionais das nossas famílias</p>
                            </div>
                        </div>
                        <button onclick="showAddProductModal()" class="quick-action-button">
                            <i class="fas fa-plus"></i>
                            Adicionar Produtos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Observações -->
            {% if budget.client_data and budget.client_data.observations %}
            <div class="card slide-up">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-sticky-note"></i>
                        Observações
                    </h3>
                </div>
                <div class="observations-content">
                    {{ budget.client_data.observations }}
                </div>
            </div>
            {% endif %}

            <!-- Ações -->
            <div class="card slide-up">
                <div class="actions-grid">
                    <button onclick="exportBudgetToPDF()" class="btn btn-primary btn-lg hover-lift">
                        <i class="fas fa-file-pdf"></i>
                        Exportar PDF
                    </button>
                    
                    <a href="/client_data" class="btn btn-primary btn-lg hover-lift">
                        <i class="fas fa-plus"></i>
                        Novo Orçamento
                    </a>
                </div>
            </div>

        </main>
    </div>

    <!-- CSS Específico para Orçamento -->
    <style>
        /* === CAIXAS PRINCIPAIS (SEPARADAS) === */
        .ai-metrics-card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(52, 152, 219, 0.08);
            margin-bottom: 24px;
            border: 1px solid rgba(52, 152, 219, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ai-metrics-card:hover {
            box-shadow: 0 12px 40px rgba(52, 152, 219, 0.12);
            transform: translateY(-2px);
        }

        .ai-metrics-panel {
            padding: 0;
        }

        /* Budget Header */
        .budget-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .client-name {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .proposal-details {
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
        }
        
        .total-display {
            text-align: right;
        }
        
        .total-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .total-amount {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        
        .total-breakdown {
            margin-top: 0.5rem;
        }
        
        .total-before-iva {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        /* Pool Specifications */
        .spec-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--surface-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
        }
        
        .spec-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .spec-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--text-white);
        }
        
        .spec-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .spec-value {
            font-family: var(--font-mono);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Family Sections */
        .family-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .family-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0;
        }
        
        .family-total {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Products List */
        .products-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            background: var(--surface-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
        }
        
        .product-item.included {
            border-left: 4px solid var(--success);
        }
        
        .product-item.optional {
            border-left: 4px solid var(--warning);
        }
        
        .product-item.offer {
            border-left: 4px solid var(--accent);
        }
        
        .product-item.pack-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(99, 102, 241, 0.05));
            border-left: 4px solid #3B82F6;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            margin-left: 32px;
            margin-top: 4px;
            margin-bottom: 4px;
            position: relative;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
            transition: all 0.2s ease;
        }
        
        .product-item.pack-item::before {
            content: '▶';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: #3B82F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .product-item.pack-item::after {
            content: '';
            position: absolute;
            left: -15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, transparent, #3B82F6, transparent);
        }
        
        .product-item.pack-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.08));
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .product-item.pack-item .product-name {
            font-size: 0.9em;
            color: #1E40AF;
            font-style: italic;
        }
        
        .product-item.pack-item .product-specs {
            opacity: 0.85;
        }
        
        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .product-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .product-details {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .product-reasoning {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .product-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .product-total {
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Observations */
        .observations-content {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        /* Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .budget-summary {
                flex-direction: column;
                text-align: center;
            }
            
            .total-display {
                text-align: center;
            }
            
            .product-item {
                flex-direction: column;
                gap: 1rem;
            }
            
            .product-right {
                text-align: left;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Print Styles */
        @media print {
            .header,
            .actions-grid {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card {
                background: white !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }
        }
        
        /* DESIGN COMPACTO PARA FAMÍLIAS DE PRODUTOS */
        .family-card-compact {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .family-header-compact {
            padding: 16px 20px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 4px 12px rgba(14, 165, 233, 0.15);
        }
        
        .family-header-compact:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #1e40af 100%);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.25),
                0 6px 20px rgba(14, 165, 233, 0.25);
            transform: translateY(-1px);
        }
        
        .family-title-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .family-title-compact i {
            font-size: 14px;
        }
        
        .family-summary-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }
        
        .item-count-compact {
            background: rgba(255, 255, 255, 0.25);
            color: #ffffff;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .total-compact {
            font-weight: 700;
            color: #ffffff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .chevron-compact {
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        
        .chevron-compact.rotated {
            transform: rotate(180deg);
        }
        
        .products-list-compact {
            background: #fafafa;
            border-top: 1px solid var(--border-color);
        }
        /* === LAYOUT COMPACTO E DETALHADO DOS PRODUTOS === */
        .product-row-compact-detailed {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 13px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 3px solid transparent;
            margin-bottom: 4px;
            border-radius: 8px;
            min-height: 50px;
            flex-wrap: nowrap;
        }
        
        .product-row-compact-detailed:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-left-color: var(--primary-color);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .product-info-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0;
            max-width: calc(100% - 300px);
        }
        
        .product-name-section {
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0;
            max-width: 100%;
            overflow: visible;
        }
        
        .product-name-with-actions {
            display: block;
            margin-bottom: 4px;
            width: 100%;
            max-width: 100%;
            overflow: visible;
        }
        
        .product-name-compact {
            font-weight: 600;
            color: var(--text-primary);
            display: inline-block;
            font-size: 14px;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .btn-alternative-inline {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin-left: 6px;
        }
        
        .btn-alternative-inline:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4);
        }
        
        .btn-alternative-inline:active {
            transform: translateY(0);
        }
        
        /* Indentação para itens alternativos */
        .alternative-indented {
            margin-left: 24px;
            border-left: 3px solid #8b5cf6 !important;
            position: relative;
        }
        
        .alternative-indented::before {
            content: "└";
            position: absolute;
            left: -15px;
            top: 12px;
            color: #8b5cf6;
            font-size: 14px;
            font-weight: bold;
        }
        
        .product-specs {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .spec-price {
            color: #3b82f6;
            font-size: 11px;
            font-weight: 500;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            /* Garantir que unidades não sejam forçadas para maiúsculas por estilos herdados */
            text-transform: lowercase;
        }
        
        .spec-qty {
            color: #059669;
            font-size: 11px;
            font-weight: 500;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Estilos para campos editáveis */
        .editable-name, .editable-price {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px dashed #f59e0b;
            border-radius: 4px;
            padding: 2px 4px;
            cursor: text;
            transition: all 0.3s ease;
        }

        .editable-name:hover, .editable-price:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
            border: 1px dashed #d97706;
        }

        .editable-name:focus, .editable-price:focus {
            outline: none;
            background: #ffffff;
            border: 2px solid #f59e0b;
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.3);
        }

        .edit-icon {
            font-size: 10px;
            color: #f59e0b;
            margin-left: 4px;
            opacity: 0.7;
        }

        .editable-name {
            font-weight: 600;
            min-width: 100px;
            display: inline-block;
        }

        .editable-price {
            font-weight: 500;
            min-width: 40px;
            display: inline-block;
        }
        
        .product-controls-right {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex-shrink: 0;
            min-width: 280px;
            margin-left: 20px;
            padding-top: 2px;
        }
        
        .price-total-compact {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: #16a34a;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #bbf7d0;
            text-align: center;
            min-width: 80px;
            opacity: 0.85;
        }
        
        .price-total-inactive {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 13px;
            color: #6b7280;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
            min-width: 80px;
            opacity: 0.7;
            font-style: italic;
        }
        
        /* Estilo especial para produtos alternativos - versão compacta e discreta */
        .product-row-compact-detailed.alternative-product {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 50%, #fafafa 100%); /* Cores bem mais sutis */
            border-left: 2px solid #a855f7; /* Borda mais fina e cor mais suave */
            box-shadow: 0 1px 4px rgba(168, 85, 247, 0.05); /* Sombra muito sutil */
            font-size: 13px; /* Tamanho menor */
            min-height: 45px; /* Altura menor */
            padding: 8px 12px; /* Padding menor */
        }
        
        .product-row-compact-detailed.alternative-product.alternative-indented {
            margin-left: 28px; /* Margem menor */
            border-left: 2px solid #a855f7; /* Borda mais fina */
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .product-row-compact-detailed.alternative-product.alternative-indented::before {
            content: "┗━";
            position: absolute;
            left: -16px; /* Posição ajustada */
            top: 50%;
            transform: translateY(-50%);
            color: #a855f7; /* Cor mais suave */
            font-size: 12px; /* Tamanho menor */
            font-weight: normal; /* Menos bold */
            opacity: 0.7; /* Mais transparente */
        }
        
        .product-row-compact-detailed.alternative-product:hover {
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 50%, #f0f0f0 100%); /* Hover mais sutil */
            box-shadow: 0 2px 6px rgba(168, 85, 247, 0.08); /* Sombra muito suave */
        }
        
        .product-row-compact-detailed.alternative-product .product-name-compact {
            color: #9333ea; /* Roxo mais suave */
            font-size: 12px; /* Texto menor */
            font-weight: 500; /* Menos bold */
        }
        
        .product-row-compact-detailed.alternative-product .spec-price {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            border: 1px solid rgba(168, 85, 247, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        .product-row-compact-detailed.alternative-product .spec-qty {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            border: 1px solid rgba(168, 85, 247, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        /* Responsividade para layout compacto */
        @media (max-width: 768px) {
            .product-row-compact-detailed {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                padding: 16px;
            }
            
            .product-info-left {
                margin-bottom: 8px;
                max-width: 100%;
                width: 100%;
            }
            
            .product-controls-right {
                justify-content: space-between;
                margin-left: 0;
                min-width: auto;
                align-items: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .product-specs {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Reduzir indentação em mobile */
            .alternative-indented {
                margin-left: 16px;
            }
            
            .product-row-compact-detailed.alternative-product.alternative-indented {
                margin-left: 20px;
            }
            
            .product-row-compact-detailed.alternative-product.alternative-indented::before {
                left: -16px;
                font-size: 14px;
            }
            
            /* Ajustes para produtos opcionais em mobile */
            .product-row-compact-detailed.optional-product::before {
                left: -10px;
                font-size: 10px;
            }
            
            .btn-toggle-optional {
                min-width: 70px;
                padding: 8px 14px;
                font-size: 10px;
            }
        }
        
        
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 13px;
            transition: all 0.3s ease;
            min-height: 65px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 3px solid transparent;
        }
        
        .product-row-compact:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-left-color: var(--primary-color);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .product-row-compact:last-child {
            border-bottom: none;
        }
        
        /* Estilo especial para produtos opcionais - visual de subtítulo */
        .product-row-compact.optional-product {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 50%, #fefce8 100%);
            margin-left: 16px;
            border-left: 4px solid #f59e0b;
            border-radius: 0 12px 12px 0;
            position: relative;
            box-shadow: 
                0 3px 12px rgba(245, 158, 11, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            min-height: 70px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            border-top: 1px solid rgba(245, 158, 11, 0.1);
        }
        
        .product-row-compact.optional-product::before {
            content: "▶";
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #d97706;
            font-weight: bold;
            font-size: 12px;
            background: linear-gradient(135deg, #ffffff, #fef3c7);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #f59e0b;
            box-shadow: 
                0 3px 8px rgba(245, 158, 11, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.optional-product:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
            transform: translateX(4px);
            box-shadow: 
                0 5px 20px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.optional-product .product-name-compact {
            color: #92400e;
            font-weight: 600;
        }
        
        .product-row-compact.optional-product .status-dot-compact {
            border: 2px solid #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }

        /* Estilo especial para produtos alternativos - roxo/violeta */
        .product-row-compact.alternative-product {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #f3e8ff 100%);
            margin-left: 16px;
            border-left: 4px solid #8b5cf6;
            border-radius: 0 12px 12px 0;
            position: relative;
            box-shadow: 
                0 3px 12px rgba(139, 92, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            min-height: 70px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .product-row-compact.alternative-product::before {
            content: "⟷";
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7c3aed;
            font-weight: bold;
            font-size: 12px;
            background: linear-gradient(135deg, #ffffff, #c4b5fd);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #8b5cf6;
            box-shadow: 
                0 3px 8px rgba(139, 92, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.alternative-product:hover {
            background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 50%, #c4b5fd 100%);
            transform: translateX(4px);
            box-shadow: 
                0 5px 20px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .product-row-compact.alternative-product .product-name-compact {
            color: #7c3aed;
            font-weight: 600;
        }
        
        .product-row-compact.alternative-product .status-dot-compact {
            border: 2px solid #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }
        
        .product-info-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 0;
        }
        
        .status-dot-compact {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .status-dot-compact.required {
            background: #28a745;
        }
        
        .status-dot-compact.optional {
            background: #ffc107;
        }

        .status-dot-compact.alternative {
            background: #14b8a6;
        }
        
        .product-name-compact {
            font-weight: 500;
            color: var(--text-primary);
            overflow: visible;
            text-overflow: clip;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.4;
            max-width: 100%;
        }
        
        .product-controls-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .price-compact {
            position: relative;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #f0fdf4 100%);
            color: #166534;
            font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            font-weight: 700;
            font-size: 14px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid #22c55e;
            box-shadow: 
                0 4px 12px rgba(34, 197, 94, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-align: center;
            min-width: 90px;
            letter-spacing: 0.3px;
            animation: priceShine 3s ease-in-out infinite alternate;
        }
        
        .price-compact::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(34, 197, 94, 0.1) 50%, rgba(34, 197, 94, 0.05) 100%);
            border-radius: 8px;
            pointer-events: none;
        }
        
        @keyframes priceShine {
            from { 
                box-shadow: 
                    0 4px 12px rgba(34, 197, 94, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
            }
            to { 
                box-shadow: 
                    0 6px 20px rgba(34, 197, 94, 0.25),
                    0 0 30px rgba(34, 197, 94, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
            }
        }
        
        .price-optional {
            position: relative;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fffbeb 100%);
            color: #d97706;
            font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            font-weight: 600;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #f59e0b;
            box-shadow: 
                0 3px 8px rgba(245, 158, 11, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            text-align: center;
            min-width: 80px;
            letter-spacing: 0.2px;
            opacity: 0.9;
        }
        
        .price-optional::before {
            content: 'OPCIONAL';
            position: absolute;
            top: -10px;
            right: -5px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .price-alternative {
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
            color: #6c757d;
            font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            font-weight: 500;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            box-shadow: 
                0 2px 4px rgba(108, 117, 125, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            text-align: center;
            min-width: 80px;
            letter-spacing: 0.2px;
            opacity: 0.7;
        }
        
        .price-alternative::before {
            content: 'ALTERNATIVO';
            position: absolute;
            top: -10px;
            right: -5px;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            font-size: 8px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .qty-controls-compact {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 8px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 6px 8px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 
                inset 0 1px 2px rgba(0, 0, 0, 0.05),
                0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .qty-btn-compact {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 4px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            flex-shrink: 0 !important;
        }

        .qty-btn-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .qty-btn-compact:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .qty-btn-compact:hover::before {
            left: 100%;
        }

        .qty-btn-compact:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 
                0 1px 3px rgba(59, 130, 246, 0.3),
                inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .qty-input-compact {
            min-width: 45px;
            width: auto;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px 4px;
            font-size: 14px;
            font-weight: 600;
            height: 28px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            display: inline-block !important;
            flex-shrink: 0 !important;
            vertical-align: middle !important;
        }
        
        .qty-input-compact:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.1),
                inset 0 1px 2px rgba(0, 0, 0, 0.05);
            background: #ffffff;
            transform: scale(1.05);
        }
        
        /* === CONTROLES PEQUENOS PARA OPCIONAIS E ALTERNATIVOS === */
        .qty-controls-small {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 4px;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            padding: 3px 6px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.04);
            transform: scale(0.85);
        }
        
        .qty-btn-small {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(107, 114, 128, 0.2);
        }
        
        .qty-btn-small:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-1px) scale(1.1);
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.3);
        }

        .qty-btn-small:active {
            transform: translateY(0) scale(0.95);
        }
        
        .qty-input-small {
            min-width: 28px;
            width: auto;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px;
            font-size: 11px;
            font-weight: 600;
            height: 20px;
            background: #ffffff;
            color: #374151;
            transition: all 0.2s ease;
            display: inline-block !important;
            flex-shrink: 0 !important;
        }
        
        .qty-input-small:focus {
            outline: none;
            border-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.1);
            transform: scale(1.05);
        }
        
        /* === BOTÕES PARA OPCIONAIS E ALTERNATIVOS === */
        .btn-toggle-optional {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-toggle-optional.active {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .btn-toggle-optional:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-toggle-optional.active:hover {
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .btn-replace-alternative {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-replace-alternative:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        /* === REMOVIDO: Estilos antigos de botões de alternativas === */
        
        .toggle-btn-compact {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
            color: #7c3aed;
            border: 2px solid #8b5cf6;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
            box-shadow: 
                0 4px 15px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        
        .toggle-btn-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .toggle-btn-compact:hover::before {
            left: 100%;
        }
        
        .toggle-btn-compact.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #ecfdf5 100%);
            color: #166534;
            border-color: #22c55e;
            box-shadow: 
                0 6px 20px rgba(34, 197, 94, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .toggle-btn-compact:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #f3e8ff 100%);
        }
        
        .toggle-btn-compact.active:hover {
            box-shadow: 
                0 8px 25px rgba(34, 197, 94, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 50%, #dcfce7 100%);
        }
        
        /* Estilo específico para botões de troca de alternativos */
        .btn-replace-alternative {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
            color: #059669;
            border: 2px solid #10b981;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
            box-shadow: 
                0 4px 15px rgba(16, 185, 129, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        
        .btn-replace-alternative::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .btn-replace-alternative:hover::before {
            left: 100%;
        }
        
        .btn-replace-alternative:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #ecfdf5 100%);
        }
        
        /* Label discreta para produtos alternativos */
        .alternative-label {
            font-size: 9px;
            color: #6b7280;
            text-transform: lowercase;
            font-style: italic;
            opacity: 0.7;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* Label discreta para produtos opcionais */
        .optional-label {
            font-size: 9px;
            color: #d97706;
            text-transform: lowercase;
            font-style: italic;
            opacity: 0.8;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(217, 119, 6, 0.2);
        }
        
        /* Estilo premium para botões de produtos opcionais */
        .btn-toggle-optional {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 50%, #ffffff 100%);
            color: #d97706;
            border: 2px solid #f59e0b;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 80px;
            box-shadow: 
                0 4px 15px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        
        .btn-toggle-optional::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(217, 119, 6, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .btn-toggle-optional:hover::before {
            left: 100%;
        }
        
        .btn-toggle-optional:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(245, 158, 11, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fef3c7 100%);
        }
        
        .btn-toggle-optional.active {
            background: linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #fef3c7 100%);
            color: #92400e;
            border-color: #d97706;
            box-shadow: 
                0 6px 20px rgba(217, 119, 6, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .btn-toggle-optional.active:hover {
            box-shadow: 
                0 8px 25px rgba(217, 119, 6, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fed7aa 100%);
        }
        
        /* Estilização premium para produtos opcionais */
        .product-row-compact-detailed.optional-product {
            border-left: 2px solid #f59e0b; /* Borda mais fina */
            background: linear-gradient(135deg, #fefefe 0%, #fafafa 2%, #ffffff 100%); /* Cores muito mais sutis */
            position: relative;
            transition: all 0.3s ease;
            font-size: 13px; /* Tamanho menor */
            min-height: 45px; /* Altura menor */
            padding: 8px 12px; /* Padding menor */
        }
        
        .product-row-compact-detailed.optional-product::before {
            content: "✨";
            position: absolute;
            left: -10px; /* Posição ajustada */
            top: 10px; /* Posição ajustada */
            color: #f59e0b;
            font-size: 10px; /* Tamanho menor */
            opacity: 0.5; /* Mais transparente */
        }
        
        .product-row-compact-detailed.optional-product:hover {
            border-left-color: #d97706;
            background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 5%, #ffffff 100%); /* Hover muito sutil */
            transform: translateX(1px); /* Movimento menor */
            box-shadow: 
                0 2px 8px rgba(245, 158, 11, 0.08), /* Sombra muito suave */
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .product-row-compact-detailed.optional-product .product-name-compact {
            color: #b45309; /* Cor mais suave */
            font-weight: 500; /* Menos bold */
            font-size: 12px; /* Texto menor */
        }
        
        .product-row-compact-detailed.optional-product .spec-price {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            color: #d97706; /* Cor um pouco mais suave */
            border: 1px solid rgba(245, 158, 11, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        .product-row-compact-detailed.optional-product .spec-qty {
            background: rgba(248, 248, 248, 0.8); /* Fundo muito sutil */
            color: #ea580c; /* Mantém a cor mas mais suave */
            border: 1px solid rgba(251, 146, 60, 0.1); /* Borda quase imperceptível */
            font-size: 11px; /* Texto menor */
        }
        
        .item-badge.optional {
            background-color: var(--warning-color);
            color: white;
        }
        
        .item-badge.offer {
            background-color: var(--info-color);
            color: white;
        }
        
        .product-reasoning {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        
        .product-unit-price {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .product-controls-section {
            display: flex;
            align-items: center;
            min-width: 200px;
        }
        
        .quantity-control-improved {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .qty-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .qty-btn:hover {
            background: var(--primary-color-dark);
            transform: scale(1.05);
        }
        
        .qty-input {
            width: 60px;
            height: 36px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .qty-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .unit-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .quantity-display {
            background: var(--background-secondary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }
        
        .quantity-text {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .product-actions-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .btn-switch-product {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-switch-product:hover {
            background: var(--warning-color-dark);
            transform: translateY(-1px);
        }

        .btn-remove-product {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 0.5rem;
        }
        
        .btn-remove-product:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .add-product-section {
            text-align: center;
            padding: 2rem;
        }
        
        .add-product-section p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .product-total-amount {
            text-align: right;
        }
        
        .total-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .total-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success-color);
        }
        
        .type-indicator {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: capitalize;
        }
        
        /* Responsivo */
        
        /* DASHBOARD PREMIUM - MÉTRICAS E RESUMO EXECUTIVO */
        .metrics-header-premium {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            border-radius: 12px 12px 0 0;
            padding: 24px 32px;
            color: white;
            margin-bottom: 0;
        }
        
        .header-title h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subtitle-modern {
            font-size: 0.85rem;
            font-weight: 400;
            opacity: 0.9;
            display: block;
            margin-top: 4px;
        }
        
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 12px;
            font-weight: 600;
        }
        
        .ai-badge i {
            font-size: 0.8rem;
        }
        
        .key-metrics-bar {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .key-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 80px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .key-metric i {
            font-size: 1.2rem;
            margin-bottom: 6px;
            opacity: 0.9;
        }
        
        .key-metric .value {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .key-metric .label {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .dashboard-compact-ai {
            padding: 24px;
        }
        
        .unified-panel {
            background: #fafbfc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .ai-assistant-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            border-radius: 8px;
            color: white;
            margin-bottom: 20px;
        }
        
        .assistant-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .assistant-info h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .assistant-info p {
            margin: 2px 0 0 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .ai-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .ai-grid-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .ai-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .section-header-ai {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            padding-bottom: 8px;
            border-bottom: 2px solid #0ea5e9;
        }
        
        .section-header-ai i {
            color: #0ea5e9;
        }
        
        .ai-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ai-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .ai-item:last-child {
            border-bottom: none;
        }
        
        .ai-item .label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .ai-item .value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .smart-badge {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .ai-active {
            color: #10b981;
            font-weight: 700;
        }
        
        .ai-inactive {
            color: #ef4444;
            font-weight: 700;
        }
        
        .power-type {
            color: #8b5cf6;
            font-weight: 700;
        }
        
        .ai-footer {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            text-align: center;
        }
        
        .ai-signature {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .ai-signature i {
            color: #10b981;
        }
        
        /* VALORES ESTILIZADOS MODERNOS */
        /* Especificações Técnicas - Cores por categoria */
        .value-dimensions {
            color: #0ea5e9;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(6, 182, 212, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #0ea5e9;
        }
        
        .value-depth {
            color: #0284c7;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(2, 132, 199, 0.1), rgba(3, 105, 161, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #0284c7;
        }
        
        .value-volume {
            color: #06b6d4;
            font-weight: 800;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(14, 165, 233, 0.15));
            padding: 4px 10px;
            border-radius: 6px;
            border: 2px solid rgba(6, 182, 212, 0.3);
            text-shadow: 0 1px 2px rgba(6, 182, 212, 0.3);
        }
        
        .value-flow {
            color: #0891b2;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.1), rgba(14, 116, 144, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #0891b2;
        }
        
        .value-concrete {
            color: #64748b;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.1), rgba(71, 85, 105, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #64748b;
        }
        
        .value-area {
            color: #22c55e;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(21, 128, 61, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #22c55e;
        }
        
        .value-count {
            color: #f59e0b;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #f59e0b;
        }
        
        .unit {
            font-size: 0.75em;
            opacity: 0.8;
            margin-left: 2px;
            
        }
        
        /* Configuração do Projeto - Cores por tipo */
        .value-pool-type {
            /* Já tem smart-badge styling */
        }
        
        .value-shape {
            color: #8b5cf6;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #8b5cf6;
        }
        
        .value-coating {
            color: #ec4899;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(219, 39, 119, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #ec4899;
        }
        
        .value-access {
            color: #f97316;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(234, 88, 12, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #f97316;
        }
        
        .value-excavation {
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .value-location {
            color: #84cc16;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(132, 204, 22, 0.1), rgba(101, 163, 13, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #84cc16;
        }
        
        .value-domotics {
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .value-power {
            font-weight: 700;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            padding: 3px 8px;
            border-radius: 4px;
            border-left: 3px solid #8b5cf6;
        }
        
        /* Estados Ativos/Inativos Melhorados */
        .ai-active {
            color: #059669;
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.15), rgba(6, 120, 85, 0.15));
            border-left: 3px solid #059669;
        }
        
        .ai-inactive {
            color: #dc2626;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(185, 28, 28, 0.1));
            border-left: 3px solid #dc2626;
        }
        
        /* Animações sutis nos valores */
        .ai-item .value {
            transition: all 0.2s ease;
        }
        
        .ai-item:hover .value {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .ai-grid-compact {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .ai-assistant-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .ai-status {
                margin-left: 0;
            }
        }
        
        .tech-specs-panel, .project-config-panel {
            background: #fafbfc;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #0ea5e9;
        }
        
        .panel-header i {
            font-size: 1.2rem;
            color: #0ea5e9;
        }
        
        .panel-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .spec-group {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }
        
        .group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
        }
        
        .group-header i {
            color: #22c55e;
            font-size: 1rem;
        }
        
        .spec-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }
        
        .spec-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .spec-value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .spec-value.highlight {
            color: #0ea5e9;
            font-weight: 700;
        }
        
        .config-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .config-section {
            background: white;
            border-radius: 8px;
            padding: 18px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .section-title i {
            color: #f59e0b;
            font-size: 1rem;
        }
        
        .config-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .config-key {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .config-value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-yes {
            color: #22c55e;
            font-weight: 700;
        }
        
        .status-no {
            color: #ef4444;
            font-weight: 700;
        }
        
        .electrical-type {
            color: #8b5cf6;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            .dashboard-dual-panel {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .key-metrics-bar {
                justify-content: center;
            }
            
            .key-metric {
                min-width: 70px;
                padding: 10px 12px;
            }
        }
        
        /* ANÁLISE DE COMPLEXIDADE - DESIGN PREMIUM MODERNO */
        .complexity-card-premium {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            box-shadow: 
                0 6px 25px rgba(14, 165, 233, 0.08),
                0 2px 12px rgba(0, 0, 0, 0.04);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid rgba(14, 165, 233, 0.1);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* === ESTILOS COMPACTOS PARA ANÁLISE DE COMPLEXIDADE === */
        .complexity-header-compact {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .complexity-title-compact {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .complexity-icon-mini {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .complexity-main-title-compact {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .complexity-subtitle-compact {
            font-size: 0.75rem;
            opacity: 0.8;
            margin: 2px 0 0 0;
        }

        .complexity-score-compact {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-circle-mini {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .score-value-mini {
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
        }

        .multiplier-mini {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fef3c7;
        }

        .complexity-factors-compact {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
            background: white;
        }

        .factor-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid;
        }

        .factor-mini.geometric { border-left-color: #10b981; }
        .factor-mini.access { border-left-color: #f59e0b; }
        .factor-mini.tech { border-left-color: #8b5cf6; }
        .factor-mini.market { border-left-color: #ef4444; }

        .factor-icon-mini {
            font-size: 0.9rem;
            width: 16px;
            display: flex;
            justify-content: center;
        }

        .factor-info-mini {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .factor-label {
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 500;
        }

        .factor-value {
            font-size: 0.85rem;
            color: #1e293b;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .complexity-factors-compact {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 12px;
            }
        }
        
        .complexity-header-premium {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            padding: 18px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .complexity-title-section {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .complexity-icon-wrapper {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .complexity-title-content h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .complexity-subtitle {
            margin: 2px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .complexity-score-display {
            text-align: center;
        }
        
        .score-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .score-value {
            font-size: 16px;
            font-weight: 800;
            line-height: 1;
        }
        
        .score-label {
            font-size: 9px;
            font-weight: 500;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        .complexity-dashboard {
            padding: 24px;
        }
        
        .complexity-main-indicator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 28px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 10px;
            border: 1px solid rgba(14, 165, 233, 0.1);
        }
        
        .multiplier-gauge {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .gauge-background {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
            border-radius: 6px;
            transition: width 2s ease-out;
            animation: gaugeGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes gaugeGlow {
            from { box-shadow: 0 0 5px rgba(34, 197, 94, 0.3); }
            to { box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
        }
        
        .multiplier-info {
            text-align: center;
        }
        
        .multiplier-number {
            display: block;
            font-size: 32px;
            font-weight: 800;
            color: #0369a1;
            line-height: 1;
        }
        
        .multiplier-text {
            display: block;
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .complexity-status {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .status-indicator i {
            font-size: 20px;
        }
        
        .status-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .status-low {
            color: #16a34a;
        }
        
        .status-medium {
            color: #ea580c;
        }
        
        .status-high {
            color: #dc2626;
        }
        
        .status-description {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
            margin: 0;
        }
        
        .factors-analysis-modern {
            margin-top: 20px;
        }
        
        .factors-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 18px;
        }
        
        .factors-title i {
            color: #0ea5e9;
        }
        
        .factors-grid-modern {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .factor-card-modern {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .factor-card-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        
        .factor-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }
        
        .factor-icon-wrapper.geometric {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .factor-icon-wrapper.access {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .factor-icon-wrapper.tech {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }
        
        .factor-icon-wrapper.market {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .factor-content {
            flex-grow: 1;
        }
        
        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .factor-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 13px;
        }
        
        .factor-multiplier {
            font-weight: 700;
            color: #0369a1;
            font-size: 12px;
            background: #f0f9ff;
            padding: 1px 6px;
            border-radius: 4px;
        }
        
        .factor-bar {
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        .factor-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1.5s ease-out;
        }
        
        .factor-bar-fill.geometric {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }
        
        .factor-bar-fill.access {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .factor-bar-fill.tech {
            background: linear-gradient(90deg, #06b6d4, #0891b2);
        }
        
        .factor-bar-fill.market {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .factor-impact {
            font-size: 11px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Responsividade da Análise de Complexidade */
        @media (max-width: 768px) {
            .complexity-main-indicator {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .factors-grid-modern {
                grid-template-columns: 1fr;
            }
            
            .complexity-header-premium {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .complexity-dashboard {
                padding: 20px;
            }
        }
        @media (max-width: 768px) {
            .family-header-improved {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .product-main-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .product-controls-section {
                min-width: auto;
                justify-content: center;
            }
            
            .product-actions-total {
                flex-direction: column;
                gap: 0.75rem;
            }
        }

        /* === SEPARADOR ELEGANTE PARA INÍCIO DO ORÇAMENTO === */
        .budget-divider {
            margin: 40px 0 30px 0;
            padding: 0 10px;
        }
        
        .budget-divider-content {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .budget-divider-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #3b82f6 20%, #1d4ed8 50%, #3b82f6 80%, transparent 100%);
            border-radius: 2px;
        }
        
        .budget-divider-text {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 30px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e40af;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: 0.5px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
            border: 2px solid #e0f2fe;
        }
        
        .budget-divider-text i {
            color: #3b82f6;
            font-size: 20px;
        }
        
        .budget-divider-subtitle {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            font-style: italic;
            margin-top: 8px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* === SEPARADORES DE SEÇÃO ELEGANTES COM CORES === */
        .section-divider {
            margin: 35px 0 25px 0;
            padding: 0 10px;
        }
        
        .section-divider-content {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .section-divider-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #10b981 20%, #059669 50%, #10b981 80%, transparent 100%);
            border-radius: 2px;
        }
        
        .section-divider-text {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            color: #065f46;
            font-weight: 600;
            font-size: 16px;
            letter-spacing: 0.3px;
            border-radius: 20px;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.15);
            border: 2px solid #d1fae5;
        }
        
        .section-divider-text i {
            color: #10b981;
            font-size: 18px;
        }

        /* Variações de cores para diferentes seções */
        .section-divider:nth-of-type(1) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #f59e0b 20%, #d97706 50%, #f59e0b 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(1) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
            color: #92400e;
            border-color: #fed7aa;
            box-shadow: 0 3px 12px rgba(245, 158, 11, 0.15);
        }
        
        .section-divider:nth-of-type(1) .section-divider-text i {
            color: #f59e0b;
        }

        .section-divider:nth-of-type(2) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #8b5cf6 20%, #7c3aed 50%, #8b5cf6 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(2) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%);
            color: #6b21a8;
            border-color: #e9d5ff;
            box-shadow: 0 3px 12px rgba(139, 92, 246, 0.15);
        }
        
        .section-divider:nth-of-type(2) .section-divider-text i {
            color: #8b5cf6;
        }

        .section-divider:nth-of-type(3) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #ef4444 20%, #dc2626 50%, #ef4444 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(3) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
            color: #991b1b;
            border-color: #fecaca;
            box-shadow: 0 3px 12px rgba(239, 68, 68, 0.15);
        }
        
        .section-divider:nth-of-type(3) .section-divider-text i {
            color: #ef4444;
        }

        .section-divider:nth-of-type(4) .section-divider-line {
            background: linear-gradient(90deg, transparent 0%, #06b6d4 20%, #0891b2 50%, #06b6d4 80%, transparent 100%);
        }
        
        .section-divider:nth-of-type(4) .section-divider-text {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            color: #0c4a6e;
            border-color: #bae6fd;
            box-shadow: 0 3px 12px rgba(6, 182, 212, 0.15);
        }
        
        .section-divider:nth-of-type(4) .section-divider-text i {
            color: #06b6d4;
        }
        
        @media (max-width: 768px) {
            .budget-divider-text {
                font-size: 16px;
                padding: 6px 20px;
                gap: 10px;
            }
            
            .budget-divider-text i {
                font-size: 18px;
            }
            
            .budget-divider-subtitle {
                font-size: 13px;
            }
            
            .section-divider-text {
                font-size: 14px;
                padding: 5px 20px;
                gap: 10px;
            }
            
            .section-divider-text i {
                font-size: 16px;
            }
        }

        /* === SEÇÃO DE TOTAIS === */
        .totals-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            margin-bottom: 2rem;
        }

        .totals-summary {
            padding: 1.5rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .total-row:last-child {
            border-bottom: none;
        }

        .subtotal-row .total-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .subtotal-row .total-value {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .multiplier-row {
            border-bottom: none;
            padding-bottom: 0.5rem;
        }

        .multiplier-row .total-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .total-multiplier {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .total-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            margin: 1rem 0;
        }

        .final-row {
            padding: 1rem 0 0.5rem 0;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .total-label-final {
            color: white;
            font-size: 1.2rem;
        }

        .total-value-final {
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .total-label i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        /* Responsivo para totais */
        @media (max-width: 768px) {
            .totals-summary {
                padding: 1rem;
            }
            
            .total-value-final {
                font-size: 1.3rem;
            }
            
            .total-label-final {
                font-size: 1.1rem;
            }
        }

        /* === RESUMO FINANCEIRO MODERNO === */
        /* === RESUMO FINANCEIRO COMPACTO === */
        .financial-summary-compact {
            background: white;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .financial-header-compact {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem 0.75rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .financial-icon-compact {
            color: #667eea;
            font-size: 1.1rem;
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .financial-title-compact {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .financial-content-compact {
            padding: 1rem 1.25rem 1.25rem 1.25rem;
        }

        .financial-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.95rem;
        }

        .financial-label {
            display: flex;
            align-items: center;
            color: #64748b;
            font-weight: 500;
        }

        .financial-label i {
            color: #94a3b8;
            font-size: 0.85rem;
            width: 16px;
            margin-right: 0.5rem;
        }

        .financial-value {
            font-weight: 600;
            color: #1a202c;
        }

        .multiplier-row {
            color: #059669;
        }

        .multiplier-row .financial-label {
            color: #059669;
        }

        .multiplier-row .financial-label i {
            color: #059669;
        }

        .multiplier-tag {
            background: #ecfdf5;
            color: #059669;
            padding: 0.125rem 0.375rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.375rem;
        }
        
        .iva-tag {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.375rem;
        }
        
        .iva-row {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 3px solid #059669;
            margin: 4px -8px;
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .iva-amount {
            color: #059669;
            font-weight: 700;
        }
        
        .subtotal-row {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-left: 3px solid #6b7280;
            margin: 4px -8px;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .multiplier-amount {
            color: #059669;
            font-weight: 600;
        }

        .financial-separator {
            height: 1px;
            background: linear-gradient(to right, transparent, #e2e8f0, transparent);
            margin: 0.75rem 0;
        }

        .total-row {
            background: #f8fafc;
            margin: 0 -1.25rem -1.25rem -1.25rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid #e2e8f0;
        }

        .financial-label-total {
            display: flex;
            align-items: center;
            color: #1a202c;
            font-weight: 700;
            font-size: 1rem;
        }

        .financial-label-total i {
            color: #667eea;
            font-size: 0.9rem;
            width: 16px;
            margin-right: 0.5rem;
        }

        .financial-value-total {
            font-weight: 700;
            font-size: 1.2rem;
            color: #667eea;
        }

        /* === ESTILOS PARA CUSTOS DE TRANSPORTE === */
        .transport-row {
            background: linear-gradient(135deg, #e0f7ff 0%, #b3f0ff 100%);
            border-left: 3px solid #0891b2;
            margin: 4px -8px;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .transport-row .financial-label {
            color: #0891b2;
        }

        .transport-row .financial-label i {
            color: #0891b2;
        }

        .transport-amount {
            color: #0891b2;
            font-weight: 700;
        }

        .transport-detail {
            display: block;
            font-size: 0.75rem;
            color: #0369a1;
            font-weight: 400;
            margin-top: 2px;
        }

        /* Estilos para a seção explicativa de transporte */
        .transport-explanation-container {
            margin: 1.5rem 0;
        }

        .transport-explanation-card {
            background: linear-gradient(135deg, #ffffff, #fafafa);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .transport-explanation-header {
            background: linear-gradient(135deg, #0ca9d3, #0bc93cd1);
            color: white;
            padding: 1rem 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s ease;
        }

        .transport-explanation-header:hover {
            background: linear-gradient(135deg, #0ca9d3, #0bc93cd1);
        }

        .transport-explanation-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .transport-explanation-title i {
            font-size: 1.1rem;
        }

        .transport-cost-total {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .transport-toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }

        .transport-explanation-content {
            padding: 1.5rem;
            border-top: 1px solid #f0f0f0;
        }

        .transport-explanation-info h4 {
            color: #424242;
            margin: 0 0 0.75rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .transport-explanation-text {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .transport-breakdown h5 {
            color: #0070ff;
            margin: 0 0 1rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .transport-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9rem;
        }

        .transport-breakdown-desc {
            flex: 1;
            color: #555;
        }

        .transport-breakdown-calc {
            flex: 1;
            text-align: center;
            color: #777;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .transport-breakdown-value {
            font-weight: 600;
            color: #0891b2;
            text-align: right;
        }

        .transport-breakdown-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0 0 0;
            margin-top: 0.5rem;
            border-top: 2px solid #0070ff;
        }

        .transport-levels-info {
            margin: 1.5rem 0;
        }

        .transport-levels-info h5 {
            color: #0070ff;
            margin: 0 0 1rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .transport-level {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            font-size: 0.9rem;
        }

        .transport-level-name {
            font-weight: 600;
            color: #555;
        }

        .transport-level-desc {
            color: #777;
        }

        .transport-explanation-note {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #0070ff;
            margin-top: 1.5rem;
        }

        .transport-explanation-note p {
            margin: 0.25rem 0;
            color: #555;
            font-size: 0.9rem;
        }

        /* === AÇÕES RÁPIDAS MODERNAS === */
        .quick-actions-container {
            margin: 2rem 0;
        }

        .quick-action-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .quick-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .quick-action-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
        }

        .quick-action-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .quick-action-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .quick-action-text h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .quick-action-text p {
            margin: 0;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .quick-action-button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .quick-action-button i {
            font-size: 1rem;
        }

        /* Responsivo para novos elementos */
        @media (max-width: 768px) {
            .quick-action-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .quick-action-info {
                justify-content: center;
            }

            .financial-header {
                padding: 1rem;
            }

            .financial-breakdown {
                padding: 1rem;
            }

            .breakdown-value-final {
                font-size: 1.2rem;
            }
        }

    </style>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="{{ url_for('static', filename='pdf_exporter_teste2_exact.js') }}"></script>

    <script>
        // Função para expandir/colapsar famílias de produtos
        function toggleFamily(familyName) {
            const productsDiv = document.getElementById('products-' + familyName);
            const chevron = document.getElementById('chevron-' + familyName);
            
            if (productsDiv.style.display === 'none') {
                productsDiv.style.display = 'block';
                chevron.classList.add('rotated');
            } else {
                productsDiv.style.display = 'none';
                chevron.classList.remove('rotated');
            }
        }

        // Funções para controle de quantidade
        function changeQuantity(productId, change) {
            const qtyInput = document.getElementById('qty_' + productId);
            let newQty = parseInt(qtyInput.value) + change;
            if (newQty < 0) newQty = 0;  // Permitir quantidade 0 para produtos opcionais/alternativos
            qtyInput.value = newQty;
            // Ajustar largura do input para o novo valor
            adjustQtyWidth(qtyInput);
            updateProductQuantity(productId, newQty);
        }

        function updateProductQuantity(productId, quantity) {
            // Validar quantidade antes de enviar
            if (quantity === null || quantity === undefined || quantity === '') {
                quantity = 0;
            }

            // Permitir vírgula como separador decimal
            let quantityStr = String(quantity).replace(',', '.');
            const validQuantity = Math.max(0, parseFloat(quantityStr) || 0);  // Permitir decimais

            // Helper: detectar se um nome corresponde à "Chapa Colaminada" (case-insensitive)
            function isChapaColaminada(name) {
                return name && /chapa colaminada/i.test(name);
            }

            // Obter informação da linha atual (se existir)
            const currentRow = document.querySelector(`[data-product-id="${productId}"]`);
            const currentName = currentRow ? currentRow.getAttribute('data-product-name') : null;

            // Tratar caso especial: produtos cerâmicos 102/103 (mantido para compatibilidade)
            if (productId === '102') {
                const secondProduct = document.getElementById('qty_103');
                if (secondProduct) {
                    secondProduct.value = validQuantity;
                    fetch('/update_quantity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ product_id: '103', quantity: validQuantity })
                    });
                }
            } else if (productId === '103') {
                const firstProduct = document.getElementById('qty_102');
                if (firstProduct) {
                    firstProduct.value = validQuantity;
                    fetch('/update_quantity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ product_id: '102', quantity: validQuantity })
                    });
                }
            }

            // Se o produto atual for Chapa Colaminada, forçar inteiro e sincronizar com o perfil principal
            if (isChapaColaminada(currentName)) {
                const intQty = Math.max(0, Math.round(validQuantity));
                // Atualizar input visível
                const input = document.getElementById('qty_' + productId);
                if (input) input.value = intQty;

                // Se este alternativo aponta para um produto principal, sincronizar o principal
                const targetId = currentRow ? currentRow.getAttribute('data-alternative-to') : null;
                if (targetId) {
                    const mainInput = document.getElementById('qty_' + targetId);
                    if (mainInput) {
                        mainInput.value = intQty;
                        // Atualizar principal no servidor
                        fetch('/update_quantity', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: targetId, quantity: intQty })
                        });
                    }
                }

                // Enviar atualização do próprio item (Chapa Colaminada)
                fetch('/update_quantity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, quantity: intQty })
                }).then(resp => resp.json()).then(data => {
                    if (data && data.success) {
                        applyBudgetTotalsToDOM(data);
                    } else {
                        location.reload();
                    }
                }).catch(() => location.reload());

                return; // Já tratámos e sincronizámos
            }

            // Se o produto alterado for o produto principal, procurar alternativas do tipo Chapa Colaminada e sincronizar
            const altRows = document.querySelectorAll(`[data-alternative-to="${productId}"]`);
            if (altRows && altRows.length > 0) {
                altRows.forEach(row => {
                    const altName = row.getAttribute('data-product-name');
                    if (isChapaColaminada(altName)) {
                        const altId = row.getAttribute('data-product-id');
                        const rounded = Math.max(0, Math.round(validQuantity));
                        const altInput = document.getElementById('qty_' + altId);
                        if (altInput) altInput.value = rounded;
                        // Atualizar alternativa no servidor
                        fetch('/update_quantity', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: altId, quantity: rounded })
                        });
                    }
                });
            }

            // Enviar atualização para o servidor para o produto atual
            fetch('/update_quantity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId, quantity: validQuantity })
            }).then(resp => resp.json()).then(data => {
                if (data && data.success) {
                    applyBudgetTotalsToDOM(data);
                } else {
                    // Fallback para reload caso haja erro
                    location.reload();
                }
            }).catch(() => {
                location.reload();
            });
        }

        // Ajusta a largura de um input de quantidade para que o número nunca fique cortado
        function adjustQtyWidth(input) {
            try {
                if (!input) return;
                const value = String(input.value || input.placeholder || '');
                const cs = window.getComputedStyle(input);
                // Use a cached canvas for measurements
                let canvas = adjustQtyWidth._canvas;
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    adjustQtyWidth._canvas = canvas;
                }
                const ctx = canvas.getContext('2d');
                // Build a font string compatible with canvas
                // Fallback to font-size + font-family if computed.font is not available
                const font = cs.font || (cs.fontWeight + ' ' + cs.fontSize + ' ' + cs.fontFamily);
                ctx.font = font;
                const metrics = ctx.measureText(value || '0');
                const textWidth = Math.ceil(metrics.width);
                // calculate horizontal paddings/borders
                const padLeft = parseFloat(cs.paddingLeft) || 0;
                const padRight = parseFloat(cs.paddingRight) || 0;
                const borderLeft = parseFloat(cs.borderLeftWidth) || 0;
                const borderRight = parseFloat(cs.borderRightWidth) || 0;
                const extra = 30; // extra spacing to avoid clipping
                const minPx = 36; // slightly larger minimum
                const maxPx = 260; // larger maximum to allow bigger counts

                // If the input uses border-box, width already includes padding/border; otherwise add them
                const boxSizing = cs.boxSizing || 'content-box';
                let needed = textWidth + extra;
                if (boxSizing === 'content-box') {
                    needed += padLeft + padRight + borderLeft + borderRight;
                }

                const targetPx = Math.min(maxPx, Math.max(minPx, Math.ceil(needed)));
                input.style.boxSizing = 'border-box';
                input.style.minWidth = minPx + 'px';
                input.style.width = targetPx + 'px';
            } catch (e) {
                // silently ignore measurement errors
            }
        }

        // Inicializar listeners para ajustar larguras ao digitar e ao carregar
        document.addEventListener('input', (e) => {
            if (e.target && (e.target.classList && (e.target.classList.contains('qty-input-compact') || e.target.classList.contains('qty-input-small')))) {
                adjustQtyWidth(e.target);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Delay a bit to let fonts render so canvas measurements are accurate
            setTimeout(() => {
                document.querySelectorAll('.qty-input-compact, .qty-input-small').forEach(inp => adjustQtyWidth(inp));
            }, 120);
        });

        // Aplica os totais retornados pelo servidor na DOM sem recarregar
        function applyBudgetTotalsToDOM(data) {
            try {
                // Atualizar totais por família (base)
                const familyBases = data.family_totals_base || {};
                Object.keys(familyBases).forEach(fam => {
                    const container = document.getElementById('products-' + fam);
                    if (container) {
                        // header é o elemento anterior ao container
                        const header = container.previousElementSibling;
                        if (header) {
                            const totalSpan = header.querySelector('.total-compact');
                            if (totalSpan) {
                                totalSpan.textContent = (parseFloat(familyBases[fam]) || 0).toFixed(2) + '€';
                            }
                        }
                    }
                });

                // Atualizar totals gerais
                const totalWithIva = parseFloat(data.total_with_iva || 0).toFixed(2);
                const subtotal = parseFloat(data.subtotal_with_margin || data.total_price || 0).toFixed(2);
                const totalElem = document.querySelector('.total-amount');
                const subtotalElem = document.querySelector('.total-before-iva');
                if (totalElem) totalElem.textContent = '€' + totalWithIva;
                if (subtotalElem) subtotalElem.textContent = 'S/ IVA: €' + subtotal;

                // Atualizar preços parciais por item (price * quantity)
                document.querySelectorAll('[data-product-id]').forEach(row => {
                    try {
                        const pid = row.getAttribute('data-product-id');
                        // Encontrar input de quantidade
                        const qtyInput = document.getElementById('qty_' + pid);
                        const qty = qtyInput ? parseFloat(String(qtyInput.value).replace(',', '.')) || 0 : 0;
                        // Tentar obter preço unitário: primeiro editable-price data, senão parse spec-price
                        let unitPrice = null;
                        const editable = row.querySelector('.editable-price');
                        if (editable && editable.dataset && editable.dataset.originalPrice) {
                            unitPrice = parseFloat(editable.dataset.originalprice || editable.dataset.originalPrice || editable.textContent) || null;
                        }
                        if (unitPrice === null) {
                            const spec = row.querySelector('.spec-price');
                            if (spec) {
                                // Extrair primeiro número encontrado
                                const m = spec.textContent.match(/\d+[\.,]?\d*/);
                                if (m) unitPrice = parseFloat(m[0].replace(',', '.')) || 0;
                            }
                        }
                        if (unitPrice !== null) {
                            const partial = (unitPrice * qty) || 0;
                            const partialElem = row.querySelector('.price-total-compact');
                            if (partialElem) partialElem.textContent = partial.toFixed(2) + '€';
                        }

                        // Atualizar badge de quantidade (spec-qty)
                        const specQty = row.querySelector('.spec-qty');
                        if (specQty) {
                            try {
                                specQty.textContent = 'Qtd: ' + qty.toFixed(2);
                            } catch (e) {
                                specQty.textContent = 'Qtd: ' + String(qty);
                            }
                        }
                    } catch (e) {
                        // ignore per-item errors
                    }
                });

                // Opcional: mostrar notificação rápida
                const notif = document.createElement('div');
                notif.style.cssText = 'position:fixed;top:18px;right:18px;background:#059669;color:#fff;padding:10px 14px;border-radius:8px;z-index:1200;box-shadow:0 6px 18px rgba(0,0,0,0.15);font-weight:700;';
                notif.textContent = 'Quantidade atualizada';
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 1200);
            } catch (e) {
                // Fallback: recarregar se algo falhar
                console.error('Erro ao aplicar totais na DOM:', e);
                location.reload();
            }
        }

        // Função para alternar produtos opcionais (incluir/excluir)
        // Função para incluir produto opcional no orçamento
        function includeOptionalProduct(productId, familyName) {
            const quantityInput = document.getElementById('qty_' + productId);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Se quantidade for 0, definir como 1 ao incluir
            const finalQuantity = quantity === 0 ? 1 : quantity;
            
            fetch('/include_optional_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    family: familyName,
                    quantity: finalQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> Produto incluído no orçamento`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Erro ao incluir produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function toggleOptional(productId) {
            const button = document.getElementById('toggle_' + productId);
            const isActive = button.classList.contains('active');
            
            fetch('/toggle_optional', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    include: !isActive
                })
            }).then(() => {
                location.reload(); // Recarregar para atualizar preços
            });
        }

        // Função para trocar produto opcional por incluído
        function replaceProduct(familyName, productId) {
            console.log('DEBUG: familyName recebido:', familyName);
            console.log('DEBUG: productId recebido:', productId);
            
            fetch('/switch_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: familyName,
                    item_id: productId
                })
            }).then(response => response.json())
            .then(data => {
                console.log('DEBUG: Resposta do servidor:', data);
                if (data.success) {
                    location.reload(); // Recarregar para atualizar a interface
                } else {
                    alert('Erro ao trocar produto: ' + data.error);
                }
            }).catch(error => {
                console.error('Erro:', error);
                alert('Erro ao trocar produto');
            });
        }

        // Função para exportar PDF
        function updateQuantity(family, productId, newQuantity) {
            newQuantity = Math.max(0, parseInt(newQuantity));
            
            fetch('/update_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: family,
                    item_id: productId,
                    quantity: newQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar a interface
                    location.reload();
                } else {
                    alert('Erro ao atualizar quantidade: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar quantidade');
            });
        }
        
        function switchProduct(family, productId) {
            fetch('/switch_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: family,
                    item_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar a interface
                    location.reload();
                } else {
                    alert('Erro ao trocar produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao trocar produto');
            });
        }
        
        // Função para mostrar alternativas disponíveis da base de dados
        let selectedAlternative = null;
        let currentSelection = null;

        function showAlternatives(family, currentProductId) {
            // Buscar alternativas da base de dados
            fetch(`/get_alternatives/${family}/${currentProductId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Erro ao buscar alternativas: ' + data.error);
                        return;
                    }
                    
                    if (data.alternatives.length === 0) {
                        alert('Não existem alternativas disponíveis para este produto.');
                        return;
                    }

                    selectedAlternative = null;
                    currentSelection = {family, currentProductId, data};

                    let optionsHTML = `
                        <div style="max-width: 650px; width: 90vw;">
                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 16px 16px 0 0; padding: 24px; border-bottom: 3px solid #3b82f6;">
                                <h3 style="color: #1e293b; margin: 0 0 8px 0; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-exchange-alt" style="color: #3b82f6; background: white; padding: 8px; border-radius: 50%; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);"></i>
                                    Selecionar Alternativa
                                </h3>
                                <p style="color: #64748b; margin: 0; font-size: 14px;">Escolha a melhor opção para o seu projeto</p>
                            </div>
                            
                            <div style="padding: 24px; background: white;">
                                <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; border: 2px solid #3b82f6; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 0; right: 0; background: #3b82f6; color: white; padding: 4px 12px; border-radius: 0 10px 0 8px; font-size: 12px; font-weight: 600;">ATUAL</div>
                                    <div style="font-weight: 700; color: #1e293b; margin-bottom: 6px; font-size: 16px;">${data.current_product.name}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6b7280; font-size: 14px;">Produto atual selecionado</span>
                                        <span style="color: #3b82f6; font-weight: 800; font-size: 18px;">${data.current_product.price.toFixed(2)}€</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #374151; margin-bottom: 16px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-list-alt" style="color: #6b7280;"></i>
                                        Alternativas Disponíveis
                                    </h4>
                                    <div style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto; padding-right: 8px;">
                    `;

                    data.alternatives.forEach((alt, index) => {
                        const priceDiff = alt.price - data.current_product.price;
                        const diffText = priceDiff > 0 ? `+${priceDiff.toFixed(2)}€` : `${priceDiff.toFixed(2)}€`;
                        const diffColor = priceDiff > 0 ? '#ef4444' : '#10b981';
                        
                        optionsHTML += `
                            <div class="alternative-option" data-id="${alt.id}" onclick="selectAlternativeOption('${alt.id}')" 
                                 style="
                                     padding: 16px 20px; 
                                     border: 2px solid #e2e8f0;
                                     border-radius: 12px; 
                                     cursor: pointer; 
                                     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                     background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                                     position: relative;
                                     overflow: hidden;
                                 ">
                                <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #e2e8f0; transition: all 0.3s ease;"></div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 16px;">${alt.name}</div>
                                        ${alt.description ? `<div style="color: #6b7280; font-size: 13px; line-height: 1.4;">${alt.description}</div>` : ''}
                                    </div>
                                    <div style="text-align: right; margin-left: 16px;">
                                        <div style="color: #0ea5e9; font-weight: 700; font-size: 18px;">${alt.price.toFixed(2)}€</div>
                                        <div style="color: ${diffColor}; font-size: 12px; font-weight: 600; margin-top: 2px;">${diffText}</div>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                    <div style="display: flex; gap: 8px;">
                                        ${Object.keys(alt.attributes || {})
                                            .filter(key => !['Capacidade', 'capacidade', 'Diametro', 'diametro', 'Diâmetro'].includes(key))
                                            .slice(0, 2)
                                            .map(key => 
                                                `<span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${key}: ${alt.attributes[key]}</span>`
                                            ).join('')}
                                    </div>
                                    <div class="selection-indicator" style="opacity: 0; color: #10b981; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; transition: opacity 0.3s ease;">
                                        <i class="fas fa-check-circle"></i> Selecionado
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    optionsHTML += `
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                    <button onclick="closeAlternativesModal()" 
                                            style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#4b5563'"
                                            onmouseout="this.style.background='#6b7280'">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button id="confirmButton" onclick="confirmSelection()" 
                                            style="background: #d1d5db; color: #9ca3af; border: none; padding: 12px 24px; border-radius: 8px; cursor: not-allowed; font-weight: 600; font-size: 14px; transition: all 0.3s ease;"
                                            disabled>
                                        <i class="fas fa-check"></i> Confirmar Seleção
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // Criar modal
                    const modal = document.createElement('div');
                    modal.id = 'alternativesModal';
                    modal.style.cssText = `
                        position: fixed; 
                        top: 0; left: 0; 
                        width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.7); 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        z-index: 1000;
                        backdrop-filter: blur(6px);
                        animation: fadeIn 0.3s ease;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 95vw; max-height: 95vh; overflow: hidden; animation: slideUp 0.3s ease;">
                            ${optionsHTML}
                        </div>
                    `;

                    document.body.appendChild(modal);

                    // Adicionar estilos de animação
                    if (!document.getElementById('modalAnimations')) {
                        const style = document.createElement('style');
                        style.id = 'modalAnimations';
                        style.textContent = `
                            @keyframes fadeIn {
                                from { opacity: 0; }
                                to { opacity: 1; }
                            }
                            @keyframes slideUp {
                                from { opacity: 0; transform: translateY(50px) scale(0.95); }
                                to { opacity: 1; transform: translateY(0) scale(1); }
                            }
                            @keyframes slideInRight {
                                from { opacity: 0; transform: translateX(100px); }
                                to { opacity: 1; transform: translateX(0); }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar alternativas:', error);
                    alert('Erro ao buscar alternativas. Tente novamente.');
                });
        }

        function selectAlternativeOption(altId) {
            // Remover seleção anterior
            document.querySelectorAll('.alternative-option').forEach(option => {
                option.style.borderColor = '#e2e8f0';
                option.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)';
                option.style.transform = 'none';
                option.querySelector('.selection-indicator').style.opacity = '0';
                option.querySelector('div[style*="position: absolute"]').style.background = '#e2e8f0';
            });

            // Aplicar seleção atual
            const selectedOption = document.querySelector(`[data-id="${altId}"]`);
            selectedOption.style.borderColor = '#10b981';
            selectedOption.style.background = 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)';
            selectedOption.style.transform = 'translateY(-2px)';
            selectedOption.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.15)';
            selectedOption.querySelector('.selection-indicator').style.opacity = '1';
            selectedOption.querySelector('div[style*="position: absolute"]').style.background = '#10b981';

            // Ativar botão de confirmação
            const confirmBtn = document.getElementById('confirmButton');
            confirmBtn.disabled = false;
            confirmBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            confirmBtn.style.color = 'white';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';

            // Armazenar seleção
            selectedAlternative = altId;
        }

        function confirmSelection() {
            if (!selectedAlternative || !currentSelection) {
                return;
            }

            const { family, currentProductId } = currentSelection;

            // Fazer a chamada para o backend
            fetch('/replace_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    family: family,
                    current_product_id: currentProductId,
                    new_product_id: selectedAlternative
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        animation: slideInRight 0.3s ease;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    closeAlternativesModal();
                    setTimeout(() => location.reload(), 1000); // Recarregar após mostrar o feedback
                } else {
                    alert('Erro ao trocar produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function selectAlternative(family, currentProductId, newProductId) {
            // Esta função é mantida para compatibilidade, mas não é mais usada
            // A nova lógica usa selectAlternativeOption e confirmSelection
        }

        function closeAlternativesModal() {
            const modal = document.getElementById('alternativesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Marcar produto como Oferta (não conta para o total)
        function setOffer(familyName, productId) {
            if (!confirm('Marcar este produto como Oferta? Ele não contará para o total.')) return;
            fetch('/update_item_type', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ family: familyName, item_id: productId, item_type: 'oferta' })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    const info = document.createElement('div');
                    info.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#f59e0b,#d97706);padding:12px 18px;color:white;border-radius:8px;z-index:1001;font-weight:700;';
                    info.innerText = 'Produto marcado como Oferta';
                    document.body.appendChild(info);
                    setTimeout(() => info.remove(), 2500);
                    setTimeout(() => location.reload(), 900);
                } else {
                    alert('Falha ao marcar como Oferta: ' + (data.error || 'erro desconhecido'));
                }
            }).catch(err => { console.error(err); alert('Erro ao comunicar com o servidor'); });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Animações de entrada sequencial
            const cards = document.querySelectorAll('.slide-up');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.8s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 200);
            });
            
            // Adicionar ouvintes para aceitar vírgulas nos campos de quantidade
            const quantityInputs = document.querySelectorAll('input[type="number"]');
            quantityInputs.forEach(input => {
                if (input.id && input.id.startsWith('qty_')) {
                    // Permitir vírgula como separador decimal
                    input.addEventListener('input', function(e) {
                        let value = e.target.value;
                        // Substituir vírgula por ponto para validação
                        if (value.includes(',')) {
                            e.target.value = value.replace(',', '.');
                        }
                    });
                    
                    // Tratar evento blur para normalizar o valor
                    input.addEventListener('blur', function(e) {
                        let value = parseFloat(e.target.value.replace(',', '.')) || 0;
                        if (value < 0) value = 0;
                        e.target.value = value.toFixed(2);
                    });
                }
            });
        });

        // ==========================================
        // FUNÇÕES PARA REMOVER PRODUTOS
        // ==========================================
        
        function removeProduct(productId, familyName) {
            if (!confirm('Tem certeza que deseja remover este produto do orçamento?')) {
                return;
            }
            
            fetch('/remove_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    family: familyName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        animation: slideInRight 0.3s ease;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-trash-alt"></i> ${data.message}`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Erro ao remover produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        // ==========================================
        // FUNÇÕES PARA ADICIONAR NOVOS PRODUTOS
        // ==========================================

        function showAddProductModal() {
            // Buscar famílias disponíveis (deixar o servidor filtrar por famílias com produtos)
            fetch('/get_product_families')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createAddProductModal(data.families);
                } else {
                    alert('Erro ao buscar famílias: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function createAddProductModal(families) {
            // Remover modal existente se houver
            const existingModal = document.getElementById('addProductModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Ensure modal-specific styles exist and are appended last so they win over other CSS.
            if (!document.getElementById('addProductModalStyles')) {
                const modalStyle = document.createElement('style');
                modalStyle.id = 'addProductModalStyles';
                modalStyle.innerHTML = `
                /* Modal-specific overrides to guarantee button visuals and hover */
                #addProductModal .add-product-modal-footer {
                    position: relative !important;
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    padding: 1rem 1.5rem !important;
                    gap: 8px !important;
                }

                /* Back button: redesigned to match Close (symmetry and polish) */
                #addProductModal .add-product-modal-footer .modal-back-btn {
                    margin: 0 12px 0 0 !important;
                    padding: 0.62rem 1.05rem !important;
                    border-radius: 12px !important;
                    background: linear-gradient(90deg,#556070,#3f4952) !important;
                    color: #fff !important;
                    box-shadow: 0 10px 26px rgba(46,60,73,0.07) !important;
                    border: 1px solid rgba(0,0,0,0.06) !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 0.5rem !important;
                    font-weight: 700 !important;
                }

                #addProductModal .add-product-modal-footer .modal-back-btn:hover {
                    transform: translateY(-6px) scale(1.02) !important;
                    box-shadow: 0 18px 38px rgba(46,60,73,0.14) !important;
                    background: linear-gradient(90deg,#717986,#3f4952) !important;
                }

                #addProductModal .add-product-modal-footer .modal-back-btn:focus {
                    outline: none !important;
                    box-shadow: 0 0 0 6px rgba(59,130,246,0.08) !important;
                }

                /* Close button (keeps previous polished look) */
                #addProductModal .add-product-modal-footer .modal-close-btn {
                    margin-left: auto !important;
                    padding: 1.3rem 2.5rem !important;
                    border-radius: 12px !important;
                    background: linear-gradient(90deg,#ef4444,#dc2626) !important;
                    color: #fff !important;
                    box-shadow: 0 10px 26px rgba(220,38,38,0.07) !important;
                    z-index: 60 !important;
                    font-weight: 700 !important;
                    border:none;
                    transition: 0.2s ease-in-out;
                }

                #addProductModal .add-product-modal-footer .modal-close-btn:hover {
                    transform: translateY(-6px) scale(1.02) !important;
                    box-shadow: 0 18px 44px rgba(220,38,38,0.22) !important;
                    background: linear-gradient(90deg,#ff6b6b,#ef4444) !important;
                }
                `;
                document.head.appendChild(modalStyle);
            }

            // Small CSS tweaks for compact family cards (no index/sidebar in family chooser)
            (function injectExtra(){
                const extraId = 'addProductModalExtraStyles';
                if (document.getElementById(extraId)) return;
                const s = document.createElement('style'); s.id = extraId; s.innerHTML = `
                /* Layout for family chooser */
                #addProductModal .add-product-layout { display:block; }
                #addProductModal .family-cards-area { overflow:auto; max-height:420px; }
                #addProductModal .family-grid.compact { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; }
                #addProductModal .family-card-modal.compact { display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; background:white; border:1px solid #eef2f7; cursor:pointer; transition:all .15s ease; box-shadow:0 6px 20px rgba(15,23,42,0.04); }
                #addProductModal .family-card-modal.compact .family-icon { width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#eef2ff,#f0f9ff); display:flex; align-items:center; justify-content:center; color:#2563eb; font-size:1.15rem; }
                #addProductModal .family-card-modal.compact .family-meta { display:flex; flex-direction:column; }
                #addProductModal .family-card-modal.compact .family-title { font-weight:700; color:#0f172a; }
                #addProductModal .family-card-modal.compact .family-count { font-size:0.85rem; color:#6b7280; }
                #addProductModal .family-card-modal.compact:hover { transform:translateY(-6px); box-shadow: 0 18px 36px rgba(15,23,42,0.08); border-color:#dbeafe; }
                @media (max-width: 820px) {
                    #addProductModal .family-grid.compact { grid-template-columns: repeat(2, 1fr); }
                }
                `; document.head.appendChild(s);
            })();

            // Ícones para famílias
            const familyIcons = {
                'Filtração': 'fa-filter',
                'Recirculação e Iluminação': 'fa-water',
                'Tratamento de Água': 'fa-flask',
                'Aquecimento': 'fa-thermometer-half',
                'Iluminação': 'fa-lightbulb',
                'Automação': 'fa-robot',
                'Limpeza': 'fa-broom',
                'Acessórios': 'fa-wrench'
            };

            // Debug: mostrar families recebidas (ajuda a entender por que só aparece uma)
            try { console.log('createAddProductModal - families.count=', families.length, 'names=', families.map(f => f.name)); } catch(e) {}

            // Normalizar e remover famílias duplicadas (mesmo nome, diferenças de caixa/espacos)
            const seenFamilies = new Set();
            const uniqueFamilies = [];
            families.forEach(f => {
                const key = (f.name || '').toString().trim().toLowerCase();
                if (!seenFamilies.has(key)) {
                    seenFamilies.add(key);
                    uniqueFamilies.push(f);
                }
            });

            // Safety guard: only render families that actually have products
            const familiesWithProducts = uniqueFamilies.filter(f => (f.product_count || 0) > 0);

            const modal = document.createElement('div');
            modal.id = 'addProductModal';
            modal.className = 'add-product-modal';

            modal.innerHTML = `
                <div class="add-product-modal-content">
                    <div class="add-product-modal-header">
                        <h3>
                            <i class="fas fa-plus-circle"></i>
                            Adicionar Novo Produto
                        </h3>
                    </div>
                    <div class="add-product-modal-body">
                        <div class="add-product-layout">
                            <section class="family-cards-area" id="familyCardsArea">
                                <p style="color: #64748b; margin-bottom: 0.5rem;">Selecione a família do produto:</p>
                                <div class="family-grid compact">
                                    ${uniqueFamilies.map(family => {
                                        const displayName = family.name || '';
                                        const slug = family.name_slug || displayName.normalize('NFKD').replace(/\p{Diacritic}/gu, '').replace(/[^a-zA-Z0-9]+/g, '_').toLowerCase();
                                        const icon = familyIcons[displayName] || 'fa-box';
                                        const count = family.product_count || 0;
                                        return `
                                        <div class="family-card-modal compact" id="fam_${slug}" onclick="showFamilyProducts('${slug}')">
                                            <div class="family-icon">
                                                <i class="fas ${icon}"></i>
                                            </div>
                                            <div class="family-meta">
                                                <div class="family-title">${displayName}</div>
                                                <div class="family-count">${count}</div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </section>
                        </div>
                        <div id="productSelection" style="display: none;">
                            <!-- Produtos serão carregados aqui -->
                        </div>
                    </div>
                    <div class="add-product-modal-footer">
                        <div id="modalBackButton" style="display: none;">
                            <button class="modal-back-btn" onclick="backToFamilies()">
                                <i class="fas fa-arrow-left"></i>
                                Voltar às Famílias
                            </button>
                        </div>
                        <div>
                            <button class="modal-close-btn" onclick="closeAddProductModal()">
                                <i class="fas fa-times"></i>
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            // Pre-fill new fields based on existing displayed values or defaults
            try {
                const answersMap = {};
                // attempt to read from the dashboard values if available
                answersMap.tratamento_agua = document.querySelector('.value-treatment') ? document.querySelector('.value-treatment').textContent.trim().toLowerCase().replace(/\s+/g,'_') : null;
                answersMap.tipo_construcao = document.querySelector('.value-construction') ? (document.querySelector('.value-construction').textContent.trim().toLowerCase().includes('remodel') ? 'remodelacao' : 'nova') : null;
                answersMap.cobertura = document.querySelector('.value-coverage') ? document.querySelector('.value-coverage').textContent.trim().toLowerCase() : null;
                answersMap.casa_maquinas_abaixo = document.querySelector('.value-machine-room') ? (document.querySelector('.value-machine-room').textContent.includes('Abaixo') ? 'sim' : 'nao') : null;
                answersMap.casa_maquinas_desc = document.querySelector('.value-machine-desc') ? document.querySelector('.value-machine-desc').textContent.trim() : null;
                answersMap.tipo_luzes = document.querySelector('.value-light-type') ? document.querySelector('.value-light-type').textContent.trim().toLowerCase().replace(/\s+/g,'_') : null;

                if (answersMap.tratamento_agua && document.getElementById('edit-treatment')) document.getElementById('edit-treatment').value = answersMap.tratamento_agua;
                if (answersMap.tipo_construcao && document.getElementById('edit-construction')) document.getElementById('edit-construction').value = answersMap.tipo_construcao;
                if (answersMap.cobertura && document.getElementById('edit-coverage')) document.getElementById('edit-coverage').value = answersMap.cobertura;
                if (answersMap.casa_maquinas_abaixo && document.getElementById('edit-machine-room')) document.getElementById('edit-machine-room').value = answersMap.casa_maquinas_abaixo;
                if (answersMap.casa_maquinas_desc && document.getElementById('edit-machine-desc')) document.getElementById('edit-machine-desc').value = answersMap.casa_maquinas_desc;
                if (answersMap.tipo_luzes && document.getElementById('edit-light-type')) {
                    const t = answersMap.tipo_luzes;
                    if (t.includes('rgb')) document.getElementById('edit-light-type').value = 'rgb';
                    else if (t.includes('adapt')) document.getElementById('edit-light-type').value = 'branco_adaptavel';
                    else document.getElementById('edit-light-type').value = 'branco_frio';
                }

                // handle coverage laminas visibility
                const coverageSelect = document.getElementById('edit-coverage');
                const laminasGroup = document.getElementById('edit-coverage-laminas-group');
                if (coverageSelect && laminasGroup) {
                    function updateLaminasVisibility() {
                        if (coverageSelect.value === 'laminas') laminasGroup.style.display = 'block';
                        else laminasGroup.style.display = 'none';
                    }
                    coverageSelect.addEventListener('change', updateLaminasVisibility);
                    updateLaminasVisibility();
                }
            } catch (err) {
                console.warn('Pre-fill modal fields failed', err);
            }
            
            // Animação de entrada
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);

            // Wire index clicks to smooth-scroll to category cards
            try {
                setTimeout(()=>{
                    const indexLinks = modal.querySelectorAll('.index-link');
                    indexLinks.forEach(link => {
                        link.addEventListener('click', (ev)=>{
                            ev.preventDefault();
                            const target = link.dataset.target;
                            const el = document.getElementById('fam_' + target);
                            if (el) {
                                el.scrollIntoView({behavior: 'smooth', block: 'center'});
                                // highlight briefly
                                el.classList.add('highlight');
                                setTimeout(()=> el.classList.remove('highlight'), 1200);
                            }
                        });
                    });
                }, 50);
            } catch(e) { console.warn('index wiring failed', e); }

            // Fechar ao clicar fora do modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAddProductModal();
                }
            });
        }

        function showFamilyProducts(familyName) {
            fetch(`/get_family_products/${encodeURIComponent(familyName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFamilyProducts(familyName, data.products);
                } else {
                    alert('Erro ao buscar produtos: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        function displayFamilyProducts(familyName, products) {
            // Use modal-scoped selectors; fall back to global IDs if modal absent
            const modal = document.getElementById('addProductModal');
            const familyDiv = modal ? modal.querySelector('#familyCardsArea') : document.getElementById('familySelection');
            const productDiv = modal ? modal.querySelector('#productSelection') : document.getElementById('productSelection');
            const backButton = modal ? modal.querySelector('#modalBackButton') : document.getElementById('modalBackButton');

            if (!productDiv) {
                console.error('displayFamilyProducts: product container not found (productSelection)');
                return;
            }

            if (familyDiv && familyDiv.style) familyDiv.style.display = 'none';
            productDiv.style.display = 'block';
            if (backButton && backButton.style) backButton.style.display = 'block';

            // Inject product-modal specific styles once
            (function injectProductStyles(){
                const id = 'productModalStyles';
                if (document.getElementById(id)) return;
                const st = document.createElement('style'); st.id = id; st.innerHTML = `
                /* Modern compact product modal styles */
                .product-modal-wrap { display:flex; gap:18px; align-items:flex-start; }
                .product-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px; width:100%; }
                .product-card { background:linear-gradient(180deg,#ffffff,#fbfdff); border:1px solid #e6eef8; border-radius:12px; padding:12px; box-shadow:0 10px 30px rgba(15,23,42,0.06); display:flex; flex-direction:column; gap:10px; transition:transform .16s cubic-bezier(.2,.9,.3,1), box-shadow .16s; }
                .product-card:hover { transform:translateY(-6px); box-shadow:0 22px 42px rgba(15,23,42,0.12); }
                .product-card .pc-top { display:flex; align-items:flex-start; gap:12px; }
                .product-thumb { width:56px; height:56px; flex:0 0 56px; border-radius:10px; background:linear-gradient(135deg,#eef6ff,#f0fbff); display:flex; align-items:center; justify-content:center; color:#0b66c2; font-size:1.05rem; font-weight:800; }
                .product-meta { display:flex; flex-direction:column; gap:2px; }
                .product-title { font-weight:800; color:#0f172a; font-size:0.98rem; line-height:1.1; }
                .product-cat { font-size:0.78rem; color:#6b7280; }
                .product-desc { font-size:0.86rem; color:#475569; min-height:44px; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
                .product-footer { display:flex; justify-content:space-between; align-items:center; gap:8px; }
                .product-price { font-weight:900; color:#0b76d6; background:rgba(11,118,214,0.06); padding:6px 10px; border-radius:8px; }
                .product-actions { display:flex; gap:8px; }
                .product-action-btn { padding:6px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:700; font-size:0.85rem; display:inline-flex; align-items:center; gap:8px; transition: transform 0.16s cubic-bezier(.2,.9,.3,1), box-shadow 0.16s ease, background 0.12s ease; will-change: transform, box-shadow; }
                .product-action-btn i { font-size:0.9rem; }
                .product-action-btn.include { background:linear-gradient(90deg,#06b58a,#05906b); color:white; }
                .product-action-btn.include:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 14px 38px rgba(16, 185, 129, 0.18); }
                .product-action-btn.optional { background:linear-gradient(90deg,#f59e0b,#d97706); color:white; }
                .product-action-btn.optional:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 14px 38px rgba(245, 158, 11, 0.18); }
                .product-action-btn.alternative { background:linear-gradient(90deg,#2563eb,#1e40af); color:white; }
                .product-action-btn.alternative:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 14px 38px rgba(37, 99, 235, 0.18); }

                /* Right-side sticky index inside products modal */
                .products-index { width:150px; position:sticky; top:18px; align-self:flex-start; background:linear-gradient(180deg,#ffffff,#fbfdff); border:1px solid #eef6ff; padding:12px; border-radius:12px; height:calc(100% - 24px); overflow:auto; box-shadow:0 6px 18px rgba(15,23,42,0.04); }
                .products-index .idx-title { font-weight:800; color:#0f172a; margin-bottom:8px; font-size:0.95rem; }
                .products-index .idx-link { display:block; padding:8px 10px; color:#334155; text-decoration:none; border-radius:999px; font-weight:700; margin-bottom:8px; background:transparent; transition:all .14s ease; font-size:0.88rem; }
                .products-index .idx-link:hover { background:#eef7ff; color:#0b66c2; transform:translateX(6px); }
                .products-index .idx-link.active { background:#e6f0ff; color:#0b66c2; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); }

                @media (max-width:920px){ .product-modal-wrap{ flex-direction:column-reverse; } .products-index{ width:100%; position:relative; order:2; } }
                `; document.head.appendChild(st);
            })();

            // Group products by category to build index
            const grouped = {};
            products.forEach(p => {
                const cat = p.category_name || 'Outros';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            // Build HTML
            const categories = Object.keys(grouped);
            productDiv.innerHTML = `
                <h4 style="margin: 0 0 1rem 0; color: #1a202c; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-box-open"></i>
                    Produtos - ${familyName}
                </h4>
                <div class="product-modal-wrap">
                    <div class="product-grid-area" style="flex:1;">
                        <div class="product-grid" id="productGrid">
                            ${categories.map(cat => {
                                return `
                                <div class="product-category-block" id="cat_${cat.replace(/[^a-z0-9]+/gi, '_')}">
                                    <div style="margin:10px 0 6px 0; font-weight:800; color:#0f172a;">${cat}</div>
                                    <div class="product-category-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px;">
                                        ${grouped[cat].map(p => `
                                            <div class="product-card">
                                                <div class="pc-top">
                                                    <div class="product-thumb"><i class="fas fa-box"></i></div>
                                                    <div>
                                                        <div class="product-title">${p.name}</div>
                                                        <div class="product-cat">${p.family_name || ''}</div>
                                                    </div>
                                                </div>
                                                <div class="product-desc">${p.description || ''}</div>
                                                <div class="product-footer">
                                                    <div class="product-price">${(p.base_price || 0).toFixed(2)}€</div>
                                                    <div class="product-actions">
                                                        <button class="product-action-btn include" onclick="addProductToQuote(${p.id}, 'incluido')">Incluir</button>
                                                        <button class="product-action-btn optional" onclick="addProductToQuote(${p.id}, 'opcional')">Opcional</button>
                                                        <button class="product-action-btn alternative" onclick="showAlternativeSelection(${p.id}, '${p.family_name || familyName}')">Alternativo</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <aside class="products-index" id="productsIndex">
                        <div class="idx-title">Categorias</div>
                        ${categories.map(cat => `<a class="idx-link" href="#cat_${cat.replace(/[^a-z0-9]+/gi, '_')}" data-target="cat_${cat.replace(/[^a-z0-9]+/gi, '_')}">${cat}</a>`).join('')}
                    </aside>
                </div>
            `;

            // Wire index clicks to smooth-scroll to category blocks and mark active
            setTimeout(()=>{
                const links = productDiv.querySelectorAll('.idx-link');
                links.forEach(l => {
                    l.addEventListener('click', ev => {
                        ev.preventDefault();
                        links.forEach(x=>x.classList.remove('active'));
                        l.classList.add('active');
                        const tgt = l.dataset.target;
                        const el = document.getElementById(tgt);
                        if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
                    });
                });

                // Add a simple scroll-spy to highlight index based on nearest category
                const categoryEls = Array.from(productDiv.querySelectorAll('.product-category-block'));
                if (categoryEls.length > 0) {
                    const idxLinks = Array.from(productDiv.querySelectorAll('.idx-link'));
                    const observer = new IntersectionObserver((entries)=>{
                        entries.forEach(ent=>{
                            if (ent.isIntersecting) {
                                const id = ent.target.id;
                                idxLinks.forEach(l => l.classList.toggle('active', l.dataset.target === id));
                            }
                        });
                    }, { root: productDiv, rootMargin: '-40% 0px -40% 0px', threshold: 0.01 });
                    categoryEls.forEach(el => observer.observe(el));
                }
            }, 60);
        }

        function backToFamilies() {
            const modal = document.getElementById('addProductModal');
            if (!modal) return;
            
            const familyDiv = modal.querySelector('#familyCardsArea');
            const productDiv = modal.querySelector('#productSelection');
            const backButton = modal.querySelector('#modalBackButton');
            
            if (familyDiv) familyDiv.style.display = 'block';
            if (productDiv) productDiv.style.display = 'none';
            if (backButton) backButton.style.display = 'none';
        }

        function closeAddProductModal() {
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function showAlternativeSelection(productId, productFamily) {
            // Debug: mostrar a família que estamos procurando
            console.log('Procurando produtos da família:', productFamily);
            
            // Buscar produtos já incluídos no orçamento da mesma família
            const includedProducts = collectIncludedProducts(productFamily);
            
            if (includedProducts.length === 0) {
                // Debug adicional: mostrar todas as famílias disponíveis
                const allProducts = collectIncludedProducts();
                const availableFamilies = [...new Set(allProducts.map(p => p.family))];
                console.log('Famílias disponíveis:', availableFamilies);
                
                alert(`❌ Não há produtos incluídos da família "${productFamily}" no orçamento para associar como alternativo. Adicione primeiro alguns produtos desta família como incluídos.\n\nFamílias disponíveis: ${availableFamilies.join(', ')}`);
                return;
            }
            
            // Criar modal de seleção moderno
            const modal = document.createElement('div');
            modal.className = 'alternative-modal-overlay';
            modal.innerHTML = `
                <div class="alternative-modal-container">
                    <div class="alternative-modal-header">
                        <div class="header-content">
                            <div class="header-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="header-text">
                                <h3>Selecionar Produto Principal</h3>
                                <p>Escolha qual produto da família "${productFamily}" será o principal</p>
                            </div>
                        </div>
                        <button onclick="closeAlternativeModal()" class="modal-close-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="alternative-modal-body">
                        <div class="products-grid">
                            ${includedProducts.map(product => `
                                <div class="alternative-product-card" onclick="selectMainProduct('${productId}', '${product.id}')">
                                    <div class="product-card-content">
                                        <div class="product-icon">
                                            <i class="fas fa-box"></i>
                                        </div>
                                        <div class="product-details">
                                            <div class="product-name">${product.name}</div>
                                            <div class="product-meta">
                                                <span class="product-family">${product.family}</span>
                                                <span class="product-qty">Qtd: ${product.quantity}</span>
                                            </div>
                                        </div>
                                        <div class="product-price-badge">
                                            ${product.price}
                                        </div>
                                    </div>
                                    <div class="selection-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="alternative-modal-footer">
                        <button onclick="closeAlternativeModal()" class="btn-cancel">
                            <i class="fas fa-times-circle"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar estilos modernos para o modal
            if (!document.getElementById('alternativeModalStyles')) {
                const styles = document.createElement('style');
                styles.id = 'alternativeModalStyles';
                styles.innerHTML = `
                    .alternative-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(15, 23, 42, 0.6);
                        backdrop-filter: blur(8px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease;
                    }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                    
                    .alternative-modal-container {
                        background: linear-gradient(180deg, #ffffff, #fbfdff);
                        border-radius: 20px;
                        box-shadow: 0 25px 50px rgba(15, 23, 42, 0.15);
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow: hidden;
                        animation: slideUp 0.3s ease;
                    }
                    
                    @keyframes slideUp {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    .alternative-modal-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 24px 28px;
                        background: linear-gradient(135deg, #2563eb, #1e40af);
                        color: white;
                    }
                    
                    .header-content {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                    }
                    
                    .header-icon {
                        width: 48px;
                        height: 48px;
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                    }
                    
                    .header-text h3 {
                        margin: 0;
                        font-size: 20px;
                        font-weight: 700;
                    }
                    
                    .header-text p {
                        margin: 4px 0 0 0;
                        font-size: 14px;
                        opacity: 0.9;
                    }
                    
                    .modal-close-btn {
                        width: 40px;
                        height: 40px;
                        border: none;
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        border-radius: 10px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s ease;
                    }
                    
                    .modal-close-btn:hover {
                        background: rgba(255, 255, 255, 0.3);
                        transform: scale(1.05);
                    }
                    
                    .alternative-modal-body {
                        padding: 24px 28px;
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    
                    .products-grid {
                        display: grid;
                        gap: 12px;
                    }
                    
                    .alternative-product-card {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 16px 20px;
                        background: linear-gradient(180deg, #ffffff, #f8fafc);
                        border: 2px solid #e2e8f0;
                        border-radius: 16px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    
                    .alternative-product-card:hover {
                        border-color: #2563eb;
                        transform: translateY(-2px);
                        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.15);
                    }
                    
                    .product-card-content {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        flex: 1;
                    }
                    
                    .product-icon {
                        width: 44px;
                        height: 44px;
                        background: linear-gradient(135deg, #eef6ff, #dbeafe);
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #2563eb;
                        font-size: 18px;
                    }
                    
                    .product-details {
                        flex: 1;
                    }
                    
                    .product-name {
                        font-weight: 700;
                        color: #0f172a;
                        font-size: 16px;
                        margin-bottom: 4px;
                    }
                    
                    .product-meta {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        font-size: 13px;
                        color: #64748b;
                    }
                    
                    .product-family {
                        background: #f1f5f9;
                        padding: 4px 8px;
                        border-radius: 6px;
                        font-weight: 500;
                    }
                    
                    .product-qty {
                        font-weight: 600;
                    }
                    
                    .product-price-badge {
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 10px;
                        font-weight: 700;
                        font-size: 14px;
                    }
                    
                    .selection-arrow {
                        color: #94a3b8;
                        font-size: 18px;
                        transition: all 0.2s ease;
                    }
                    
                    .alternative-product-card:hover .selection-arrow {
                        color: #2563eb;
                        transform: translateX(4px);
                    }
                    
                    .alternative-modal-footer {
                        padding: 20px 28px;
                        background: #f8fafc;
                        border-top: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: center;
                    }
                    
                    .btn-cancel {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #6b7280, #4b5563);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    }
                    
                    .btn-cancel:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(107, 114, 128, 0.3);
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(modal);
        }
        
        // Função para coletar produtos já incluídos no orçamento (opcionalmente filtrados por família)
        function collectIncludedProducts(familyFilter = null) {
            const products = [];
            
            // Normalizar nome da família para comparação
            const normalizeFamily = (name) => {
                return name.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                    .replace(/[^a-z0-9]/g, ' ')       // Substitui caracteres especiais por espaços
                    .replace(/\s+/g, ' ')             // Remove espaços duplos
                    .trim();
            };
            
            const normalizedFilter = familyFilter ? normalizeFamily(familyFilter) : null;
            
            // Percorrer todas as famílias e coletar produtos incluídos
            document.querySelectorAll('.family-card-compact').forEach(familyCard => {
                const familyName = familyCard.querySelector('.family-title-compact')?.textContent.trim() || 'Família';
                const normalizedFamilyName = normalizeFamily(familyName);
                
                // Debug: mostrar comparação de nomes
                if (familyFilter) {
                    console.log(`Comparando: "${normalizedFamilyName}" com "${normalizedFilter}"`);
                }
                
                // Se há filtro de família, aplicar comparação flexível
                if (familyFilter && normalizedFamilyName !== normalizedFilter) {
                    return;
                }
                
                familyCard.querySelectorAll('.product-row-compact-detailed').forEach(productRow => {
                    // Verificar se é produto incluído (não alternativo)
                    if (!productRow.classList.contains('alternative-product')) {
                        const nameElement = productRow.querySelector('.product-name-detail, .product-name-compact');
                        const priceElement = productRow.querySelector('.product-price, .spec-price');
                        const quantityInput = productRow.querySelector('input[type="number"]');
                        
                        if (nameElement && priceElement && quantityInput) {
                            // Obter ID do produto a partir do input de quantidade
                            let productId = null;
                            if (quantityInput.id) {
                                productId = quantityInput.id.replace('qty_', '');
                            } else if (quantityInput.name) {
                                productId = quantityInput.name.replace('qty_', '');
                            }
                            
                            // Tentar outras formas de obter o ID se não encontrou
                            if (!productId) {
                                const parentRow = quantityInput.closest('.product-row-compact-detailed');
                                if (parentRow && parentRow.dataset.productId) {
                                    productId = parentRow.dataset.productId;
                                }
                            }
                            
                            if (productId && parseInt(quantityInput.value) > 0) {
                                products.push({
                                    id: productId,
                                    name: nameElement.textContent.trim(),
                                    family: familyName,
                                    price: priceElement.textContent.trim(),
                                    quantity: quantityInput.value
                                });
                            }
                        }
                    }
                });
            });
            
            // Debug: mostrar produtos encontrados
            console.log('Produtos incluídos encontrados' + (familyFilter ? ` da família "${familyFilter}"` : '') + ':', products);
            
            return products;
        }
        
        function closeAlternativeModal() {
            const modal = document.querySelector('.alternative-modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // Função para selecionar produto principal e adicionar alternativo
        function selectMainProduct(alternativeProductId, mainProductId) {
            closeAlternativeModal();
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
                z-index: 1001;
                font-weight: 600;
            `;
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando produto alternativo...';
            document.body.appendChild(loadingDiv);
            
            // Adicionar produto como alternativo
            addProductToQuote(alternativeProductId, 'alternativo', mainProductId);
            
            // Remover loading após um tempo
            setTimeout(() => {
                if (document.body.contains(loadingDiv)) {
                    loadingDiv.remove();
                }
            }, 3000);
        }

        function addProductToQuote(productId, itemType, alternativeTo = null) {
            fetch('/add_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    item_type: itemType,
                    alternative_to: alternativeTo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar feedback de sucesso
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        z-index: 1001;
                        animation: slideInRight 0.3s ease;
                        font-weight: 600;
                    `;
                    successDiv.innerHTML = `<i class="fas fa-plus-circle"></i> ${data.message}`;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);

                    closeAddProductModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Erro ao adicionar produto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao comunicar com o servidor');
            });
        }

        // Sistema de edição inline - Popups para editar dados
        
        // Função principal para editar configuração completa do projeto (medidas + questionário)
        function editProjectConfiguration() {
            // Obter dados atuais das medidas
            const dimensionsText = document.querySelector('.value-dimensions')?.textContent || '0×0m';
            const depthText = document.querySelector('.value-depth')?.textContent || '0-0m';
            
            const comprimento = dimensionsText.split('×')[0]?.replace('m', '').trim() || '0';
            const largura = dimensionsText.split('×')[1]?.replace('m', '').trim() || '0';
            const profMin = depthText.split('-')[0]?.replace('m', '').trim() || '0';
            const profMax = depthText.split('-')[1]?.replace('m', '').trim() || '0';
            
            // Buscar respostas atuais do servidor
            fetch('/get_current_answers')
            .then(response => response.json())
            .then(data => {
                const currentAnswers = data.answers || {};
                showConfigurationModal(comprimento, largura, profMin, profMax, currentAnswers);
            })
            .catch(error => {
                console.error('Erro ao buscar respostas:', error);
                // Usar valores padrão em caso de erro
                // Capturar os valores reais do orçamento
                const currentAnswers = {
                    acesso: '{{ budget.pool_info.get("answers", {}).get("acesso", budget.pool_info.get("acesso", "facil")) }}',
                    escavacao: '{{ budget.pool_info.get("answers", {}).get("escavacao", budget.pool_info.get("escavacao", "mecanica")) }}',
                    forma: '{{ budget.pool_info.get("answers", {}).get("forma", budget.pool_info.get("forma", "retangular")) }}',
                    tipo_piscina: '{{ budget.pool_info.get("answers", {}).get("tipo_piscina", budget.pool_info.get("tipo_piscina", "skimmer")) }}',
                    revestimento: '{{ budget.pool_info.get("answers", {}).get("revestimento", budget.pool_info.get("revestimento", "vinil")) }}',
                    domotica: '{{ "true" if budget.pool_info.get("answers", {}).get("domotica", budget.pool_info.get("domotica", False)) else "false" }}',
                    localizacao: '{{ budget.pool_info.get("answers", {}).get("localizacao", budget.pool_info.get("localizacao", "exterior")) }}',
                    luz: '{{ budget.pool_info.get("answers", {}).get("luz", budget.pool_info.get("luz", "led")) }}',
                    tratamento_agua: '{{ budget.pool_info.get("answers", {}).get("tratamento_agua", budget.pool_info.get("tratamento_agua", "cloro_manual")) }}',
                    tipo_construcao: '{{ budget.pool_info.get("answers", {}).get("tipo_construcao", budget.pool_info.get("tipo_construcao", "nova")) }}',
                    cobertura: '{{ budget.pool_info.get("answers", {}).get("cobertura", budget.pool_info.get("cobertura", "nao")) }}',
                    casa_maquinas_abaixo: '{{ budget.pool_info.get("answers", {}).get("casa_maquinas_abaixo", budget.pool_info.get("casa_maquinas_abaixo", "nao")) }}',
                    casa_maquinas_desc: '{{ budget.pool_info.get("answers", {}).get("casa_maquinas_desc", budget.pool_info.get("casa_maquinas_desc", "")) }}',
                    tipo_luzes: '{{ budget.pool_info.get("answers", {}).get("tipo_luzes", budget.pool_info.get("tipo_luzes", "branco_frio")) }}',
                    havera_laje: '{{ budget.pool_info.get("answers", {}).get("havera_laje", budget.pool_info.get("havera_laje", "nao")) }}',
                    laje_m2: '{{ budget.pool_info.get("answers", {}).get("laje_m2", budget.pool_info.get("laje_m2", "")) }}',
                    laje_espessura: '{{ budget.pool_info.get("answers", {}).get("laje_espessura", budget.pool_info.get("laje_espessura", "")) }}',
                    revestimento_laje: '{{ budget.pool_info.get("answers", {}).get("revestimento_laje", budget.pool_info.get("revestimento_laje", "nao")) }}',
                    material_revestimento: '{{ budget.pool_info.get("answers", {}).get("material_revestimento", budget.pool_info.get("material_revestimento", "")) }}'
                };
                showConfigurationModal(comprimento, largura, profMin, profMax, currentAnswers);
            });
        }
        
        // Função para mostrar o modal com os dados
        function showConfigurationModal(comprimento, largura, profMin, profMax, currentAnswers) {
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay large-modal';
            modal.innerHTML = `
                <div class="edit-modal large premium">
                    <div class="edit-modal-header premium-header">
                        <div class="header-left">
                            <div class="header-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="header-text">
                                <h3>Configuração Completa do Projeto</h3>
                                <p>Edite as medidas da piscina, preferências e configurações técnicas</p>
                            </div>
                        </div>
                        <button onclick="closeModal()" class="close-btn premium-close">&times;</button>
                    </div>
                    <div class="edit-modal-body large-body premium-body">
                        <!-- Seção 1: Dimensões da Piscina -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-ruler-combined section-icon"></i>
                                <h4>Dimensões da Piscina</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Comprimento</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-comprimento" value="${comprimento}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                                <div class="form-group premium-field">
                                    <label>Largura</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-largura" value="${largura}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                                <div class="form-group premium-field">
                                    <label>Profundidade Mínima</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-prof-min" value="${profMin}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                                <div class="form-group premium-field">
                                    <label>Profundidade Máxima</label>
                                    <div class="input-wrapper">
                                        <input type="number" id="edit-prof-max" value="${profMax}" step="0.01" />
                                        <span class="input-unit">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seção 1.5: Elementos Adicionais -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-plus-circle section-icon"></i>
                                <h4>Elementos Adicionais</h4>
                            </div>
                            <div class="premium-grid">
                                <!-- Zona de Praia -->
                                <div class="form-group premium-field">
                                    <label>Há zona de praia?</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.zona_praia === 'sim' ? 'selected' : ''}" data-value="sim">
                                            <i class="fas fa-umbrella-beach" style="color: var(--success);"></i>
                                            <span>Sim</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.zona_praia === 'nao' ? 'selected' : ''}" data-value="nao">
                                            <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                            <span>Não</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-zona-praia" value="${currentAnswers.zona_praia || 'nao'}" />
                                    
                                    <!-- Campos condicionais para zona de praia -->
                                    <div id="edit-zona-praia-campos" style="display: ${currentAnswers.zona_praia === 'sim' ? 'block' : 'none'}; margin-top: 12px;">
                                        <div class="premium-grid" style="grid-template-columns: 1fr 1fr;">
                                            <div class="form-group premium-field">
                                                <label>Largura da Zona de Praia</label>
                                                <div class="input-wrapper">
                                                    <input type="number" id="edit-zona-praia-largura" value="${currentAnswers.zona_praia_largura || ''}" step="0.01" />
                                                    <span class="input-unit">m</span>
                                                </div>
                                                <small class="form-help">O comprimento da zona de praia é automaticamente igual à largura da piscina</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Escadas -->
                                <div class="form-group premium-field">
                                    <label>Há escadas?</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.escadas === 'sim' ? 'selected' : ''}" data-value="sim">
                                            <i class="fas fa-sort-amount-up" style="color: var(--success);"></i>
                                            <span>Sim</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.escadas === 'nao' ? 'selected' : ''}" data-value="nao">
                                            <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                            <span>Não</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-escadas" value="${currentAnswers.escadas || 'nao'}" />
                                    
                                    <!-- Campo condicional para escadas -->
                                    <div id="edit-escadas-campos" style="display: ${currentAnswers.escadas === 'sim' ? 'block' : 'none'}; margin-top: 12px;">
                                        <div class="form-group premium-field">
                                            <label>Largura da Escada</label>
                                            <div class="input-wrapper">
                                                <input type="number" id="edit-escadas-largura" value="${currentAnswers.escadas_largura || ''}" step="0.01" />
                                                <span class="input-unit">m</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seção 2: Condições do Local -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-map-marker-alt section-icon"></i>
                                <h4>Condições do Local</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Como é o acesso ao local?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.acesso === 'facil' ? 'selected' : ''}" data-value="facil">
                                        <i class="fas fa-truck" style="color: var(--success);"></i>
                                        <span>Fácil</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.acesso === 'medio' ? 'selected' : ''}" data-value="medio">
                                        <i class="fas fa-tools" style="color: var(--warning);"></i>
                                        <span>Médio</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.acesso === 'dificil' ? 'selected' : ''}" data-value="dificil">
                                        <i class="fas fa-mountain" style="color: var(--error);"></i>
                                        <span>Difícil</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-acesso" value="${currentAnswers.acesso || 'facil'}" />
                            </div>
                            <div class="form-group premium-field">
                                <label>É necessário escavação?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.escavacao === 'true' ? 'selected' : ''}" data-value="true">
                                        <i class="fas fa-shovel" style="color: var(--warning);"></i>
                                        <span>Sim</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.escavacao === 'false' ? 'selected' : ''}" data-value="false">
                                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                        <span>Não</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-escavacao" value="${currentAnswers.escavacao || 'false'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 3: Características da Piscina -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-swimming-pool section-icon"></i>
                                <h4>Características da Piscina</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Forma da piscina:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.forma === 'standard' ? 'selected' : ''}" data-value="standard">
                                        <i class="fas fa-square" style="color: var(--success);"></i>
                                        <span>Standard</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.forma === 'especial' ? 'selected' : ''}" data-value="especial">
                                        <i class="fas fa-star" style="color: var(--warning);"></i>
                                        <span>Especial</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-forma" value="${currentAnswers.forma || 'standard'}" />
                            </div>
                            <div class="form-group premium-field">
                                <label>Tipo de piscina:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.tipo_piscina === 'skimmer' ? 'selected' : ''}" data-value="skimmer">
                                        <i class="fas fa-water" style="color: var(--primary);"></i>
                                        <span>Skimmer</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tipo_piscina === 'espelho_dagua' ? 'selected' : ''}" data-value="espelho_dagua">
                                        <i class="fas fa-water" style="color: var(--secondary);"></i>
                                        <span>Espelho d'Água</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tipo_piscina === 'transbordo' ? 'selected' : ''}" data-value="transbordo">
                                        <i class="fas fa-wave-square" style="color: var(--accent);"></i>
                                        <span>Transbordo</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-tipo-piscina" value="${currentAnswers.tipo_piscina || 'skimmer'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 4: Acabamentos -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-palette section-icon"></i>
                                <h4>Acabamentos</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Tipo de revestimento:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.revestimento === 'tela' ? 'selected' : ''}" data-value="tela">
                                        <i class="fas fa-paint-roller" style="color: var(--success);"></i>
                                        <span>Tela</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.revestimento === 'ceramica' ? 'selected' : ''}" data-value="ceramica">
                                        <i class="fas fa-th-large" style="color: var(--secondary);"></i>
                                        <span>Cerâmica</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-revestimento" value="${currentAnswers.revestimento || 'tela'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 5: Tecnologia -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-microchip section-icon"></i>
                                <h4>Tecnologia</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Deseja sistema domótico?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.domotica === 'true' ? 'selected' : ''}" data-value="true">
                                        <i class="fas fa-mobile-alt" style="color: var(--accent);"></i>
                                        <span>Sim</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.domotica === 'false' ? 'selected' : ''}" data-value="false">
                                        <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                        <span>Não</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-domotica" value="${currentAnswers.domotica || 'false'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 6: Instalações -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-home section-icon"></i>
                                <h4>Instalações</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Localização:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.localizacao === 'interior' ? 'selected' : ''}" data-value="interior">
                                        <i class="fas fa-home" style="color: var(--secondary);"></i>
                                        <span>Interior</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.localizacao === 'exterior' ? 'selected' : ''}" data-value="exterior">
                                        <i class="fas fa-sun" style="color: var(--warning);"></i>
                                        <span>Exterior</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-localizacao" value="${currentAnswers.localizacao || 'exterior'}" />
                            </div>
                            <div class="form-group premium-field">
                                <label>Tipo de corrente elétrica:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.luz === 'monofasica' ? 'selected' : ''}" data-value="monofasica">
                                        <i class="fas fa-bolt" style="color: var(--success);"></i>
                                        <span>Monofásica</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.luz === 'trifasica' ? 'selected' : ''}" data-value="trifasica">
                                        <i class="fas fa-charging-station" style="color: var(--warning);"></i>
                                        <span>Trifásica</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-luz" value="${currentAnswers.luz || 'monofasica'}" />
                            </div>
                            
                            <!-- Casa das máquinas (igual ao questionário) -->
                            <div class="form-group premium-field">
                                <label>Casa das máquinas estará abaixo do nível da água?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.casa_maquinas_abaixo === 'sim' ? 'selected' : ''}" data-value="sim">
                                        <i class="fas fa-arrow-down" style="color: var(--primary);"></i>
                                        <span>Sim</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.casa_maquinas_abaixo === 'nao' ? 'selected' : ''}" data-value="nao">
                                        <i class="fas fa-level-up-alt" style="color: var(--success);"></i>
                                        <span>Não</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-casa_maquinas_abaixo" value="${currentAnswers.casa_maquinas_abaixo || 'nao'}" />
                                <div style="margin-top:12px;">
                                    <label class="premium-field" for="edit-casa_maquinas_desc">Observações sobre a casa das máquinas</label>
                                    <textarea id="edit-casa_maquinas_desc" rows="2" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">${currentAnswers.casa_maquinas_desc || ''}</textarea>
                                </div>
                            </div>

                            <!-- Tipo de luzes (igual ao questionário) -->
                            <div class="form-group premium-field">
                                <label>Tipo de luzes preferido:</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.tipo_luzes === 'branco_frio' ? 'selected' : ''}" data-value="branco_frio">
                                        <i class="fas fa-lightbulb" style="color:#87CEEB"></i>
                                        <span>Branco Frio</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tipo_luzes === 'branco_adaptavel' ? 'selected' : ''}" data-value="branco_adaptavel">
                                        <i class="fas fa-adjust" style="color: var(--warning);"></i>
                                        <span>Branco Adaptável</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tipo_luzes === 'rgb' ? 'selected' : ''}" data-value="rgb">
                                        <i class="fas fa-palette" style="color: var(--primary);"></i>
                                        <span>RGB</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-tipo_luzes" value="${currentAnswers.tipo_luzes || 'branco_frio'}" />
                            </div>
                        </div>
                        
                        <!-- Seção 7: Tratamento de Água -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-tint section-icon"></i>
                                <h4>Tratamento de Água</h4>
                            </div>
                            <div class="form-group premium-field">
                                <label>Que tipo de tratamento de água pretende?</label>
                                <div class="radio-group-premium">
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'cloro_manual' ? 'selected' : ''}" data-value="cloro_manual">
                                        <i class="fas fa-hand-paper" style="color: var(--success);"></i>
                                        <span>Cloro Manual</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'cloro_automatico' ? 'selected' : ''}" data-value="cloro_automatico">
                                        <i class="fas fa-robot" style="color: var(--primary);"></i>
                                        <span>Cloro Automático</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'clorador_salino' ? 'selected' : ''}" data-value="clorador_salino">
                                        <i class="fas fa-water" style="color: var(--secondary);"></i>
                                        <span>Clorador Salino</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'clorador_salino_ph' ? 'selected' : ''}" data-value="clorador_salino_ph">
                                        <i class="fas fa-balance-scale" style="color: var(--accent);"></i>
                                        <span>Clorador Salino + pH</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'clorador_salino_ph_uv' ? 'selected' : ''}" data-value="clorador_salino_ph_uv">
                                        <i class="fas fa-sun" style="color: var(--warning);"></i>
                                        <span>Clorador Salino + pH + UV</span>
                                    </div>
                                    <div class="radio-option-premium ${currentAnswers.tratamento_agua === 'nao' ? 'selected' : ''}" data-value="nao">
                                        <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                        <span>Não Incluído</span>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-tratamento-agua" value="${currentAnswers.tratamento_agua || 'cloro_manual'}" />
                            </div>
                        </div>

                        <!-- Seção 6: Configurações de Construção -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-hard-hat section-icon"></i>
                                <h4>Configurações de Construção</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Tipo de Construção</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.tipo_construcao === 'nova' ? 'selected' : ''}" data-value="nova">
                                            <i class="fas fa-plus-circle"></i>
                                            <span>Construção Nova</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.tipo_construcao === 'remodelacao' ? 'selected' : ''}" data-value="remodelacao">
                                            <i class="fas fa-tools"></i>
                                            <span>Remodelação</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-tipo-construcao" value="${currentAnswers.tipo_construcao || 'nova'}" />
                                </div>
                            </div>
                        </div>

                        <!-- Seção 7: Cobertura -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-umbrella section-icon"></i>
                                <h4>Sistema de Cobertura</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Tipo de Cobertura</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'laminas' ? 'selected' : ''}" data-value="laminas">
                                            <i class="fas fa-window-minimize"></i>
                                            <span>Cobertura de Lâminas</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'bolhas' ? 'selected' : ''}" data-value="bolhas">
                                            <i class="fas fa-circle"></i>
                                            <span>Cobertura de Bolhas</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'barras' ? 'selected' : ''}" data-value="barras">
                                            <i class="fas fa-bars"></i>
                                            <span>Cobertura de Barras</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'lona' ? 'selected' : ''}" data-value="lona">
                                            <i class="fas fa-tarp"></i>
                                            <span>Cobertura de Lona</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.cobertura === 'nao' ? 'selected' : ''}" data-value="nao">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Sem Cobertura</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-cobertura" value="${currentAnswers.cobertura || 'nao'}" />
                                </div>

                                <!-- Sub-opções para cobertura de lâminas -->
                                <div class="form-group premium-field" id="edit-cobertura-laminas-options" style="display: ${currentAnswers.cobertura === 'laminas' ? 'block' : 'none'};">
                                    <label>Tipo de Cobertura de Lâminas</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.tipo_cobertura_laminas === 'submersa_praia' ? 'selected' : ''}" data-value="submersa_praia">
                                            <i class="fas fa-water"></i>
                                            <span>Submersa na Praia</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.tipo_cobertura_laminas === 'fora_praia' ? 'selected' : ''}" data-value="fora_praia">
                                            <i class="fas fa-step-backward"></i>
                                            <span>Fora da Praia</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.tipo_cobertura_laminas === 'elevada' ? 'selected' : ''}" data-value="elevada">
                                            <i class="fas fa-arrow-up"></i>
                                            <span>Cobertura Elevada</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-tipo-cobertura-laminas" value="${currentAnswers.tipo_cobertura_laminas || ''}" />
                                </div>
                            </div>
                        </div>

                        <!-- Seção 8: Construção da Laje -->
                        <div class="config-section premium-section">
                            <div class="section-title">
                                <i class="fas fa-layer-group section-icon"></i>
                                <h4>Construção da Laje</h4>
                            </div>
                            <div class="premium-grid">
                                <div class="form-group premium-field">
                                    <label>Haverá construção de laje?</label>
                                    <div class="radio-group-premium">
                                        <div class="radio-option-premium ${currentAnswers.havera_laje === 'sim' ? 'selected' : ''}" data-value="sim">
                                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                            <span>Sim</span>
                                        </div>
                                        <div class="radio-option-premium ${currentAnswers.havera_laje === 'nao' ? 'selected' : ''}" data-value="nao">
                                            <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                            <span>Não</span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="edit-havera-laje" value="${currentAnswers.havera_laje || 'nao'}" />
                                    
                                    <!-- Campos condicionais para laje -->
                                    <div id="edit-laje-campos" style="display: ${currentAnswers.havera_laje === 'sim' ? 'block' : 'none'}; margin-top: 15px;">
                                        <div class="premium-grid" style="grid-template-columns: 1fr 1fr;">
                                            <div class="form-group premium-field">
                                                <label>Área da Laje</label>
                                                <div class="input-wrapper">
                                                    <input type="number" id="edit-laje-m2" value="${currentAnswers.laje_m2 || ''}" step="0.01" min="0" />
                                                    <span class="input-unit">m²</span>
                                                </div>
                                            </div>
                                            <div class="form-group premium-field">
                                                <label>Espessura da Laje</label>
                                                <select id="edit-laje-espessura" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
                                                    <option value="">Selecione a espessura</option>
                                                    <option value="0.10" ${currentAnswers.laje_espessura == '0.10' ? 'selected' : ''}>10 cm</option>
                                                    <option value="0.15" ${currentAnswers.laje_espessura == '0.15' ? 'selected' : ''}>15 cm</option>
                                                    <option value="0.20" ${currentAnswers.laje_espessura == '0.20' ? 'selected' : ''}>20 cm</option>
                                                    <option value="0.25" ${currentAnswers.laje_espessura == '0.25' ? 'selected' : ''}>25 cm</option>
                                                    <option value="0.30" ${currentAnswers.laje_espessura == '0.30' ? 'selected' : ''}>30 cm</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group premium-field" style="margin-top: 15px;">
                                            <label>Haverá revestimento da laje?</label>
                                            <div class="radio-group-premium">
                                                <div class="radio-option-premium ${currentAnswers.revestimento_laje === 'sim' ? 'selected' : ''}" data-value="sim">
                                                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                                    <span>Sim</span>
                                                </div>
                                                <div class="radio-option-premium ${currentAnswers.revestimento_laje === 'nao' ? 'selected' : ''}" data-value="nao">
                                                    <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                                                    <span>Não</span>
                                                </div>
                                            </div>
                                            <input type="hidden" id="edit-revestimento-laje" value="${currentAnswers.revestimento_laje || 'nao'}" />
                                            
                                            <!-- Campo para material de revestimento -->
                                            <div id="edit-material-revestimento-container" style="display: ${currentAnswers.revestimento_laje === 'sim' ? 'block' : 'none'}; margin-top: 12px;">
                                                <label>Material do Revestimento</label>
                                                <select id="edit-material-revestimento" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
                                                    <option value="">Selecione o material</option>
                                                    <optgroup label="Pedras Naturais">
                                                        <option value="granito_vila_real" ${currentAnswers.material_revestimento === 'granito_vila_real' ? 'selected' : ''}>Granito Vila Real (€35/m²)</option>
                                                        <option value="granito_pedras_salgadas" ${currentAnswers.material_revestimento === 'granito_pedras_salgadas' ? 'selected' : ''}>Granito Pedras Salgadas (€35/m²)</option>
                                                        <option value="granito_preto_angola" ${currentAnswers.material_revestimento === 'granito_preto_angola' ? 'selected' : ''}>Granito Preto Angola (€90/m²)</option>
                                                        <option value="granito_preto_zimbabue" ${currentAnswers.material_revestimento === 'granito_preto_zimbabue' ? 'selected' : ''}>Granito Preto Zimbabue (€140/m²)</option>
                                                        <option value="marmore_branco_ibiza" ${currentAnswers.material_revestimento === 'marmore_branco_ibiza' ? 'selected' : ''}>Mármore Branco Ibiza (€90/m²)</option>
                                                        <option value="travertino_turco" ${currentAnswers.material_revestimento === 'travertino_turco' ? 'selected' : ''}>Travertino Turco (€90/m²)</option>
                                                    </optgroup>
                                                    <optgroup label="Cerâmicos">
                                                        <option value="pedra_hijau" ${currentAnswers.material_revestimento === 'pedra_hijau' ? 'selected' : ''}>Pedra Hijau (€40/m²)</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="edit-modal-footer premium-footer">
                        <button onclick="closeModal()" class="btn btn-secondary premium-btn">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button onclick="saveCompleteConfiguration()" class="btn btn-primary premium-btn primary">
                            <i class="fas fa-sync-alt"></i>
                            Salvar e Recalcular
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Adicionar event listeners para os radio buttons customizados
            setupPremiumRadioButtons();
        }
        
        // Função para configurar radio buttons premium
        function setupPremiumRadioButtons() {
            document.querySelectorAll('.radio-option-premium').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from siblings
                    const siblings = this.parentNode.querySelectorAll('.radio-option-premium');
                    siblings.forEach(sibling => sibling.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden input
                    const hiddenInput = this.parentNode.nextElementSibling;
                    if (hiddenInput && hiddenInput.tagName === 'INPUT') {
                        hiddenInput.value = this.dataset.value;
                        
                        // Handle cobertura sub-options visibility
                        if (hiddenInput.id === 'edit-cobertura') {
                            const laminasOptions = document.getElementById('edit-cobertura-laminas-options');
                            if (laminasOptions) {
                                if (this.dataset.value === 'laminas') {
                                    laminasOptions.style.display = 'block';
                                } else {
                                    laminasOptions.style.display = 'none';
                                    // Clear laminas type selection
                                    const laminasInput = document.getElementById('edit-tipo-cobertura-laminas');
                                    if (laminasInput) {
                                        laminasInput.value = '';
                                        // Remove selected class from laminas options
                                        const laminasRadios = laminasOptions.querySelectorAll('.radio-option-premium');
                                        laminasRadios.forEach(radio => radio.classList.remove('selected'));
                                    }
                                }
                            }
                        }
                        
                        // Handle zona de praia sub-options visibility
                        if (hiddenInput.id === 'edit-zona-praia') {
                            const zonaPraiaCampos = document.getElementById('edit-zona-praia-campos');
                            if (zonaPraiaCampos) {
                                if (this.dataset.value === 'sim') {
                                    zonaPraiaCampos.style.display = 'block';
                                } else {
                                    zonaPraiaCampos.style.display = 'none';
                                    // Clear zona praia inputs
                                    const larguraInput = document.getElementById('edit-zona-praia-largura');
                                    if (larguraInput) larguraInput.value = '';
                                }
                            }
                        }
                        
                        // Handle escadas sub-options visibility
                        if (hiddenInput.id === 'edit-escadas') {
                            const escadasCampos = document.getElementById('edit-escadas-campos');
                            if (escadasCampos) {
                                if (this.dataset.value === 'sim') {
                                    escadasCampos.style.display = 'block';
                                } else {
                                    escadasCampos.style.display = 'none';
                                    // Clear escadas input
                                    const larguraInput = document.getElementById('edit-escadas-largura');
                                    if (larguraInput) larguraInput.value = '';
                                }
                            }
                        }
                        
                        // Handle laje sub-options visibility
                        if (hiddenInput.id === 'edit-havera-laje') {
                            const lajeCampos = document.getElementById('edit-laje-campos');
                            if (lajeCampos) {
                                if (this.dataset.value === 'sim') {
                                    lajeCampos.style.display = 'block';
                                } else {
                                    lajeCampos.style.display = 'none';
                                    // Clear laje inputs
                                    const m2Input = document.getElementById('edit-laje-m2');
                                    const espessuraInput = document.getElementById('edit-laje-espessura');
                                    const revestimentoInput = document.getElementById('edit-revestimento-laje');
                                    const materialContainer = document.getElementById('edit-material-revestimento-container');
                                    const materialInput = document.getElementById('edit-material-revestimento');
                                    
                                    if (m2Input) m2Input.value = '';
                                    if (espessuraInput) espessuraInput.value = '';
                                    if (revestimentoInput) revestimentoInput.value = 'nao';
                                    if (materialContainer) materialContainer.style.display = 'none';
                                    if (materialInput) materialInput.value = '';
                                    
                                    // Clear revestimento laje radio selection
                                    const revestimentoRadios = document.querySelectorAll('[data-value="nao"]');
                                    revestimentoRadios.forEach(radio => {
                                        if (radio.closest('.form-group').querySelector('#edit-revestimento-laje')) {
                                            radio.classList.add('selected');
                                            radio.parentNode.querySelectorAll('.radio-option-premium').forEach(opt => {
                                                if (opt !== radio) opt.classList.remove('selected');
                                            });
                                        }
                                    });
                                }
                            }
                        }
                        
                        // Handle revestimento laje sub-options visibility
                        if (hiddenInput.id === 'edit-revestimento-laje') {
                            const materialContainer = document.getElementById('edit-material-revestimento-container');
                            if (materialContainer) {
                                if (this.dataset.value === 'sim') {
                                    materialContainer.style.display = 'block';
                                } else {
                                    materialContainer.style.display = 'none';
                                    // Clear material selection
                                    const materialInput = document.getElementById('edit-material-revestimento');
                                    if (materialInput) materialInput.value = '';
                                }
                            }
                        }
                    }
                });
            });
        }
        
        // Função para salvar configuração completa e recalcular
        function saveCompleteConfiguration() {
            const newDimensions = {
                comprimento: parseFloat(document.getElementById('edit-comprimento').value),
                largura: parseFloat(document.getElementById('edit-largura').value),
                prof_min: parseFloat(document.getElementById('edit-prof-min').value),
                prof_max: parseFloat(document.getElementById('edit-prof-max').value)
            };
            
            const newAnswers = {
                acesso: document.getElementById('edit-acesso').value,
                escavacao: document.getElementById('edit-escavacao').value,
                forma: document.getElementById('edit-forma').value,
                tipo_piscina: document.getElementById('edit-tipo-piscina').value,
                revestimento: document.getElementById('edit-revestimento').value,
                domotica: document.getElementById('edit-domotica').value,
                localizacao: document.getElementById('edit-localizacao').value,
                luz: document.getElementById('edit-luz').value,
                tratamento_agua: document.getElementById('edit-tratamento-agua').value,
                tipo_construcao: document.getElementById('edit-tipo-construcao').value,
                cobertura: document.getElementById('edit-cobertura').value,
                tipo_cobertura_laminas: document.getElementById('edit-tipo-cobertura-laminas').value,
                // Zona de praia e escadas
                zona_praia: document.getElementById('edit-zona-praia').value,
                zona_praia_largura: document.getElementById('edit-zona-praia-largura') ? parseFloat(document.getElementById('edit-zona-praia-largura').value) || 0 : 0,
                zona_praia_comprimento: document.getElementById('edit-zona-praia').value === 'sim' ? parseFloat(document.getElementById('edit-largura').value) || 0 : 0, // Comprimento = largura da piscina
                escadas: document.getElementById('edit-escadas').value,
                escadas_largura: document.getElementById('edit-escadas-largura') ? parseFloat(document.getElementById('edit-escadas-largura').value) || 0 : 0
            };

            // Incluir casa das máquinas e tipo de luzes (idem questionário)
            newAnswers.casa_maquinas_abaixo = document.getElementById('edit-casa_maquinas_abaixo') ? document.getElementById('edit-casa_maquinas_abaixo').value : 'nao';
            newAnswers.casa_maquinas_desc = document.getElementById('edit-casa_maquinas_desc') ? document.getElementById('edit-casa_maquinas_desc').value : '';
            newAnswers.tipo_luzes = document.getElementById('edit-tipo_luzes') ? document.getElementById('edit-tipo_luzes').value : 'branco_frio';

            // Incluir campos da laje
            newAnswers.havera_laje = document.getElementById('edit-havera-laje') ? document.getElementById('edit-havera-laje').value : 'nao';
            if (newAnswers.havera_laje === 'sim') {
                newAnswers.laje_m2 = document.getElementById('edit-laje-m2') ? parseFloat(document.getElementById('edit-laje-m2').value) || 0 : 0;
                newAnswers.laje_espessura = document.getElementById('edit-laje-espessura') ? parseFloat(document.getElementById('edit-laje-espessura').value) || 0 : 0;
                newAnswers.revestimento_laje = document.getElementById('edit-revestimento-laje') ? document.getElementById('edit-revestimento-laje').value : 'nao';
                if (newAnswers.revestimento_laje === 'sim') {
                    newAnswers.material_revestimento = document.getElementById('edit-material-revestimento') ? document.getElementById('edit-material-revestimento').value : '';
                }
            }
            
            // Mostrar loading
            const saveBtn = document.querySelector('.btn.btn-primary.premium-btn.primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recalculando...';
            saveBtn.disabled = true;
            
            // Enviar para o servidor para recalcular completamente
            fetch('/recalculate_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comprimento: newDimensions.comprimento,
                    largura: newDimensions.largura,
                    prof_min: newDimensions.prof_min,
                    prof_max: newDimensions.prof_max,
                    answers: newAnswers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    showSuccessMessage('✨ Configuração atualizada! Recarregando orçamento completo...');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    alert('❌ Erro ao recalcular: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                alert('❌ Erro ao comunicar com o servidor');
            });
        }
        
        // Função para editar informações do cliente
        function editClientInfo() {
            const clientName = document.querySelector('.client-name')?.textContent.replace(/[📞👤]/g, '').trim() || '';
            const proposalNumber = document.querySelector('.proposal-number')?.textContent.replace('#', '').trim() || '';
            const clientDate = document.querySelector('.date')?.textContent.replace(/[📅]/g, '').trim() || '';
            const commercialName = document.querySelector('.commercial-name')?.textContent.replace(/[👔]/g, '').trim() || '';
            
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal" style="max-width: 600px;">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-user-edit"></i> Editar Dados do Cliente</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                    <i class="fas fa-user" style="margin-right: 0.5rem; color: #3498db;"></i>
                                    Nome do Cliente
                                </label>
                                <input type="text" id="edit-client-name" value="${clientName}" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#3498db'; this.style.boxShadow='0 0 0 3px rgba(52, 152, 219, 0.1)'"
                                       onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'" />
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                    <i class="fas fa-user-tie" style="margin-right: 0.5rem; color: #9b59b6;"></i>
                                    Nome do Comercial
                                </label>
                                <input type="text" id="edit-commercial-name" value="${commercialName}" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#9b59b6'; this.style.boxShadow='0 0 0 3px rgba(155, 89, 182, 0.1)'"
                                       onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'" />
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                    <i class="fas fa-hashtag" style="margin-right: 0.5rem; color: #e67e22;"></i>
                                    Número da Proposta
                                </label>
                                <input type="text" id="edit-proposal-number" value="${proposalNumber}" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#e67e22'; this.style.boxShadow='0 0 0 3px rgba(230, 126, 34, 0.1)'"
                                       onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'" />
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                    <i class="fas fa-calendar" style="margin-right: 0.5rem; color: #27ae60;"></i>
                                    Data da Proposta
                                </label>
                                <input type="date" id="edit-client-date" value="${clientDate}" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#27ae60'; this.style.boxShadow='0 0 0 3px rgba(39, 174, 96, 0.1)'"
                                       onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'" />
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                    <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem; color: #e74c3c;"></i>
                                    Localidade
                                </label>
                                <select id="edit-localidade" 
                                        style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: white;"
                                        onfocus="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 0 3px rgba(231, 76, 60, 0.1)'"
                                        onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'"
                                        onchange="toggleLocalidadeOutroEdit()">
                                    <option value="">-- Selecionar Localidade --</option>
                                    <option>Viseu</option>
                                    <option>Ponte Lima</option>
                                    <option>Barcelos</option>
                                    <option>Santa Maria da Feira</option>
                                    <option>Póvoa de Varzim</option>
                                    <option>Vila do Conde</option>
                                    <option>Viana do Castelo</option>
                                    <option>Famalicão</option>
                                    <option>Ovar</option>
                                    <option>Estarreja</option>
                                    <option>Gaia</option>
                                    <option>Braga</option>
                                    <option>Guimarães</option>
                                    <option>Porto</option>
                                    <option>Maia</option>
                                    <option>Matosinhos</option>
                                    <option value="Outro">Outro</option>
                                </select>
                                <input type="text" id="edit-localidade-outro" placeholder="Especifique outra localidade" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; margin-top: 0.5rem; display: none; transition: all 0.3s ease;"
                                       onfocus="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 0 3px rgba(231, 76, 60, 0.1)'"
                                       onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'" />
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                    <i class="fas fa-sticky-note" style="margin-right: 0.5rem; color: #f39c12;"></i>
                                    Observações
                                </label>
                                <textarea id="edit-observations" rows="3" placeholder="Informações adicionais sobre o projeto..."
                                          style="width: 100%; padding: 0.75rem; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; resize: vertical; transition: all 0.3s ease;"
                                          onfocus="this.style.borderColor='#f39c12'; this.style.boxShadow='0 0 0 3px rgba(243, 156, 18, 0.1)'"
                                          onblur="this.style.borderColor='#e1e8ed'; this.style.boxShadow='none'"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="edit-modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem; border-top: 1px solid #e1e8ed;">
                        <button onclick="closeModal()" class="btn btn-secondary" 
                                style="padding: 0.75rem 1.5rem; border: 2px solid #95a5a6; background: transparent; color: #95a5a6; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#95a5a6'; this.style.color='white'"
                                onmouseout="this.style.background='transparent'; this.style.color='#95a5a6'">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>Cancelar
                        </button>
                        <button onclick="saveClientInfo()" class="btn btn-primary"
                                style="padding: 0.75rem 1.5rem; border: 2px solid #3498db; background: #3498db; color: white; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#2980b9'; this.style.borderColor='#2980b9'"
                                onmouseout="this.style.background='#3498db'; this.style.borderColor='#3498db'">
                            <i class="fas fa-save" style="margin-right: 0.5rem;"></i>Salvar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Carregar valores atuais da localidade e observações
            loadCurrentClientData();
        }

        // Função para editar informações da piscina
        function editPoolInfo() {
            const dimensionsText = document.querySelector('.pool-dimensions, .value-dimensions')?.textContent || '0×0m';
            const depthText = document.querySelector('.pool-depth, .value-depth')?.textContent || '0-0m';
            
            const comprimento = dimensionsText.split('×')[0]?.replace('m', '').trim() || '0';
            const largura = dimensionsText.split('×')[1]?.replace('m', '').trim() || '0';
            const profMin = depthText.split('-')[0]?.replace('m', '').trim() || '0';
            const profMax = depthText.split('-')[1]?.replace('m', '').trim() || '0';
            
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-swimming-pool"></i> Editar Dados da Piscina</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <div class="form-group">
                            <label>Comprimento (m)</label>
                            <input type="number" id="edit-comprimento" value="${comprimento}" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>Largura (m)</label>
                            <input type="number" id="edit-largura" value="${largura}" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>Profundidade Mínima (m)</label>
                            <input type="number" id="edit-prof-min" value="${profMin}" step="0.1" />
                        </div>
                        <div class="form-group">
                            <label>Profundidade Máxima (m)</label>
                            <input type="number" id="edit-prof-max" value="${profMax}" step="0.1" />
                        </div>
                    </div>
                    <div class="edit-modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="savePoolInfo()" class="btn btn-primary">Salvar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Função para carregar dados atuais do cliente
        function loadCurrentClientData() {
            // Carregar localidade atual do backend ou template variables
            fetch('/get_current_client_data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const localidadeSelect = document.getElementById('edit-localidade');
                        const localidadeOutro = document.getElementById('edit-localidade-outro');
                        const observations = document.getElementById('edit-observations');
                        
                        if (data.client_data.localidade) {
                            localidadeSelect.value = data.client_data.localidade;
                            if (data.client_data.localidade === 'Outro' && data.client_data.localidade_outro) {
                                localidadeOutro.style.display = 'block';
                                localidadeOutro.value = data.client_data.localidade_outro;
                            }
                        }
                        
                        if (data.client_data.observations) {
                            observations.value = data.client_data.observations;
                        }
                    }
                })
                .catch(error => {
                    console.log('Dados do cliente não encontrados, usando valores padrão');
                });
        }

        // Função para alternar campo "Outro" da localidade
        function toggleLocalidadeOutroEdit() {
            const select = document.getElementById('edit-localidade');
            const outroField = document.getElementById('edit-localidade-outro');
            
            if (select.value === 'Outro') {
                outroField.style.display = 'block';
                outroField.focus();
            } else {
                outroField.style.display = 'none';
                outroField.value = '';
            }
        }

        // Função para salvar dados do cliente
        function saveClientInfo() {
            const clientName = document.getElementById('edit-client-name').value;
            const proposalNumber = document.getElementById('edit-proposal-number').value;
            const clientDate = document.getElementById('edit-client-date').value;
            const commercialName = document.getElementById('edit-commercial-name').value;
            const localidade = document.getElementById('edit-localidade').value;
            const localidadeOutro = document.getElementById('edit-localidade-outro').value;
            const observations = document.getElementById('edit-observations').value;
            
            // Atualizar na interface
            const clientNameEl = document.querySelector('.client-name');
            if (clientNameEl) clientNameEl.innerHTML = `<i class="fas fa-user"></i> ${clientName}`;
            
            const proposalEl = document.querySelector('.proposal-number');
            if (proposalEl) proposalEl.innerHTML = `<i class="fas fa-hashtag"></i> ${proposalNumber}`;
            
            const dateEl = document.querySelector('.date');
            if (dateEl) dateEl.innerHTML = `<i class="fas fa-calendar"></i> ${clientDate}`;
            
            const commercialEl = document.querySelector('.commercial-name');
            if (commercialEl && commercialName) commercialEl.innerHTML = `<i class="fas fa-user-tie"></i> ${commercialName}`;
            
            // Salvar dados no backend
            const formData = new FormData();
            formData.append('clientName', clientName);
            formData.append('proposalNumber', proposalNumber);
            formData.append('date', clientDate);
            formData.append('commercialName', commercialName);
            formData.append('localidade', localidade);
            formData.append('localidade_outro', localidadeOutro);
            formData.append('observations', observations);
            
            fetch('/update_client_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Dados do cliente atualizados com sucesso!');
                } else {
                    showErrorMessage('Erro ao atualizar dados do cliente: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showErrorMessage('Erro de conexão ao atualizar dados do cliente');
            });
            
            closeModal();
        }

        // Função para salvar dados da piscina  
        function savePoolInfo() {
            const comprimento = document.getElementById('edit-comprimento').value;
            const largura = document.getElementById('edit-largura').value;
            const profMin = document.getElementById('edit-prof-min').value;
            const profMax = document.getElementById('edit-prof-max').value;
            
            // Obter respostas atuais do questionário para manter
            const poolTypeEl = document.querySelector('.value-pool-type');
            const shapeEl = document.querySelector('.value-shape');
            const coatingEl = document.querySelector('.value-coating');
            const accessEl = document.querySelector('.value-access');
            const excavationEl = document.querySelector('.value-excavation');
            const locationEl = document.querySelector('.value-location');
            const domoticsEl = document.querySelector('.value-domotics');
            const powerEl = document.querySelector('.value-power');
            
            const currentPoolType = poolTypeEl ? poolTypeEl.textContent.trim().toLowerCase() : '';
            const currentShape = shapeEl ? shapeEl.textContent.trim().toLowerCase() : '';
            const currentCoating = coatingEl ? coatingEl.textContent.trim().toLowerCase() : '';
            const currentAccess = accessEl ? accessEl.textContent.trim().toLowerCase() : '';
            const currentExcavation = excavationEl ? (excavationEl.textContent.includes('Incluída') ? 'true' : 'false') : 'false';
            const currentLocation = locationEl ? locationEl.textContent.trim().toLowerCase() : '';
            const currentDomotics = domoticsEl ? (domoticsEl.textContent.includes('Sim') ? 'true' : 'false') : 'false';
            const currentPower = powerEl ? (powerEl.textContent.includes('Trifásica') ? 'trifasica' : 'monofasica') : 'monofasica';
            
            // Mapear valores de volta para os códigos corretos
            let poolTypeCode = 'skimmer';
            if (currentPoolType.includes('espelho')) poolTypeCode = 'espelho_dagua';
            else if (currentPoolType.includes('transbordo')) poolTypeCode = 'transbordo';
            
            let shapeCode = 'retangular';
            if (currentShape.includes('quadrada')) shapeCode = 'quadrada';
            else if (currentShape.includes('oval')) shapeCode = 'oval';
            else if (currentShape.includes('redonda')) shapeCode = 'redonda';
            else if (currentShape.includes('l')) shapeCode = 'em_l';
            else if (currentShape.includes('irregular')) shapeCode = 'irregular';
            
            let coatingCode = 'vinil';
            if (currentCoating.includes('fibra')) coatingCode = 'fibra';
            else if (currentCoating.includes('azulejo')) coatingCode = 'azulejo';
            else if (currentCoating.includes('pastilha')) coatingCode = 'pastilha';
            else if (currentCoating.includes('pedra')) coatingCode = 'pedra';
            
            let accessCode = 'facil';
            if (currentAccess.includes('medio')) accessCode = 'medio';
            else if (currentAccess.includes('dificil')) accessCode = 'dificil';
            
            let locationCode = 'urbana';
            if (currentLocation.includes('rural')) locationCode = 'rural';
            else if (currentLocation.includes('costeira')) locationCode = 'costeira';
            
            // Preparar dados para recalcular
            const updateData = {
                comprimento: parseFloat(comprimento),
                largura: parseFloat(largura),
                prof_min: parseFloat(profMin),
                prof_max: parseFloat(profMax),
                answers: {
                    tipo_piscina: poolTypeCode,
                    forma: shapeCode,
                    revestimento: coatingCode,
                    acesso: accessCode,
                    escavacao: currentExcavation,
                    localizacao: locationCode,
                    domotica: currentDomotics,
                    luz: currentPower
                }
            };
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Recalculando com novas medidas...`;
            document.body.appendChild(loadingDiv);
            
            // Enviar para o backend para recalcular
            fetch('/recalculate_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.remove();
                if (data.success) {
                    closeModal();
                    showSuccessMessage('Medidas atualizadas e orçamento recalculado!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showErrorMessage('Erro ao recalcular: ' + data.error);
                }
            })
            .catch(error => {
                loadingDiv.remove();
                console.error('Erro ao recalcular:', error);
                showErrorMessage('Erro de comunicação com o servidor');
            });
        }

        // Função para editar respostas do questionário
        function editQuestionnaireAnswers() {
            // Capturar valores atuais das respostas
            const poolTypeEl = document.querySelector('.value-pool-type');
            const shapeEl = document.querySelector('.value-shape');
            const coatingEl = document.querySelector('.value-coating');
            const accessEl = document.querySelector('.value-access');
            const excavationEl = document.querySelector('.value-excavation');
            const locationEl = document.querySelector('.value-location');
            const domoticsEl = document.querySelector('.value-domotics');
            const powerEl = document.querySelector('.value-power');
            
            const currentPoolType = poolTypeEl ? poolTypeEl.textContent.trim().toLowerCase() : '';
            const currentShape = shapeEl ? shapeEl.textContent.trim().toLowerCase() : '';
            const currentCoating = coatingEl ? coatingEl.textContent.trim().toLowerCase() : '';
            const currentAccess = accessEl ? accessEl.textContent.trim().toLowerCase() : '';
            const currentExcavation = excavationEl ? (excavationEl.textContent.includes('Incluída') ? 'true' : 'false') : 'false';
            const currentLocation = locationEl ? locationEl.textContent.trim().toLowerCase() : '';
            const currentDomotics = domoticsEl ? (domoticsEl.textContent.includes('Sim') ? 'true' : 'false') : 'false';
            const currentPower = powerEl ? (powerEl.textContent.includes('Trifásica') ? 'trifasica' : 'monofasica') : 'monofasica';
            
            const modal = document.createElement('div');
            modal.className = 'edit-modal-overlay';
            modal.innerHTML = `
                <div class="edit-modal questionnaire-modal">
                    <div class="edit-modal-header">
                        <h3><i class="fas fa-cog"></i> Editar Configuração do Projeto</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="edit-modal-body">
                        <div class="form-group">
                            <label>Tipo de Piscina</label>
                            <select id="edit-pool-type">
                                <option value="skimmer" ${currentPoolType.includes('skimmer') ? 'selected' : ''}>Skimmer</option>
                                <option value="espelho_dagua" ${currentPoolType.includes('espelho') ? 'selected' : ''}>Espelho d'Água</option>
                                <option value="transbordo" ${currentPoolType.includes('transbordo') ? 'selected' : ''}>Transbordo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Forma</label>
                            <select id="edit-shape">
                                <option value="retangular" ${currentShape.includes('retangular') ? 'selected' : ''}>Retangular</option>
                                <option value="quadrada" ${currentShape.includes('quadrada') ? 'selected' : ''}>Quadrada</option>
                                <option value="oval" ${currentShape.includes('oval') ? 'selected' : ''}>Oval</option>
                                <option value="redonda" ${currentShape.includes('redonda') ? 'selected' : ''}>Redonda</option>
                                <option value="em_l" ${currentShape.includes('l') ? 'selected' : ''}>Em L</option>
                                <option value="irregular" ${currentShape.includes('irregular') ? 'selected' : ''}>Irregular</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Revestimento</label>
                            <select id="edit-coating">
                                <option value="vinil" ${currentCoating.includes('vinil') ? 'selected' : ''}>Vinil</option>
                                <option value="fibra" ${currentCoating.includes('fibra') ? 'selected' : ''}>Fibra de Vidro</option>
                                <option value="azulejo" ${currentCoating.includes('azulejo') ? 'selected' : ''}>Azulejo</option>
                                <option value="pastilha" ${currentCoating.includes('pastilha') ? 'selected' : ''}>Pastilha</option>
                                <option value="pedra" ${currentCoating.includes('pedra') ? 'selected' : ''}>Pedra Natural</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Acesso ao Local</label>
                            <select id="edit-access">
                                <option value="facil" ${currentAccess.includes('facil') ? 'selected' : ''}>Fácil</option>
                                <option value="medio" ${currentAccess.includes('medio') ? 'selected' : ''}>Médio</option>
                                <option value="dificil" ${currentAccess.includes('dificil') ? 'selected' : ''}>Difícil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Escavação</label>
                            <select id="edit-excavation">
                                <option value="true" ${currentExcavation === 'true' ? 'selected' : ''}>Incluída</option>
                                <option value="false" ${currentExcavation === 'false' ? 'selected' : ''}>Não Incluída</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Localização</label>
                            <select id="edit-location">
                                <option value="urbana" ${currentLocation.includes('urbana') ? 'selected' : ''}>Urbana</option>
                                <option value="rural" ${currentLocation.includes('rural') ? 'selected' : ''}>Rural</option>
                                <option value="costeira" ${currentLocation.includes('costeira') ? 'selected' : ''}>Costeira</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sistema Domótico</label>
                            <select id="edit-domotics">
                                <option value="true" ${currentDomotics === 'true' ? 'selected' : ''}>Sim</option>
                                <option value="false" ${currentDomotics === 'false' ? 'selected' : ''}>Não</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Alimentação Elétrica</label>
                            <select id="edit-power">
                                <option value="monofasica" ${currentPower === 'monofasica' ? 'selected' : ''}>Monofásica</option>
                                <option value="trifasica" ${currentPower === 'trifasica' ? 'selected' : ''}>Trifásica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tratamento de Água</label>
                            <select id="edit-treatment">
                                <option value="cloro_manual">Cloro Manual</option>
                                <option value="cloro_automatico">Cloro Automático</option>
                                <option value="clorador_salino">Clorador Salino</option>
                                <option value="clorador_salino_ph">Clorador Salino + pH</option>
                                <option value="clorador_salino_ph_uv">Clorador Salino + pH + UV</option>
                                <option value="nao">Não Incluído</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Construção</label>
                            <select id="edit-construction">
                                <option value="nova">Construção Nova</option>
                                <option value="remodelacao">Remodelação</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cobertura</label>
                            <select id="edit-coverage">
                                <option value="nao">Sem Cobertura</option>
                                <option value="laminas">Cobertura de Lâminas</option>
                                <option value="bolhas">Cobertura de Bolhas</option>
                                <option value="barras">Cobertura de Barras</option>
                                <option value="lona">Cobertura de Lona</option>
                            </select>
                        </div>
                        <div class="form-group" id="edit-coverage-laminas-group" style="display:none;">
                            <label>Tipo de Cobertura de Lâminas</label>
                            <select id="edit-coverage-laminas">
                                <option value="">-- Selecionar --</option>
                                <option value="submersa_praia">Submersa na Praia</option>
                                <option value="fora_praia">Fora da Praia</option>
                                <option value="elevada">Elevada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Casa das Máquinas abaixo do nível da água?</label>
                            <select id="edit-machine-room">
                                <option value="nao">Não</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Observações sobre a casa das máquinas</label>
                            <textarea id="edit-machine-desc" rows="2" style="width:100%;padding:8px;border:2px solid #e5e7eb;border-radius:6px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Luzes</label>
                            <select id="edit-light-type">
                                <option value="branco_frio">Branco Frio</option>
                                <option value="branco_adaptavel">Branco Adaptável</option>
                                <option value="rgb">RGB</option>
                            </select>
                        </div>
                    </div>
                    <div class="edit-modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="saveQuestionnaireAnswers()" class="btn btn-primary">Salvar e Recalcular</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Função para salvar respostas do questionário e recalcular
        function saveQuestionnaireAnswers() {
            const poolType = document.getElementById('edit-pool-type').value;
            const shape = document.getElementById('edit-shape').value;
            const coating = document.getElementById('edit-coating').value;
            const access = document.getElementById('edit-access').value;
            const excavation = document.getElementById('edit-excavation').value;
            const location = document.getElementById('edit-location').value;
            const domotics = document.getElementById('edit-domotics').value;
            const power = document.getElementById('edit-power').value;
            // Novos campos
            const treatment = document.getElementById('edit-treatment') ? document.getElementById('edit-treatment').value : 'cloro_manual';
            const construction = document.getElementById('edit-construction') ? document.getElementById('edit-construction').value : 'nova';
            const coverage = document.getElementById('edit-coverage') ? document.getElementById('edit-coverage').value : 'nao';
            const coverage_laminas = document.getElementById('edit-coverage-laminas') ? document.getElementById('edit-coverage-laminas').value : '';
            const machine_room = document.getElementById('edit-machine-room') ? document.getElementById('edit-machine-room').value : 'nao';
            const machine_desc = document.getElementById('edit-machine-desc') ? document.getElementById('edit-machine-desc').value : '';
            const light_type = document.getElementById('edit-light-type') ? document.getElementById('edit-light-type').value : 'branco_frio';
            
            // Coletar também as medidas atuais da piscina
            const dimensionsEl = document.querySelector('.pool-dimensions, .value-dimensions');
            const depthEl = document.querySelector('.pool-depth, .value-depth');
            
            const dimensionsText = dimensionsEl ? dimensionsEl.textContent : '0×0m';
            const depthText = depthEl ? depthEl.textContent : '0-0m';
            
            const comprimento = dimensionsText.split('×')[0]?.replace('m', '').trim() || '0';
            const largura = dimensionsText.split('×')[1]?.replace('m', '').trim() || '0';
            const profMin = depthText.split('-')[0]?.replace('m', '').trim() || '0';
            const profMax = depthText.split('-')[1]?.replace('m', '').trim() || '0';
            
            // Preparar dados para enviar ao backend
            const updateData = {
                // Medidas da piscina
                comprimento: parseFloat(comprimento),
                largura: parseFloat(largura),
                prof_min: parseFloat(profMin),
                prof_max: parseFloat(profMax),
                // Respostas do questionário
                answers: {
                    tipo_piscina: poolType,
                    forma: shape,
                    revestimento: coating,
                    acesso: access,
                    escavacao: excavation,
                    localizacao: location,
                    domotica: domotics,
                    luz: power,
                    tratamento_agua: treatment,
                    tipo_construcao: construction,
                    cobertura: coverage,
                    tipo_cobertura_laminas: coverage_laminas,
                    casa_maquinas_abaixo: machine_room,
                    casa_maquinas_desc: machine_desc,
                    tipo_luzes: light_type
                }
            };
            
            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Recalculando orçamento...`;
            document.body.appendChild(loadingDiv);
            
            // Enviar para o backend para recalcular
            fetch('/recalculate_budget', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.remove();
                if (data.success) {
                    // Recarregar a página para mostrar os novos cálculos
                    closeModal();
                    showSuccessMessage('Orçamento recalculado com sucesso!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showErrorMessage('Erro ao recalcular: ' + data.error);
                }
            })
            .catch(error => {
                loadingDiv.remove();
                console.error('Erro ao recalcular:', error);
                showErrorMessage('Erro de comunicação com o servidor');
            });
        }

        // Função para mostrar mensagem de erro
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Função para fechar modal
        function closeModal() {
            const modal = document.querySelector('.edit-modal-overlay');
            if (modal) modal.remove();
        }

        // Função para mostrar mensagem de sucesso
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                z-index: 1002;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
            `;
            successDiv.innerHTML = `<i class="fas fa-check"></i> ${message}`;
            document.body.appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Função para atualizar nome do produto
        function updateProductName(productId, newName) {
            if (!newName || newName.trim() === '') {
                // Restaurar nome original se estiver vazio
                const nameElement = document.querySelector(`[data-product-id="${productId}"].editable-name`);
                if (nameElement) {
                    nameElement.textContent = nameElement.dataset.originalName;
                }
                return;
            }

            fetch('/update_product_name', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    name: newName.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Nome atualizado com sucesso');
                } else {
                    // Restaurar nome original em caso de erro
                    const nameElement = document.querySelector(`[data-product-id="${productId}"].editable-name`);
                    if (nameElement) {
                        nameElement.textContent = nameElement.dataset.originalName;
                    }
                    showErrorMessage(data.error || 'Erro ao atualizar nome');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                // Restaurar nome original em caso de erro
                const nameElement = document.querySelector(`[data-product-id="${productId}"].editable-name`);
                if (nameElement) {
                    nameElement.textContent = nameElement.dataset.originalName;
                }
                showErrorMessage('Erro ao atualizar nome');
            });
        }

        // Função para atualizar preço do produto
        function updateProductPrice(productId, newPriceText) {
            // Permitir vírgula como separador decimal
            const cleanPrice = newPriceText.replace(',', '.');
            const newPrice = parseFloat(cleanPrice);
            
            if (isNaN(newPrice) || newPrice < 0) {
                // Restaurar preço original se inválido
                const priceElement = document.querySelector(`[data-product-id="${productId}"].editable-price`);
                if (priceElement) {
                    priceElement.textContent = parseFloat(priceElement.dataset.originalPrice).toFixed(2);
                }
                showErrorMessage('Preço inválido. Use apenas números (vírgula ou ponto para decimais)');
                return;
            }

            fetch('/update_product_price', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    price: newPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Preço atualizado com sucesso');
                    // Atualizar o display do preço
                    const priceElement = document.querySelector(`[data-product-id="${productId}"].editable-price`);
                    if (priceElement) {
                        priceElement.textContent = newPrice.toFixed(2);
                        priceElement.dataset.originalPrice = newPrice;
                    }
                    // Recarregar para atualizar totais
                    setTimeout(() => location.reload(), 1000);
                } else {
                    // Restaurar preço original em caso de erro
                    const priceElement = document.querySelector(`[data-product-id="${productId}"].editable-price`);
                    if (priceElement) {
                        priceElement.textContent = parseFloat(priceElement.dataset.originalPrice).toFixed(2);
                    }
                    showErrorMessage(data.error || 'Erro ao atualizar preço');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                // Restaurar preço original em caso de erro
                const priceElement = document.querySelector(`[data-product-id="${productId}"].editable-price`);
                if (priceElement) {
                    priceElement.textContent = parseFloat(priceElement.dataset.originalPrice).toFixed(2);
                }
                showErrorMessage('Erro ao atualizar preço');
            });
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
                color: #dc2626;
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #fecaca;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
            `;
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 4000);
        }

        // Função para controlar a expansão dos detalhes de transporte
        function toggleTransportDetails() {
            const content = document.getElementById('transport-explanation-content');
            const icon = document.getElementById('transport-toggle-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
    </script>
</body>
</html>
